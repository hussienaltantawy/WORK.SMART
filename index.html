<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORK SMART</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment-hijri@2.1.2/moment-hijri.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// ===== Date Converter Enhancements =====
let dateDebounceTimer = null;

function autoConvertDate() {
    clearTimeout(dateDebounceTimer);
    dateDebounceTimer = setTimeout(() => {
        convertDateSmart();
    }, 400);
}

function convertDateSmart() {
    const inputEl = document.getElementById('dateInput');
    const errorEl = document.getElementById('dateError');
    if (!inputEl) return;

    const value = inputEl.value.trim();
    if (!value) {
        if (errorEl) errorEl.textContent = '';
        return;
    }

    let year, month, day;

    // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
        [year, month, day] = value.split('-').map(Number);
    }
    // DD/MM/YYYY
    else if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
        [day, month, year] = value.split('/').map(Number);
    } else {
        showDateError('Invalid format. Use DD/MM/YYYY or YYYY-MM-DD');
        return;
    }

    const date = new Date(year, month - 1, day);

    if (
        date.getFullYear() !== year ||
        date.getMonth() !== month - 1 ||
        date.getDate() !== day
    ) {
        showDateError('Invalid date');
        return;
    }

    clearDateError();
    convertDate(date);
}

function showDateError(msg) {
    let errorEl = document.getElementById('dateError');
    if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = 'dateError';
        errorEl.style.color = '#e74c3c';
        errorEl.style.marginTop = '6px';
        document.getElementById('dateInput').after(errorEl);
    }
    errorEl.textContent = msg;
}

function clearDateError() {
    const errorEl = document.getElementById('dateError');
    if (errorEl) errorEl.textContent = '';
}
// ===== END Date Converter Enhancements =====
</script>

<script>
/* ═══════════════════════════════════════════════════════════
   TABLE → CANVAS IMAGE EXPORT
   Draws any <table> directly onto a canvas — no html2canvas
   needed, no CORS issues, no CSS variable failures.
   ═══════════════════════════════════════════════════════════ */
function tableToCanvas(tableId, title, filename, logoData) {
    const table = document.getElementById(tableId);
    if (!table) { showToast('Table not found!'); return; }

    const scale = 2;
    const padX = 40, rowH = 44, headH = 50, titleH = 56;
    const logoAreaH = logoData ? 80 : 0;  // bottom-left logo strip height
    const bottomPad = 20;                  // tight padding below table
    const headerColor = '#1e3a8a';
    const headerText  = '#ffffff';
    const rowEven     = '#f1f5f9';
    const rowOdd      = '#ffffff';
    const borderColor = '#cbd5e1';
    const textColor   = '#1e293b';
    const font        = 'bold 15px Poppins, Arial, sans-serif';
    const cellFont    = '14px Poppins, Arial, sans-serif';

    // Collect headers
    const ths = Array.from(table.querySelectorAll('thead th'));
    const headers = ths.map(th => th.textContent.trim());

    // Collect rows
    const trs = Array.from(table.querySelectorAll('tbody tr'));
    const rows = trs.map(tr =>
        Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim())
    );

    if (rows.length === 0) { showToast('No data to export!'); return; }

    // Measure column widths
    const measure = document.createElement('canvas').getContext('2d');
    measure.font = font;
    const colWidths = headers.map((h, i) => {
        let max = measure.measureText(h).width + 30;
        rows.forEach(r => {
            measure.font = cellFont;
            const w = measure.measureText(r[i] || '').width + 30;
            if (w > max) max = w;
            measure.font = font;
        });
        return Math.max(max, 80);
    });

    const tableW = colWidths.reduce((a, b) => a + b, 0);
    const canvasW = tableW + padX * 2;
    const canvasH = titleH + 8 + headH + rows.length * rowH + bottomPad + logoAreaH;

    const canvas = document.createElement('canvas');
    canvas.width  = canvasW * scale;
    canvas.height = canvasH * scale;
    const ctx = canvas.getContext('2d');
    ctx.scale(scale, scale);

    // White background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvasW, canvasH);

    // Title bar
    ctx.fillStyle = headerColor;
    ctx.fillRect(0, 0, canvasW, titleH);
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 22px Poppins, Arial, sans-serif';
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'center';
    ctx.fillText(title, canvasW / 2, titleH / 2);

    // Header row
    let xOff = padX;
    const headerY = titleH + 8;
    ctx.fillStyle = headerColor;
    ctx.fillRect(padX, headerY, tableW, headH);
    ctx.fillStyle = headerText;
    ctx.font = font;
    ctx.textAlign = 'left';
    headers.forEach((h, i) => {
        ctx.fillText(h, xOff + 12, headerY + headH / 2);
        xOff += colWidths[i];
    });

    // Data rows
    rows.forEach((row, ri) => {
        const y = headerY + headH + ri * rowH;
        ctx.fillStyle = ri % 2 === 0 ? rowOdd : rowEven;
        ctx.fillRect(padX, y, tableW, rowH);

        // Row border
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(padX, y + rowH);
        ctx.lineTo(padX + tableW, y + rowH);
        ctx.stroke();

        xOff = padX;
        ctx.fillStyle = textColor;
        ctx.font = cellFont;
        ctx.textBaseline = 'middle';
        row.forEach((cell, ci) => {
            ctx.fillText(cell, xOff + 12, y + rowH / 2);
            xOff += colWidths[ci];
        });
    });

    // Outer border
    ctx.strokeStyle = borderColor;
    ctx.lineWidth = 1;
    ctx.strokeRect(padX, headerY, tableW, headH + rows.length * rowH);

    // Column dividers
    xOff = padX;
    colWidths.slice(0, -1).forEach(w => {
        xOff += w;
        ctx.beginPath();
        ctx.moveTo(xOff, headerY);
        ctx.lineTo(xOff, headerY + headH + rows.length * rowH);
        ctx.stroke();
    });

    // Watermark — reset the scale transform so addCanvasWatermark
    // works in physical pixels (canvas.width/height) as it expects
    ctx.setTransform(1, 0, 0, 1, 0, 0);

    // Bottom-left logo / company name
    if (logoData) {
        const bottomY = (canvasH - logoAreaH) * scale;
        const logoX = padX * scale;
        const logoW = (tableW * scale) / 2;  // max half the table width
        const logoH = logoAreaH * scale - 16;

        if (logoData.type === 'image') {
            const img = new Image();
            img.onload = function() {
                // Draw the logo image
                const aspect = img.width / img.height;
                let dw = logoW, dh = dw / aspect;
                if (dh > logoH) { dh = logoH; dw = dh * aspect; }
                ctx.drawImage(img, logoX, bottomY + 8, dw, dh);
                // Then watermark + download
                addCanvasWatermark(canvas);
                downloadCanvas(canvas, filename);
            };
            img.src = logoData.src;
            return; // wait for image load
        } else if (logoData.type === 'text') {
            const fs = Math.round(24 * scale);
            ctx.font = `bold ${fs}px Poppins, Arial, sans-serif`;
            ctx.fillStyle = headerColor;
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'left';
            ctx.fillText(logoData.text, logoX, bottomY + logoAreaH * scale / 2);
        }
    }

    addCanvasWatermark(canvas);
    downloadCanvas(canvas, filename);
}

function downloadCanvas(canvas, filename) {
    try {
        const dataURL = canvas.toDataURL('image/png');
        if (!dataURL || dataURL === 'data:,') {
            showToast('Image export failed — canvas empty!');
            return;
        }
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showToast('Saved as image! ✅');
    } catch(e) {
        showToast('Image export error: ' + e.message);
    }
}
</script>

<script>
/* ═══════════════════════════════════════════════════════════
   WATERMARK HELPERS — "WORK SMART BY ALTANTAWY"
   Used by every save / export function across all tools
   ═══════════════════════════════════════════════════════════ */
const WS_BRAND = 'WORK SMART BY ALTANTAWY';

/* Add branded watermark text to a canvas (bottom-right, white bg strip) */
function addCanvasWatermark(canvas) {
  const ctx = canvas.getContext('2d');
  const text = WS_BRAND;
  // canvas.width is physical pixels — use a fixed readable size
  const fontSize = Math.max(20, Math.min(32, Math.round(canvas.width * 0.022)));
  ctx.font = `bold ${fontSize}px Poppins, Arial, sans-serif`;
  const textW = ctx.measureText(text).width;
  const padX = 14, padY = 8;
  const pillW = textW + padX * 2;
  const stripH = fontSize + padY * 2;
  // Clamp x so the pill never goes off the left edge
  const x = Math.max(8, canvas.width - pillW - 8);
  const y = canvas.height - stripH - 8;

  // Pill background
  ctx.save();
  ctx.globalAlpha = 0.92;
  ctx.fillStyle = '#1e3a8a';
  const r = Math.min(stripH / 2, 10);
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + pillW - r, y);
  ctx.quadraticCurveTo(x + pillW, y, x + pillW, y + r);
  ctx.lineTo(x + pillW, y + stripH - r);
  ctx.quadraticCurveTo(x + pillW, y + stripH, x + pillW - r, y + stripH);
  ctx.lineTo(x + r, y + stripH);
  ctx.quadraticCurveTo(x, y + stripH, x, y + stripH - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  ctx.fill();
  ctx.globalAlpha = 1;

  // Text
  ctx.fillStyle = '#ffffff';
  ctx.font = `bold ${fontSize}px Poppins, Arial, sans-serif`;
  ctx.textBaseline = 'middle';
  ctx.fillText(text, x + padX, y + stripH / 2);
  ctx.restore();
  return canvas;
}

/* Add watermark row to every sheet in an XLSX workbook */
function addXlsxWatermark(wb) {
  if (!wb || !wb.SheetNames) return wb;
  wb.SheetNames.forEach(name => {
    const ws = wb.Sheets[name];
    if (!ws) return;
    // Find last used row
    const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
    const lastRow = range.e.r + 1; // 0-indexed → next row
    const cell = XLSX.utils.encode_cell({ r: lastRow + 1, c: range.e.c }); // one blank row gap
    ws[cell] = { t: 's', v: WS_BRAND };
    // Extend sheet range
    ws['!ref'] = XLSX.utils.encode_range({ s: range.s, e: { r: lastRow + 2, c: range.e.c } });
  });
  return wb;
}

/* Append watermark line to a text string */
function addTextWatermark(text) {
  return text + '\n\n─────────────────────────────\n' + WS_BRAND + '\n';
}

document.addEventListener('DOMContentLoaded', function() {
    // Add smooth scroll behavior
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                const targetPosition = targetElement.offsetTop - 20;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // Initialize Email Forms
    if (typeof initEmailForms === 'function') {
        initEmailForms();
    }
});
</script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Poppins:wght@400;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1e3a8a;
            --secondary: #1e40af;
            --accent: #3b82f6;
            --dark: #0f172a;
            --light: #f8fafc;
            --success: #10b981;
            --error: #ef4444;
            --weekend: #dc2626;
            --border: #e2e8f0;
        }
        
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Poppins', sans-serif;
            background: url('bg4.jpg') center center / cover no-repeat fixed;
            min-height: 100vh;
            padding: 10px 15px;
        }
        
        .container {
            max-width: 1250px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Make all tool boxes same width */
        .tool-box {
            width: 100%;
            max-width: 1150px;
            margin-left: auto;
            margin-right: auto;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 20px;
            background: transparent;
            border-radius: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: none;
        }
        
        header::before {
            display: none;
        }
        
        @keyframes moveBackground {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        header::after {
            display: none;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        /* Navigation Menu */
        .nav-menu {
            background: white;
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        
.nav-links {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: center;
}

.nav-menu {
    width: 100%;
    max-width: 1150px;
    margin: 0 auto 30px auto;
    text-align: center;
}

.nav-links {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .nav-link {
            padding: 10px 18px;
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border: none;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
        }
        
        .nav-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(30, 58, 138, 0.5);
            background: linear-gradient(135deg, #2563eb, #3b82f6);
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        h1 {
            font-size: 3rem;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            letter-spacing: 8px;
            text-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(255, 255, 255, 0.3);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), 0 0 40px rgba(255, 255, 255, 0.3); }
            50% { text-shadow: 0 4px 30px rgba(0, 0, 0, 0.5), 0 0 60px rgba(255, 255, 255, 0.5); }
        }
        
        .signature {
            font-family: 'Brush Script MT', 'Segoe Script', cursive;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            margin-top: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* Tool Box */
        .tool-box {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            
        }
        
        /* Tool boxes in grids should also be uniform */
        .tools-grid > .tool-box,
        .task-notes-grid > .tool-box {
            display: flex;
            flex-direction: column;
        }
        
        .tools-grid > .tool-box .business-result {
            margin-top: auto;
        }
        
        /* Side by Side Layout */
        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1150px;
            margin-left: auto;
            margin-right: auto;
            align-items: stretch;
        }
        
        .task-notes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1150px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Navigation menu centering */
        .nav-menu {
            width: 100%;
            max-width: 1150px;
            margin-left: auto;
            margin-right: auto;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Header centering */
        header {
            width: 100%;
            max-width: 1150px;
            margin-left: auto;
            margin-right: auto;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (max-width: 968px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .task-notes-grid {
                grid-template-columns: 1fr;
            }
            
            /* Stack Housing Ratio inputs on mobile */
            .housing-ratio-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        .tool-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Poppins', 'Cairo', sans-serif;
        }
        
        /* Name Translator */
        .translator-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: start;
            margin-bottom: 20px;
        }
        
        .input-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 18px;
            border: 1px solid var(--border);
        }
        
        .section-label {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        textarea {
            width: 100%;
            min-height: 80px;
            max-height: 400px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.95rem;
            font-family: 'Cairo', 'Poppins', sans-serif;
            resize: vertical;
            outline: none;
        }
        
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .arabic-input {
            direction: rtl;
            text-align: right;
            font-family: 'Cairo', sans-serif;
        }
        
        .english-output {
            direction: ltr;
            text-align: left;
            background: #f1f5f9;
            color: var(--dark);
            font-weight: 600;
        }
        
        .swap-btn {
            align-self: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.3rem;
            transition: all 0.3s ease;
        }
        
        .swap-btn:hover {
            transform: rotate(180deg) scale(1.1);
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

/* OCR Mode Buttons - Professional Styling */
.ocr-mode-btn {
    padding: 8px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s ease;
}

.ocr-mode-btn:hover {
    background: #f8fafc;
    border-color: var(--primary);
}

.ocr-mode-active {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border-color: var(--primary);
}

        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        /* Date Converter */
        .date-converter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .date-converter-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .date-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid var(--border);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Poppins', 'Cairo', sans-serif;
            outline: none;
            transition: border-color 0.3s;
        }
        
        input:focus,
        select:focus {
            border-color: var(--accent);
        }
        
        .hijri-inputs {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 10px;
        }
        
        .result-box {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border-radius: 15px;
            padding: 10px 15px;
            margin-top: 20px;
            border: 2px solid var(--border);
            display: none;
        }
        
        .result-box.weekend {
            background: linear-gradient(135deg, var(--weekend), #b91c1c);
            color: white;
        }
        
        .result-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .result-box.weekend .result-label {
            color: white;
        }
        
        .result-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .result-box.weekend .result-value {
            color: white;
        }
        
        .result-box .result-value {
            direction: rtl;
            text-align: right;
        }
        
        .weekend-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-left: 10px;
        }
        
        /* Calculator Styles */
        .calc-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .housing-ratio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            align-items: start;
        }
        
        .housing-ratio-grid .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .housing-ratio-grid .input-group h4 {
            min-height: 42px;
            display: flex;
            align-items: center;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .calc-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Updated Result Item with Inline Copy Button */
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .result-item:last-child {
            margin-bottom: 0;
        }
        
        .result-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
        }
        
        .result-value-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .copy-value-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .copy-value-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* Description Box */
        .description-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 15px;
            padding: 10px 15px;
            margin-top: 20px;
            border: 2px solid #fbbf24;
            direction: rtl;
            text-align: right;
        }
        
        .description-box h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-family: 'Cairo', sans-serif;
        }
        
        .description-box p {
            color: #78350f;
            line-height: 1.6;
            font-family: 'Cairo', sans-serif;
        }
        
        /* Flat Rate Calculator */
        .flat-rate-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 968px) {
            .flat-rate-container {
                grid-template-columns: 1fr;
            }
        }
        
        .flat-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid var(--border);
        }
        
        .flat-section h4 {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .flat-input-grid {
            display: grid;
            grid-template-columns: 80px 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .flat-result {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 15px;
            padding: 10px 15px;
            margin-top: 20px;
            text-align: center;
            position: relative;
        }
        
        .flat-result-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
        }
        
        .flat-result-value {
            font-size: 2rem;
            font-weight: 900;
            color: white;
        }
        
        .copy-result-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 10px;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .copy-result-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        /* Day Items */
        .day-item {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .day-select,
        .day-price {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
        }
        
        .remove-day-btn {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .remove-day-btn:hover {
            transform: scale(1.1);
        }
        
        /* Nights Calculator */
        .nights-result {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            text-align: center;
        }
        
        .nights-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .nights-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            font-family: 'Cairo', 'Poppins', sans-serif;
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
        }
        
        .nights-value {
            font-size: 2rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: block;
            margin-top: 8px;
        }
        
        .nights-breakdown {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .nights-breakdown.weekend {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border: 2px solid #991b1b;
        }
        
        .breakdown-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
        }
        
        .breakdown-value {
            display: block;
            font-size: 2rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        input[type="date"] {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            outline: none;
            width: 100%;
            cursor: pointer;
        }
        
        input[type="date"]:focus {
            border-color: var(--accent);
        }
        
        /* Business Calculator */
        .business-result {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            text-align: center;
            transition: background 0.3s ease;
        }
        .business-result.loss {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .business-display {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        
        .business-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            font-family: 'Cairo', 'Poppins', sans-serif;
        }
        
        .business-value {
            font-size: 3rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .business-value.negative {
            color: #fecaca;
        }
        
        .business-value.positive {
            color: white;
        }
        
        /* Rooming List */
        .rooming-header,
        .rooming-row {
            display: grid;
            grid-template-columns: 1.8fr 0.8fr 1.1fr 1.1fr 1.1fr 50px;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .rooming-header {
            font-weight: 700;
            color: var(--primary);
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .rooming-row input,
        .rooming-row select {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
        }
        
        .guest-name {
            font-family: 'Cairo', 'Poppins', sans-serif;
        }
        
        .rooming-preview,
        .extensions-preview {
            display: none;
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid var(--border);
        }

        /* Room Layout Styles */
        .room-layout-section {
            margin: 18px 0 0 0;
            padding: 16px;
            background: #f8faff;
            border-radius: 12px;
            border: 1.5px solid #e0e7ff;
        }
        .room-layout-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .room-layout-boxes {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            cursor: default;
        }
        .room-type-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            border: 2px solid #c7d2fe;
            background: #fff;
            cursor: grab;
            user-select: none;
            transition: all 0.2s ease;
            position: relative;
            min-width: 100px;
        }
        .room-type-box:active { cursor: grabbing; }
        .room-type-box.checked {
            border-color: var(--primary);
            background: #eef2ff;
        }
        .room-type-box.drag-over {
            border-color: #f59e0b;
            background: #fffbeb;
            transform: scale(1.04);
        }
        .room-type-box.dragging {
            opacity: 0.4;
        }
        .room-type-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }
        .room-type-label {
            font-weight: 700;
            font-size: 0.9rem;
            color: #334155;
        }
        .room-type-pax {
            font-size: 0.75rem;
            color: #64748b;
        }
        /* Add Room Type Button & Modal */
        .add-room-type-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 2px dashed #6366f1;
            background: transparent;
            color: #6366f1;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
            white-space: nowrap;
        }
        .add-room-type-btn:hover {
            background: #eef2ff;
            border-style: solid;
            transform: scale(1.04);
        }
        .room-type-box.custom-type {
            border-color: #a78bfa;
            background: #f5f3ff;
        }
        .room-type-box.custom-type .room-type-label { color: #5b21b6; }
        .room-type-box.custom-type.checked { background: #ede9fe; border-color: #7c3aed; }
        .remove-room-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ef4444;
            color: #fff;
            font-size: 0.65rem;
            font-weight: 900;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            z-index: 10;
            transition: transform 0.15s;
        }
        .remove-room-btn:hover { transform: scale(1.2); }

        /* Add Room Type Modal */
        #addRoomTypeModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        #addRoomTypeModal.open { display: flex; }
        .add-room-modal-box {
            background: #fff;
            border-radius: 18px;
            padding: 28px 24px 20px;
            width: 340px;
            max-width: 95vw;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            position: relative;
            animation: modalPop 0.2s ease;
        }
        @keyframes modalPop {
            from { transform: scale(0.85); opacity: 0; }
            to   { transform: scale(1);    opacity: 1; }
        }
        .add-room-modal-title {
            font-size: 1.05rem;
            font-weight: 800;
            color: #1e3a8a;
            margin-bottom: 18px;
            text-align: center;
        }
        .add-room-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 18px;
        }
        .preset-chip {
            padding: 7px 14px;
            border-radius: 20px;
            border: 2px solid #c7d2fe;
            background: #f8faff;
            color: #1e3a8a;
            font-size: 0.82rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }
        .preset-chip:hover { background: #e0e7ff; border-color: #6366f1; color: #4f46e5; }
        .preset-chip.selected { background: #6366f1; border-color: #6366f1; color: #fff; }
        .add-room-custom-row {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            align-items: center;
        }
        .add-room-custom-row input {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #c7d2fe;
            font-size: 0.9rem;
            font-weight: 700;
            color: #1e3a8a;
            outline: none;
        }
        .add-room-custom-row input:focus { border-color: #6366f1; }
        .add-room-modal-actions {
            display: flex;
            gap: 10px;
        }
        .modal-btn-add {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg,#6366f1,#4f46e5);
            color: #fff;
            font-weight: 800;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        .modal-btn-add:hover { opacity: 0.88; }
        .modal-btn-cancel {
            padding: 10px 18px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            background: #fff;
            color: #64748b;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .modal-btn-cancel:hover { background: #f1f5f9; }

        .priority-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .layout-result-section {
            margin-top: 14px;
            padding: 14px;
            background: #1e3a8a;
            border-radius: 10px;
            color: #fff;
            display: none;
        }
        .layout-result-title {
            font-size: 0.82rem;
            font-weight: 700;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .layout-result-rows {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .layout-result-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.12);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .layout-result-type {
            font-weight: 700;
            font-size: 1rem;
            min-width: 60px;
        }
        .layout-result-count {
            font-size: 1.2rem;
            font-weight: 800;
        }
        .layout-result-pax {
            opacity: 0.8;
            font-size: 0.82rem;
        }
        .layout-result-row input[type=number]::-webkit-outer-spin-button,
        .layout-result-row input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .layout-result-row input[type=number] {
            -moz-appearance: textfield;
        }
        .layout-drag-hint {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }


        /* Logo / branding strip */
        .logo-strip {
            margin-top: 16px;
            background: #f1f5f9;
            border: 1px dashed #94a3b8;
            border-radius: 12px;
            padding: 14px 18px;
        }
        .logo-strip-label {
            font-size: 0.82rem;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .logo-strip-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .logo-text-input {
            flex: 1;
            min-width: 160px;
            padding: 9px 14px;
            border: 1.5px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Poppins', sans-serif;
            outline: none;
            background: white;
        }
        .logo-text-input:focus { border-color: var(--primary); }
        .logo-or {
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .logo-upload-btn {
            padding: 9px 16px;
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            border-radius: 8px;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: opacity 0.2s;
        }
        .logo-upload-btn:hover { opacity: 0.88; }
        .logo-clear-btn {
            padding: 9px 14px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .logo-clear-btn:hover { opacity: 0.8; }
        .logo-preview-thumb {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-preview-thumb img {
            max-height: 52px;
            max-width: 200px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            object-fit: contain;
        }
        
        .rooming-table,
        .extensions-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .rooming-table th,
        .rooming-table td,
        .extensions-table th,
        .extensions-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .rooming-table th,
        .extensions-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .rooming-table tr:last-child td,
        .extensions-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Extensions Maker */
        .extensions-header,
        .extensions-row {
            display: grid;
            grid-template-columns: 1.8fr 1.1fr 1.1fr 1.1fr 1.1fr 50px;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .extensions-header {
            font-weight: 700;
            color: var(--primary);
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .extensions-row input {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
        }
        
        /* Task Manager */
        .task-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .task-input {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
        }
        
        .task-input:focus {
            border-color: var(--accent);
        }
        
        .add-task-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }
        
        .task-list {
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }
        
        .task-item:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .task-item.completed {
            background: #f0fdf4;
            border-color: var(--success);
        }
        
        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #6b7280;
        }
        
        .task-text {
            flex: 1;
            font-size: 1rem;
            color: var(--dark);
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
        }
        
        .task-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .task-btn.complete {
            background: linear-gradient(135deg, var(--success), #059669);
        }
        
        .task-btn.delete {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }
        
        .task-btn:hover {
            transform: scale(1.1);
        }
        
        /* Notes */
        .notes-area {
            width: 100%;
            min-height: 200px;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 15px;
            font-size: 1rem;
            font-family: 'Poppins', 'Cairo', sans-serif;
            resize: vertical;
            outline: none;
            margin-bottom: 15px;
        }
        
        .notes-area:focus {
            border-color: var(--accent);
        }
        
        .notes-count {
            text-align: right;
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 10px 15px;
            margin-top: 40px;
            color: white;
        }
        
        .footer-content {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .footer-contact {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .footer-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            /* Reduce body padding on mobile */
            body {
                padding: 5px 10px;
            }
            
            /* Header adjustments */
            header {
                padding: 20px 15px;
            }
            
            h1 {
                font-size: 1.6rem;
                letter-spacing: 2px;
            }
            
            /* Tool boxes - better mobile spacing */
            .tool-box {
                padding: 20px 15px;
                margin-bottom: 15px;
            }
            
            .tool-title {
                font-size: 1.1rem;
                padding: 12px 15px;
            }
            
            /* Input fields - larger for touch */
            input[type="text"],
            input[type="number"],
            input[type="date"],
            input[type="email"],
            textarea,
            select {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 14px !important;
                min-height: 48px; /* Touch-friendly */
            }
            
            /* Buttons - larger and stack better */
            .btn {
                padding: 14px 20px;
                font-size: 0.95rem;
                min-height: 48px; /* Touch-friendly */
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
                gap: 12px;
                width: 100%;
            }
            
            /* Grid layouts to single column */
            .translator-grid,
            .date-converter-grid,
            .flat-rate-container,
            .calc-row,
            .calc-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .rooming-header,
            .rooming-row,
            .extensions-header,
            .extensions-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            /* Hide header labels on mobile for rooming/extensions */
            .rooming-header,
            .extensions-header {
                display: none;
            }
            
            /* Add labels to inputs on mobile */
            .rooming-row input::placeholder,
            .extensions-row input::placeholder {
                font-weight: 600;
            }
            
            /* Remove buttons - bigger touch target */
            .remove-day-btn {
                width: 100%;
                margin-top: 8px;
                padding: 12px;
                font-size: 1rem;
            }
            
            /* Swap button in translator */
            .swap-btn {
                width: 100%;
                height: 48px;
                border-radius: 12px;
                margin: 10px 0;
            }
            
            /* Task notes grid */
            .task-notes-grid {
                grid-template-columns: 1fr;
            }
            
            /* Result boxes */
            .result-box {
                padding: 15px;
            }
            
            .result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .result-label {
                font-size: 0.85rem;
            }
            
            .result-value {
                font-size: 1.3rem;
            }
            
            /* Copy buttons */
            .copy-value-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }
            
            /* Business Calculator responsive */
            .tool-box > div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            .tool-box > div > div[style*="border-right"] {
                border-right: none !important;
                border-bottom: 2px solid var(--border) !important;
                padding-right: 0 !important;
                padding-bottom: 20px !important;
                margin-bottom: 20px;
            }
            
            .tool-box > div > div[style*="padding-left"] {
                padding-left: 0 !important;
            }
            
            /* Tables */
            .rooming-table,
            .extensions-table {
                font-size: 0.85rem;
            }
            
            .rooming-table th,
            .rooming-table td,
            .extensions-table th,
            .extensions-table td {
                padding: 10px 8px;
            }
        }
        
        .editable-select-wrapper {
            position: relative;
            width: 100%;
        }
        
        .editable-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Poppins', 'Cairo', sans-serif;
            outline: none;
            list-style: none;
            cursor: pointer;
        }
        
        .editable-select option {
            padding: 10px;
        }
    
/* Email Forms - Modern Design */
.email-form {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 16px;
    margin-bottom: 20px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.email-form:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

.form-header {
    padding: 18px 24px;
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    color: white;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    text-align: center;
}

.form-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.form-header:hover::before {
    left: 100%;
}

.form-header:hover {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
}

.form-header span:first-child {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex: 1;
}

.form-header span:last-child {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
    display: inline-block;
}

.form-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-content.open {
    max-height: 600px;
}

.form-content.open + .form-header span:last-child {
    transform: rotate(180deg);
}

.form-html { scroll-behavior: smooth; }

        body {
    padding: 10px 15px;
}

.form-body {
    padding: 24px;
    background: white;
}

.form-field {
    margin-bottom: 20px;
}

.form-field label {
    display: block;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 10px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-field .value {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    padding: 16px;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #1a202c;
    transition: all 0.3s ease;
}

.form-field .value:hover {
    border-color: #cbd5e0;
    background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
}

.btn.btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    border: none;
    padding: 12px 28px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    font-size: 1rem;
}

.btn.btn-success:hover {
    background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
}

.btn.btn-success:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
}

#emailFormsContainer {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    flex: 1;
}

@media (max-width: 1024px) {
    #emailFormsContainer {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
}

@media (max-width: 600px) {
    #emailFormsContainer {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .form-header {
        padding: 16px 20px;
        font-size: 0.95rem;
    }
    
    .form-body {
        padding: 20px;
    }
    
    /* Extra small mobile improvements */
    h1 {
        font-size: 1.4rem;
    }
    
    .nav-link {
        padding: 8px 12px;
        font-size: 0.75rem;
    }
    
    .tool-title {
        font-size: 1rem;
        padding: 10px 12px;
    }
    
    .btn {
        font-size: 0.9rem;
        padding: 12px 16px;
    }
}

/* Very small phones */
@media (max-width: 400px) {
    body {
        padding: 5px;
    }
    
    .container {
        padding: 0;
    }
    
    .tool-box {
        padding: 15px 10px;
    }
    
    h1 {
        font-size: 1.2rem;
        letter-spacing: 1px;
    }
    
    .tool-title {
        font-size: 0.95rem;
        padding: 10px;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea {
        padding: 12px !important;
    }
    
    .btn {
        padding: 12px;
        font-size: 0.85rem;
    }
    
    .nav-link {
        padding: 6px 8px;
        font-size: 0.7rem;
    }
}

</style>

<style>
/* HIDE OCR ENGINE BUTTONS */
.ocr-engine-btn,
#modeBtn_standard,
#modeBtn_passport,
#modeBtn_rooming {
  display: none !important;
}
</style>

<script>
function scoreWordConfidence(word) {
  let score = 100;
  if (word.length <= 1) score -= 40;
  if (/[Il|]{2,}/.test(word)) score -= 30;
  if (/[A-Z]{1}[0-9]/.test(word)) score -= 25;
  if (/[^A-Za-z0-9ء-ي]/.test(word)) score -= 20;
  return score;
}

const smartDictionary = {
  "MOHAMEO":"MOHAMED","MOHAMMD":"MOHAMMED","HUSSIEN":"HUSSEIN",
  "PASSP0RT":"PASSPORT","BIRTHOATE":"BIRTHDATE","NATlONALlTY":"NATIONALITY",
  "RO0M":"ROOM","TOTAI":"TOTAL","VAl":"VAT"
};

function aiWordCorrector(word){
  const w = word.toUpperCase();
  if (smartDictionary[w]) return smartDictionary[w];
  return w.replace(/0/g,"O").replace(/1/g,"I").replace(/5/g,"S").replace(/8/g,"B");
}

function aiReconstructLine(line){
  return line.split(" ").map(w=>{
    return scoreWordConfidence(w)<70 ? aiWordCorrector(w) : w;
  }).join(" ");
}

function aiArabicCorrection(text){
  const fixes = {
    "الاسـم":"الاسم","الجنسيـة":"الجنسية","تاريـخ":"تاريخ",
    "رقـم":"رقم","جـواز":"جواز","السفـر":"السفر"
  };
  Object.keys(fixes).forEach(k=>{
    text = text.replace(new RegExp(k,"g"),fixes[k]);
  });
  return text;
}

function aiAutoCorrect(text){
  let lines = text.split("\n").map(l=>aiReconstructLine(l));
  let out = lines.join("\n");
  out = aiArabicCorrection(out);
  if (typeof cleanOCRText === "function") out = cleanOCRText(out);
  if (typeof highlightLowConfidence === "function") out = highlightLowConfidence(out);
  return out;
}

// Force default OCR engine + mode
document.addEventListener("DOMContentLoaded",()=>{
  if (typeof setOCREngine === "function") setOCREngine("local");
  if (typeof setOCRMode === "function") setOCRMode("standard");
});
</script>


<style>
.app-title {
  white-space: nowrap !important;
  display: flex;
  align-items: center;
  gap: 8px;
}
@media (max-width: 480px) {
  .app-title { font-size: 0.95rem; }
}

/* Navigation Responsive Styles */
@media (max-width: 1024px) {
    .nav-links {
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .nav-link {
        padding: 8px 14px;
        font-size: 0.85rem;
    }
}

@media (max-width: 768px) {
    .nav-menu {
        padding: 15px 10px;
    }
    
    .nav-links {
        gap: 6px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .nav-link {
        padding: 10px 14px;
        font-size: 0.8rem;
        min-width: auto;
        flex: 0 1 auto;
    }
}

@media (max-width: 600px) {
    .nav-links {
        gap: 6px;
        flex-wrap: wrap;
    }
    .nav-link {
        padding: 8px 12px;
        font-size: 0.75rem;
        flex: 0 1 calc(50% - 6px); /* Two columns */
        text-align: center;
    }
}
</style>


<style>
.app-title {
  white-space: nowrap !important;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap;
}
</style>

<!-- Vercel Analytics -->
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>

</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>WORK SMART</h1>
                <div class="signature">By ALTANTAWY</div>
            </div>
        </header>
        
        <!-- Navigation Menu -->
        <nav class="nav-menu">
            <div class="nav-links">
                <a class="nav-link" href="#translator">🔤 Translator</a>
                <a class="nav-link" href="#date-converter">📅 Date</a>
                <a class="nav-link" href="#vat">💰 VAT</a>
                <a class="nav-link" href="#meals">🍽️ Meals</a>
                <a class="nav-link" href="#data-extraction">📤 Data</a>
                <a class="nav-link" href="#flat-rate">📊 Flat Rate</a>
                <a class="nav-link" href="#nights">🌙 Nights</a>
                <a class="nav-link" href="#business">💼 Business</a>
                <a class="nav-link" href="#packageCalc">📦 Package Calc</a>
                <a class="nav-link" href="#housingRatio">🏠 Housing Ratio</a>
                <a class="nav-link" href="#rooming">🏨 Rooming</a>
                <a class="nav-link" href="#extensions">📋 Extensions</a>
                <a class="nav-link" href="#tasks">✅ Tasks</a>
                <a class="nav-link" href="#notes">📝 Notes</a>
                <a class="nav-link" href="#email">✉️ Email</a>
            </div>
        </nav>
        
        <!-- Name Translator -->
        <div class="tool-box" id="translator">
            <div class="tool-title">🔤 Name Translator - مترجم الأسماء</div>
<div id="namePreferences" style="display:none;">
    <div>
        <label style="font-weight:600; margin-right:6px;">Hussein:</label>
        <select id="husseinPreference" style="padding:6px 10px; border-radius:8px;">
            <option value="HUSSEIN">Hussein</option>
            <option value="HUSSIEN">Hussien</option>
        </select>
    </div>
    <div>
        <label style="font-weight:600; margin-right:6px;">Mohamed:</label>
        <select id="mohamedPreference" style="padding:6px 10px; border-radius:8px;">
            <option value="MOHAMED">Mohamed</option>
            <option value="MOHAMMED">Mohammed</option>
        </select>
    </div>
</div>

            <div class="translator-grid">
                <div class="input-section">
                    <div class="section-label">🇪🇬 Arabic Names</div>
                    <textarea 
                        id="inputText" 
                        class="arabic-input" 
                        placeholder="اكتب الأسماء بالعربي هنا..."
                        oninput="translateName()"
                    ></textarea>
                </div>
                <button class="swap-btn" onclick="swapLanguages()">⇄</button>
                <div class="input-section">
                    <div class="section-label">🇬🇧 English Translation</div>
                    <textarea 
                        id="outputText" 
                        class="english-output" 
                        readonly
                        placeholder="Translation will appear here..."
                    ></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="copyToClipboard()">📋 Copy English Names</button>
                <button class="btn btn-secondary" onclick="clearAll()">🗑️ Clear All</button>
                <button class="btn btn-success" onclick="downloadAsText()">💾 Download as Text</button>
            </div>
        </div>
        
        <!-- Date Converter -->
        <div class="tool-box" id="date-converter">
            <div class="tool-title">📅 Date Converter - محول التاريخ</div>
            <div class="date-converter-grid">
                <!-- Gregorian to Hijri -->
                <div class="date-section">
                    <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center;">Gregorian → Hijri</h3>
                    <div class="form-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Select Gregorian Date</h4>
                        <input type="date" id="gregorianInput" oninput="autoConvertDate()">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="convertToHijri()">Convert to Hijri</button>
                    <div id="hijriResult" class="result-box">
                        <div class="result-label">Hijri Date</div>
                        <div class="result-value-wrapper">
    <span class="result-value" id="hijriDate"></span>
    <button class="copy-value-btn" onclick="copyValue('hijriDate')">Copy</button>
</div>
                    </div>
                </div>
                
                <!-- Hijri to Gregorian -->
                <div class="date-section">
                    <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center;">Hijri → Gregorian</h3>
                    <div class="form-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Enter Hijri Date</h4>
                        <div class="hijri-inputs">
                            <input type="number" id="hijriDay" placeholder="Day" min="1" max="30">
                            <select id="hijriMonth">
                                <option value="1">Muharram</option>
                                <option value="2">Safar</option>
                                <option value="3">Rabi' al-awwal</option>
                                <option value="4">Rabi' al-thani</option>
                                <option value="5">Jumada al-awwal</option>
                                <option value="6">Jumada al-thani</option>
                                <option value="7">Rajab</option>
                                <option value="8">Sha'ban</option>
                                <option value="9">Ramadan</option>
                                <option value="10">Shawwal</option>
                                <option value="11">Dhu al-Qi'dah</option>
                                <option value="12">Dhu al-Hijjah</option>
                            </select>
                            <input type="number" id="hijriYear" placeholder="Year" min="1">
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="convertToGregorian()">Convert to Gregorian</button>
                    <div id="gregorianResult" class="result-box">
                        <div class="result-label">Gregorian Date</div>
                        <div class="result-value" id="gregorianDate"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- VAT Calculator & Meals Calculator Side by Side -->
        <div class="tools-grid">
            <!-- VAT Calculator -->
            <div class="tool-box" id="vat">
                <div class="tool-title">💰 VAT (TAX) Calculator - حاسبة الضريبة</div>
                
                <div class="calc-grid">
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Amount (Including VAT)</h4>
                        <input type="number" id="vatAmount" placeholder="Enter amount with VAT" oninput="calculateVATFromIncluding()">
                    </div>
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Amount (Excluding VAT)</h4>
                        <input type="number" id="vatAmountExcluding" placeholder="Enter amount without VAT" oninput="calculateVATFromExcluding()">
                    </div>
                </div>
                
                <div class="result-box" id="vatResult" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">Amount Without VAT:</span>
                        <div class="result-value-wrapper">
    <span class="result-value" id="vatWithout">0.00</span>
    <button class="copy-value-btn" onclick="copyValue('vatWithout')">Copy</button>
</div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Amount With VAT:</span>
                        <div class="result-value-wrapper">
    <span class="result-value" id="vatWith">0.00</span>
    <button class="copy-value-btn" onclick="copyValue('vatWith')">Copy</button>
</div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">VAT Amount (15%):</span>
                        <div class="result-value-wrapper">
                            <span class="result-value" id="vatOnly">0.00</span>
                            
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Meals Calculator -->
            <div class="tool-box" id="meals">
                <div class="tool-title">🍽️ Meals Calculator - حاسبة الوجبات</div>
                
                <div class="calc-grid">
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Meal Price (per person)</h4>
                        <input type="number" id="mealPrice" placeholder="Enter meal price" oninput="calculateMeals()">
                    </div>
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Days</h4>
                        <input type="number" id="mealDays" placeholder="Enter number of days" oninput="calculateMeals()">
                    </div>
                </div>
                
                <div class="result-box" id="mealsResult" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">Total WITH VAT:</span>
                        <div class="result-value-wrapper">
    <span class="result-value" id="mealsWithVat">0.00</span>
    <button class="copy-value-btn" onclick="copyValue('mealsWithVat')">Copy</button>
</div>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Total WITHOUT VAT:</span>
                        <div class="result-value-wrapper">
    <span class="result-value" id="mealsWithoutVat">0.00</span>
    <button class="copy-value-btn" onclick="copyValue('mealsWithoutVat')">Copy</button>
</div>
                    </div>
                </div>
                
                <div class="description-box">
                    <h4>وصف الإستخدام</h4>
                    <p>في سيستم AMR 
في خانة خدمات أخرى
ستقوم بكتابة عدد الأشخاص المطلوب الوجبات لهم في خانة QTY 
وستأخذ الإجمالي الذي تم إحتسابه بالأعلى بدون الضريبة 
ووضعه في خانة البيع أو الكوست حسب سعر الوجبة وعدد الأيام وسيقوم السيستم بإحتساب الإجمالي النهائي.</p>
                </div>
            </div>
        </div>
        
        <!-- DATA EXTRACTION Tool -->
        <!-- ===================== EXTRACTOR DATA TOOL UI ===================== -->
<div class="tool-box" id="data-extraction">
  <div class="tool-title">📤 DATA EXTRACTION مستخلص البيانات <span style="font-size:0.65rem;background:linear-gradient(135deg,#7c3aed,#2563eb);color:white;padding:2px 10px;border-radius:20px;vertical-align:middle;margin-left:6px;">⚡ OCR.space + Claude AI</span></div>

  <!-- ENGINE BUTTONS (hidden — JS compatibility only) -->
  <div style="display:none;">
    <button id="engineBtn_3"></button>
    <button id="engineBtn_2"></button>
    <button id="engineBtn_1"></button>
    <button id="engineBtn_local"></button>
  </div>
  <!-- AUTO ENGINE STATUS BADGE -->
  <div id="engineStatusBadge" style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding:9px 14px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1.5px solid #86efac;border-radius:10px;font-size:0.8rem;transition:all 0.4s;">
    <span id="engineStatusIcon" style="font-size:1.1rem;">🤖</span>
    <div style="flex:1;min-width:0;">
      <span style="font-weight:700;color:#166534;">Auto Engine</span>
      <span id="engineStatusText" style="color:#15803d;margin-left:6px;font-size:0.78rem;">Will try Engine 3 → 2 → 1 → Local automatically</span>
    </div>
    <span id="engineActiveBadge" style="background:#166534;color:white;border-radius:20px;padding:2px 10px;font-size:0.7rem;font-weight:700;white-space:nowrap;">Auto</span>
  </div>

  <!-- OCR MODE TABS -->
  <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
    <button id="modeBtn_standard" class="ocr-mode-btn ocr-mode-active" onclick="setOCRMode('standard')">📄 Standard</button>
    <button id="modeBtn_passport" class="ocr-mode-btn" onclick="setOCRMode('passport')">🧾 Passport / MRZ</button>
    <button id="modeBtn_rooming" class="ocr-mode-btn" onclick="setOCRMode('rooming')">🛏️ Rooming List</button>
    <button id="modeBtn_table" class="ocr-mode-btn" onclick="setOCRMode('table')">📊 Table / Receipt</button>
    <button id="modeBtn_ai" class="ocr-mode-btn" onclick="setOCRMode('ai')" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;border-color:#7c3aed;">🤖 AI Extract</button>
  </div>

  <!-- ===== PASSPORT AUTO-FILL PANEL ===== -->
  <div id="passportAutoFill" class="input-section" style="display:none">
    <div class="section-label">🛂 Passport Auto-Fill</div>
    <input name="name" placeholder="Full Name" style="width:100%;margin-bottom:6px">
    <input name="nationality" placeholder="Nationality" style="width:100%;margin-bottom:6px">
    <input name="dob" placeholder="Date of Birth" style="width:100%">
  </div>

  <!-- DRAG & DROP UPLOAD ZONE -->
  <div id="dropZone" class="drop-zone"
    ondragover="event.preventDefault();this.classList.add('drop-zone-hover')"
    ondragleave="this.classList.remove('drop-zone-hover')"
    ondrop="handleDrop(event)"
    onclick="document.getElementById('ocrImage').click()">
    <div style="font-size:2rem;margin-bottom:6px;">📂</div>
    <div style="font-weight:700;font-size:0.95rem;">Click or Drag & Drop</div>
    <div style="font-size:0.8rem;color:#888;margin-top:4px;">Images (JPG, PNG, GIF, WebP) or PDF — multiple files supported</div>
    <div style="font-size:0.75rem;color:#7c3aed;margin-top:6px;font-weight:600;">⚡ Powered by OCR.space API (Engine 3) + Claude AI Extraction</div>
    <input type="file" id="ocrImage" accept="image/*,.pdf" multiple style="display:none" onchange="runBatchOCR()">
  </div>

  <!-- OCR OPTIONS (OCR.space style) -->
  <div style="display:flex;gap:16px;flex-wrap:wrap;margin:8px 0;padding:10px 14px;background:#f8fafc;border-radius:10px;border:1px solid #e2e8f0;font-size:0.82rem;">
    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-weight:600;color:#334155;">
      <input type="checkbox" id="optAutoRotate" checked style="accent-color:#3b82f6;"> 🔄 Auto-Rotate
    </label>
    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-weight:600;color:#334155;">
      <input type="checkbox" id="optAutoEnlarge" checked style="accent-color:#3b82f6;"> 🔍 Auto-Enlarge (low DPI)
    </label>
    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-weight:600;color:#334155;">
      <input type="checkbox" id="optTableDetect" style="accent-color:#3b82f6;"> 📊 Table / Receipt Mode
    </label>
    <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-weight:600;color:#334155;">
      <input type="checkbox" id="optOverlay" style="accent-color:#3b82f6;"> 🗺️ Show Word Overlay
    </label>
    <select id="ocrLanguage" style="padding:4px 8px;border:1px solid #cbd5e1;border-radius:6px;font-size:0.8rem;color:#334155;">
      <option value="auto" selected>🔍 Auto Detect (Default)</option>
      <option value="eng">English Only</option>
      <option value="ara">Arabic Only</option>
      <option value="tur">Turkish</option>
      <option value="fra">French</option>
      <option value="deu">German</option>
      <option value="urd">Urdu</option>
      <option value="hin">Hindi</option>
    </select>
  </div>

  <!-- WORD OVERLAY PANEL -->
  <div id="overlayPanel" style="display:none;margin-top:8px;border:1.5px solid #3b82f6;border-radius:10px;overflow:hidden;">
    <div style="background:#1e3a8a;color:white;padding:8px 14px;font-weight:700;font-size:0.82rem;display:flex;justify-content:space-between;align-items:center;">
      <span>🗺️ Word-Level Overlay</span>
      <button onclick="document.getElementById('overlayPanel').style.display='none'" style="background:none;border:none;color:white;cursor:pointer;font-size:1rem;">✕</button>
    </div>
    <div id="overlayContent" style="padding:10px;max-height:300px;overflow-y:auto;font-size:0.78rem;"></div>
  </div>

  <!-- AI EXTRACT PANEL (shows when AI mode active) -->
  <div id="aiExtractPanel" style="display:none;margin-top:10px;background:linear-gradient(135deg,#f5f3ff,#ede9fe);border:2px solid #7c3aed;border-radius:12px;padding:14px;">
    <div style="font-weight:700;color:#6d28d9;margin-bottom:8px;font-size:0.9rem;">🤖 AI Document Intelligence — Extract Specific Fields</div>
    <div style="font-size:0.8rem;color:#5b21b6;margin-bottom:10px;">Claude AI will analyze the document and extract exactly the fields you specify (like DataLab.to).</div>
    <label style="font-weight:600;font-size:0.82rem;color:#4c1d95;">Fields to extract (comma separated):</label>
    <input id="aiFieldsInput" type="text" value="Full Name, Passport Number, Nationality, Date of Birth, Expiry Date, Check-in, Check-out, Hotel, Room Type, Meal Plan, Confirmation Number, Phone" style="width:100%;margin-top:6px;padding:8px 12px;border:1.5px solid #a78bfa;border-radius:8px;font-size:0.82rem;">
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
      <button onclick="runAIExtraction()" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;border:none;border-radius:8px;padding:8px 18px;font-weight:700;cursor:pointer;font-size:0.85rem;">🤖 Run AI Extract</button>
      <button onclick="runAIExtractionWithOCR()" style="background:linear-gradient(135deg,#2563eb,#1e40af);color:white;border:none;border-radius:8px;padding:8px 18px;font-weight:700;cursor:pointer;font-size:0.85rem;">📷 Scan + AI Extract</button>
    </div>
    <div id="aiExtractStatus" style="display:none;margin-top:8px;font-size:0.8rem;color:#6d28d9;font-weight:600;"></div>
  </div>

  <!-- FILE PREVIEW LIST -->
  <div id="filePreviewList" style="display:none;margin:8px 0;font-size:0.82rem;color:#555;"></div>

  <!-- PROGRESS BAR -->
  <div id="ocrProgressWrap" style="display:none;margin:10px 0;">
    <div style="font-size:0.82rem;color:#555;margin-bottom:4px;" id="ocrProgressLabel">Processing...</div>
    <div style="background:#e0e0e0;border-radius:20px;height:10px;overflow:hidden;">
      <div id="ocrProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#3498db,#2ecc71);border-radius:20px;transition:width 0.3s;"></div>
    </div>
  </div>

  <!-- RESULT AREA -->
  <div class="input-section" style="margin-top:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <div class="section-label" style="margin:0;">📄 Extracted Text</div>
      <div style="display:flex;gap:6px;align-items:center;">
        <span id="charCount" style="font-size:0.75rem;color:#999;">0 chars</span>
        <button class="ocr-mini-btn" onclick="copyOCRResult()" title="Copy all text">📋 Copy</button>
        <button class="ocr-mini-btn ocr-mini-danger" onclick="clearOCRResult()" title="Clear">🗑️ Clear</button>
      </div>
    </div>
    <textarea id="ocrResult" placeholder="OCR results will appear here... You can also type or paste text directly." style="min-height:160px;" oninput="updateCharCount(); liveReExtract();"></textarea>
    <!-- SEARCH BAR -->
    <input id="ocrSearchBar" type="text" placeholder="🔍 Search inside extracted text..." oninput="highlightSearch(this.value)" style="display:none;">
  </div>

  <!-- LIVE SMART EXTRACTION PREVIEW -->
  <div id="extractionPreviewPanel">
    <div class="ext-panel-header">
      <span>🧠 Smart Extraction Preview <span style="font-size:0.7rem;opacity:0.8;">(Regex + AI Powered)</span></span>
      <div style="display:flex;gap:8px;align-items:center;">
        <span class="ext-scan-counter" id="scanCountBadge">0 fields</span>
        <button class="ext-copy-all-btn" onclick="copyAllExtracted()">📋 Copy All</button>
        <button onclick="clearExtractionPreview()" style="background:rgba(255,255,255,0.15);border:none;color:white;cursor:pointer;border-radius:6px;padding:4px 8px;font-size:0.75rem;">✕ Close</button>
      </div>
    </div>
    <div class="ext-panel-body">
      <!-- Quality bar -->
      <div class="ext-quality-bar-wrap">
        <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:#64748b;">
          <span>Data Quality</span>
          <span id="qualityScoreLabel" style="font-weight:700;color:#10b981;">0%</span>
        </div>
        <div class="ext-quality-bar-bg">
          <div class="ext-quality-bar-fill" id="qualityBarFill" style="width:0%"></div>
        </div>
      </div>
      <!-- Accumulated scan rows badge -->
      <div id="accumulatedBadge" style="display:none;margin-bottom:10px;">
        <span class="ext-row-badge" id="accumulatedCount">📑 1 scan accumulated</span>
        <button onclick="clearAccumulatedScans()" style="margin-left:8px;background:none;border:1px solid #cbd5e1;border-radius:5px;padding:2px 8px;font-size:0.72rem;cursor:pointer;color:#64748b;">Clear All</button>
      </div>
      <!-- Field cards grid -->
      <div class="ext-fields-grid" id="extFieldsGrid"></div>
      <div id="extEmptyMsg" style="text-align:center;color:#94a3b8;font-size:0.85rem;padding:20px 0;">No data extracted yet. Upload an image or paste text above.</div>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div class="btn-group" style="margin-top:10px;flex-wrap:wrap;gap:6px;">
    <button class="btn btn-success" onclick="exportExtractedExcel()">📊 Export Excel</button>
    <button class="btn btn-primary" onclick="exportExtractedText()">💾 Save as Text</button>
    <button class="btn btn-secondary" id="sendToTranslatorBtn" style="display:none;" onclick="sendToTranslator()">🌐 Translate Arabic</button>
    <button class="btn" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white;" onclick="toggleOCRSearch()">🔍 Search Text</button>
    <button class="btn" style="background:linear-gradient(135deg,#059669,#047857);color:white;" onclick="runAIExtraction()" title="Use Claude AI to extract fields from pasted text">🤖 AI Re-Extract</button>
  </div>

  <!-- STATUS TOAST INLINE -->
  <div id="ocrStatus" style="display:none;margin-top:10px;padding:8px 14px;border-radius:8px;font-size:0.85rem;font-weight:600;"></div>

  <!-- ACCURACY NOTE -->
  <div class="description-box" style="margin-top:16px;padding:14px;">
    <h4 style="font-size:0.82rem;margin-bottom:7px;">📌 ملاحظة / Note</h4>
    <p style="font-size:0.75rem;line-height:1.7;">
      🔬 <strong>Pipeline:</strong> OCR.space API (Engine 3 = best, handles Arabic + handwriting + special chars) → Claude AI Structured Extraction<br>
      📌 <strong>Free API key</strong> has rate limits. For heavy use, get a free key at <strong>ocr.space/OCRAPI</strong><br>
      💻 <strong>Offline mode</strong> available: select "Local (Offline)" engine — uses browser Tesseract<br>
      دقة الاستخراج تصل إلى ٩٩٪ مع محرك Engine 3 + Claude AI للغة العربية والإنجليزية<br>
      <span style="color:#7c3aed;font-weight:600;">✨ Best workflow: Upload → auto-scan (tries Engine 3→2→1 automatically) → click 🤖 AI Re-Extract for perfect structured data</span>
    </p>
  </div>

</div><!-- END extractorDataTool -->

<style>
/* ===== EXTRACTION LIVE PREVIEW PANEL ===== */
#extractionPreviewPanel {
  margin-top: 14px;
  display: none;
  animation: fadeInUp 0.4s ease;
}
@keyframes fadeInUp {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:translateY(0); }
}
.ext-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: linear-gradient(135deg,#1e3a8a,#3b82f6);
  color: white;
  border-radius: 12px 12px 0 0;
  padding: 10px 16px;
  font-weight: 700;
  font-size: 0.9rem;
}
.ext-panel-body {
  border: 2px solid #3b82f6;
  border-top: none;
  border-radius: 0 0 12px 12px;
  padding: 14px;
  background: #f8fafc;
}
.ext-quality-bar-wrap {
  margin-bottom: 12px;
}
.ext-quality-bar-bg {
  background: #e2e8f0;
  border-radius: 20px;
  height: 8px;
  overflow: hidden;
  margin-top: 4px;
}
.ext-quality-bar-fill {
  height: 100%;
  border-radius: 20px;
  transition: width 0.6s ease;
  background: linear-gradient(90deg,#10b981,#3b82f6);
}
.ext-fields-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 10px;
}
.ext-field-card {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 10px 12px;
  position: relative;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  transition: box-shadow 0.2s;
}
.ext-field-card:hover { box-shadow: 0 4px 12px rgba(30,58,138,0.12); }
.ext-field-label {
  font-size: 0.68rem;
  font-weight: 700;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.ext-field-values {
  font-size: 0.85rem;
  color: #1e293b;
  font-weight: 600;
  word-break: break-word;
  line-height: 1.5;
}
.ext-field-value-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
  padding: 2px 0;
  border-bottom: 1px dashed #f1f5f9;
}
.ext-field-value-item:last-child { border-bottom: none; }
.ext-copy-val-btn {
  background: none;
  border: 1px solid #cbd5e1;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.7rem;
  padding: 1px 5px;
  color: #64748b;
  transition: all 0.15s;
  white-space: nowrap;
  flex-shrink: 0;
}
.ext-copy-val-btn:hover { background:#3b82f6; color:white; border-color:#3b82f6; }
.ext-type-badge {
  font-size: 0.58rem;
  font-weight: 800;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  padding: 2px 7px;
  border-radius: 99px;
  white-space: nowrap;
  flex-shrink: 0;
}
.ext-copy-all-btn {
  background: linear-gradient(135deg,#10b981,#059669);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 14px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.ext-copy-all-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(16,185,129,0.3); }
.ext-scan-counter {
  display: inline-block;
  background: rgba(255,255,255,0.2);
  border-radius: 20px;
  padding: 2px 10px;
  font-size: 0.75rem;
}
.ext-row-badge {
  background: #fef3c7;
  color: #92400e;
  border-radius: 5px;
  padding: 2px 8px;
  font-size: 0.72rem;
  font-weight: 700;
}
/* Search highlight */
.ocr-highlight { background: #fef08a; border-radius: 2px; }
/* Search bar */
#ocrSearchBar {
  width: 100%;
  padding: 7px 12px;
  border: 1.5px solid #e2e8f0;
  border-radius: 8px;
  font-size: 0.85rem;
  outline: none;
  margin-top: 6px;
  transition: border-color 0.2s;
}
#ocrSearchBar:focus { border-color: #3b82f6; }

.ocr-mode-btn {
  padding: 7px 16px;
  border: 2px solid #3498db;
  background: #fff;
  color: #3498db;
  border-radius: 20px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.82rem;
  transition: all 0.2s;
}
.ocr-mode-btn:hover { background: #ebf5fb; }
.ocr-mode-active {
  background: #3498db !important;
  color: #fff !important;
}
.drop-zone {
  border: 2px dashed #3498db;
  border-radius: 12px;
  padding: 28px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: #f8fbff;
}
.drop-zone:hover, .drop-zone-hover {
  background: #ebf5fb;
  border-color: #2980b9;
}
.ocr-mini-btn {
  padding: 3px 10px;
  border: 1px solid #ccc;
  background: #f5f5f5;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.78rem;
  transition: background 0.15s;
}
.ocr-mini-btn:hover { background: #e0e0e0; }
.ocr-mini-danger { border-color: #e74c3c; color: #e74c3c; }
.ocr-mini-danger:hover { background: #fdecea; }
</style>
</div>

        <!-- Flat Rate Calculator -->
        <div class="tool-box" id="flat-rate">
            <div class="tool-title">📊 Flat Rate Calculator - حاسبة الأسعار</div>
            <div class="flat-rate-container">
                <!-- Method 1: W.D / W.E -->
                <div class="flat-section">
                    <h4>Method 1: Weekdays / Weekend</h4>
                    <div class="flat-input-grid">
                        <div></div>
                        <div style="text-align: center; font-weight: 700; color: var(--primary);">PRICE</div>
                        <div style="text-align: center; font-weight: 700; color: var(--primary);">DAYS</div>
                    </div>
                    <div class="flat-input-grid">
                        <div style="font-weight: 700; color: var(--dark);">W.D</div>
                        <input type="number" id="wdPrice" placeholder="0" oninput="calculateFlatRate1()">
                        <input type="number" id="wdDays" placeholder="0" oninput="calculateFlatRate1()">
                    </div>
                    <div class="flat-input-grid">
                        <div style="font-weight: 700; color: var(--dark);">W.E</div>
                        <input type="number" id="wePrice" placeholder="0" oninput="calculateFlatRate1()">
                        <input type="number" id="weDays" placeholder="0" oninput="calculateFlatRate1()">
                    </div>
                    <div class="flat-result">
                        <button class="copy-result-btn" onclick="copyFlatRate1()">📋 Copy</button>
                        <div class="flat-result-label">FLAT RATE</div>
                        <div class="flat-result-value" id="flatRate1">0</div>
                    </div>
                </div>
                
                <!-- Method 2: Daily Selection -->
                <div class="flat-section">
                    <h4>Method 2: Daily Price Selection</h4>
                    <div id="dailyPricesList">
                        <div class="day-item">
                            <select class="day-select" onchange="updateDaySequence(this)">
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                            </select>
                            <input type="number" class="day-price" placeholder="Price" oninput="calculateFlatRate2()">
                            <button class="remove-day-btn" onclick="removeDayItem(this)">✕</button>
                        </div>
                        <div class="day-item">
                            <select class="day-select" onchange="updateDaySequence(this)">
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday" selected>Sunday</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                            </select>
                            <input type="number" class="day-price" placeholder="Price" oninput="calculateFlatRate2()">
                            <button class="remove-day-btn" onclick="removeDayItem(this)">✕</button>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="addDayItem()">➕ Add Day</button>
                    <div class="flat-result">
                        <button class="copy-result-btn" onclick="copyFlatRate2()">📋 Copy</button>
                        <div class="flat-result-label">FLAT RATE</div>
                        <div class="flat-result-value" id="flatRate2">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Nights Calculator & Placeholder Side by Side -->
        <div class="tools-grid">
            <!-- Nights Calculator -->
            <div class="tool-box" id="nights">
                <div class="tool-title">🌙 Nights Calculator - حاسبة الليالي</div>
                
                <div class="calc-grid">
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Check-In Date - تاريخ الدخول</h4>
                        <input type="date" id="checkInDate" onchange="calculateNights()">
                    </div>
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">Check-Out Date - تاريخ الخروج</h4>
                        <input type="date" id="checkOutDate" onchange="calculateNights()">
                    </div>
                </div>
                
                <div class="nights-result" id="nightsResult">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div class="nights-label">
                            Total Nights - إجمالي الليالي:
                            <span class="nights-value" id="nightsValue">0</span>
                        </div>
                        <div class="nights-breakdown">
                            <span class="breakdown-label">W.D (Weekday)</span>
                            <span class="breakdown-value" id="weekdayValue">0</span>
                        </div>
                        <div class="nights-breakdown weekend">
                            <span class="breakdown-label">W.E (Weekend)</span>
                            <span class="breakdown-value" id="weekendValue">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Business Calculator -->
            <div class="tool-box" id="business">
                <div class="tool-title">💼 Business Calculator - حاسبة الأعمال</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px;">
                    <!-- Profit Calculator -->
                    <div style="border-right: 2px solid var(--border); padding-right: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px; text-align: center;">💰 Profit Calculator</h4>
                        <div class="calc-grid">
                            <div class="input-group">
                                <label>COST - التكلفة</label>
                                <input type="number" id="businessCost" placeholder="Enter cost" oninput="calculateBusiness()">
                            </div>
                            <div class="input-group">
                                <label>SELL - البيع</label>
                                <input type="number" id="businessSell" placeholder="Enter sell price" oninput="calculateBusiness()">
                            </div>
                        </div>
                        
                        <div class="business-result" id="businessResult">
                            <div class="business-display">
                                <span class="business-label">PROFIT - الربح:</span>
                                <span class="business-value" id="businessProfit">0.00</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reservation Counter -->
                    <div style="padding-left: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 15px; text-align: center;">📊 Reservation Counter</h4>
                        <div id="reservationBoxes">
                            <div class="reservation-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="number" class="reservation-input" placeholder="0" oninput="calculateReservationTotal()" style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem;">
                                <button onclick="removeReservationBox(this)" style="background: var(--error); color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;">✕</button>
                            </div>
                            <div class="reservation-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="number" class="reservation-input" placeholder="0" oninput="calculateReservationTotal()" style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem;">
                                <button onclick="removeReservationBox(this)" style="background: var(--error); color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;">✕</button>
                            </div>
                            <div class="reservation-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="number" class="reservation-input" placeholder="0" oninput="calculateReservationTotal()" style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem;">
                                <button onclick="removeReservationBox(this)" style="background: var(--error); color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;">✕</button>
                            </div>
                            <div class="reservation-item" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                <input type="number" class="reservation-input" placeholder="0" oninput="calculateReservationTotal()" style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem;">
                                <button onclick="removeReservationBox(this)" style="background: var(--error); color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;">✕</button>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="addReservationBox()">➕ Add Box</button>
                        
                        <div style="background: linear-gradient(135deg, #1e3a8a, #1e40af); padding: 10px 15px; border-radius: 15px; text-align: center;">
                            <div style="color: white; font-size: 0.9rem; margin-bottom: 5px;">TOTAL RESERVATIONS</div>
                            <div style="color: white; font-size: 2rem; font-weight: 700;" id="reservationTotal">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Package Calculator & Housing Ratio Side by Side -->
        <div class="tools-grid">

            <!-- Package Calculator -->
            <div class="tool-box" id="packageCalc">
                <div class="tool-title">📦 Package Calculator - حاسبة الباكج</div>
                <div class="calc-grid">
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">PACKAGE TOTAL - إجمالي الباكج</h4>
                        <input type="number" id="pkgTotal" placeholder="Enter package total" oninput="calculatePackage()">
                    </div>
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">NIGHTS - الليالي</h4>
                        <input type="number" id="pkgNights" placeholder="Enter number of nights" oninput="calculatePackage()">
                    </div>
                </div>
                <div class="business-result" id="pkgResult">
                    <div class="business-display">
                        <span class="business-label">NIGHT RATE - سعر الليلة:</span>
                        <span class="business-value positive" id="pkgNightRate">0.00</span>
                        <button class="copy-value-btn" onclick="copyValue('pkgNightRate')">Copy</button>
                    </div>
                </div>
            </div>

            <!-- Housing Ratio -->
            <div class="tool-box" id="housingRatio">
                <div class="tool-title">🏠 Housing Ratio - نسبة التسكين</div>
                <div class="housing-ratio-grid">
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">TOTAL ROOMS - إجمالي الغرف</h4>
                        <input type="number" id="hrTotalRooms" placeholder="Enter total rooms" oninput="calculateHousingRatioSmart(); calculateRoomLayout();">
                    </div>
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">TOTAL PAX - إجمالي الأشخاص</h4>
                        <input type="number" id="hrTotalPax" placeholder="Enter total pax" oninput="calculateHousingRatioSmart(); calculateRoomLayout();">
                    </div>
                    <div class="input-group">
                        <h4 style="color: var(--primary); margin-bottom: 10px; font-size: 0.95rem;">RATIO - النسبة</h4>
                        <input type="number" id="hrRatio" placeholder="e.g. 2 or 3" oninput="calculateHousingRatioSmart(); calculateRoomLayout();">
                    </div>
                </div>
                <!-- Room Layout Section -->
                <div class="room-layout-section">
                    <div class="room-layout-title">🛏️ Room Layout - نوع الغرف</div>
                    <div class="room-layout-boxes" id="roomLayoutBoxes">
                        <div class="room-type-box" draggable="true" data-type="DBL" data-pax="2" data-index="0">
                            <span class="priority-badge">1</span>
                            <input type="checkbox" class="room-type-checkbox" id="chk_DBL" onchange="calculateRoomLayout()">
                            <div>
                                <div class="room-type-label">DBL</div>
                                <div class="room-type-pax">2 pax</div>
                            </div>
                        </div>
                        <div class="room-type-box" draggable="true" data-type="TRPL" data-pax="3" data-index="1">
                            <span class="priority-badge">2</span>
                            <input type="checkbox" class="room-type-checkbox" id="chk_TRPL" onchange="calculateRoomLayout()">
                            <div>
                                <div class="room-type-label">TRPL</div>
                                <div class="room-type-pax">3 pax</div>
                            </div>
                        </div>
                        <div class="room-type-box" draggable="true" data-type="QUAD" data-pax="4" data-index="2">
                            <span class="priority-badge">3</span>
                            <input type="checkbox" class="room-type-checkbox" id="chk_QUAD" onchange="calculateRoomLayout()">
                            <div>
                                <div class="room-type-label">QUAD</div>
                                <div class="room-type-pax">4 pax</div>
                            </div>
                        </div>
                        <div class="room-type-box" draggable="true" data-type="QUINT" data-pax="5" data-index="3">
                            <span class="priority-badge">4</span>
                            <input type="checkbox" class="room-type-checkbox" id="chk_QUINT" onchange="calculateRoomLayout()">
                            <div>
                                <div class="room-type-label">QUINT</div>
                                <div class="room-type-pax">5 pax</div>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap:8px; margin-top:10px; flex-wrap:wrap;">
                        <button class="add-room-type-btn" onclick="openAddRoomTypeModal()">
                            ➕ Add Type
                        </button>
                        <span style="font-size:0.75rem; color:#94a3b8;">Add SGL, 6-pax, custom...</span>
                    </div>
                    <div class="layout-drag-hint">☝️ Drag to reorder priority &nbsp;|&nbsp; First = highest priority</div>
                    <div class="layout-result-section" id="layoutResult">
                        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; margin-bottom:8px;">
                            <div class="layout-result-title" style="margin:0;">🏆 Best Room Layout - أفضل توزيع للغرف</div>
                            <button id="nextLayoutBtn" onclick="showNextLayout()" style="display:none; background:linear-gradient(135deg,#6366f1,#4f46e5); color:#fff; border:none; padding:7px 16px; border-radius:10px; font-size:0.82rem; font-weight:700; cursor:pointer; box-shadow:0 2px 8px rgba(99,102,241,0.35); transition:all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">🔄 Next Layout - توزيع آخر</button>
                        </div>
                        <div class="layout-result-rows" id="layoutResultRows"></div>
                        <div id="layoutMessage" style="margin-top:10px; display:none;"></div>
                    </div>
                </div>

                <div class="business-result" id="hrResult">
                    <div class="business-display" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                        <span class="business-label" id="hrResultLabel">RESULT:</span>
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; width:100%; justify-content:space-between;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <span class="business-value positive" id="hrResultValue">0</span>
                                <span id="hrBedIcons" style="font-size: 1.8rem; letter-spacing: 4px;"></span>
                            </div>
                            <button onclick="clearHousingRatio()" style="background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; border:none; padding:8px 20px; border-radius:10px; font-size:0.85rem; font-weight:700; cursor:pointer; display:flex; align-items:center; gap:6px; box-shadow:0 2px 8px rgba(239,68,68,0.4); transition:all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">🗑️ Clear - مسح</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Rooming List Maker -->
        <div class="tool-box" id="rooming">
            <div class="tool-title">🏨 Rooming List Maker - قائمة الغرف</div>
            
            <div class="rooming-header">
                <div>GUEST NAME</div>
                <div>ROOMS</div>
                <div>ROOM TYPE</div>
                <div>MEAL TYPE</div>
                <div>VIEW TYPE</div>
                <div></div>
            </div>
            
            <div id="roomingList">
                <div class="rooming-row">
                    <input type="text" class="guest-name" placeholder="Guest Name">
                    <input type="number" class="room-number" placeholder="Rooms" min="1">
                    
<input list="roomTypes" class="room-type" placeholder="Room Type">
<datalist id="roomTypes">
  <option value="SGL"><option value="DBL"><option value="TRPL"><option value="QUAD">
  <option value="QUIENT"><option value="STUDIO">
  <option value="1B SUITE"><option value="2B SUITE"><option value="3B SUITE">
  <option value="ROYAL SUITE">
  <option value="1B APARTMENT"><option value="2B APARTMENT"><option value="3B APARTMENT">
</datalist>

<input list="mealTypes" class="meal-type" placeholder="Meal Type">
<datalist id="mealTypes">
  <option value="R.O"><option value="B.B"><option value="H.B"><option value="F.B">
</datalist>

<input list="viewTypes" class="view-type" placeholder="View Type">
<datalist id="viewTypes">
  <option value="C.V"><option value="N.V"><option value="K.V"><option value="H.V">
  <option value="PARTIAL K.V"><option value="PARTIAL H.V"><option value="PREMIER K.V">
</datalist>

                    <button class="remove-day-btn" onclick="removeRoomingRow(this)">✕</button>
                </div>
            </div>
            
            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="addRoomingRow()">➕ Add Guest</button>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="generateRoomingPreview()">👁️ Preview</button>
                <button class="btn btn-primary" onclick="saveRoomingAsImage()">🖼️ Save as Image</button>
                <button class="btn btn-primary" onclick="saveRoomingAsExcel()">📊 Save as Excel</button>
                <button class="btn btn-secondary" onclick="clearRoomingList()">🗑️ Clear All</button>
            </div>

            <!-- Logo / Branding Strip -->
            <div class="logo-strip" id="roomingLogoStrip">
                <div class="logo-strip-label">🏨 Bottom-Left Branding (optional)</div>
                <div class="logo-strip-row">
                    <input type="text" id="roomingBrandText" placeholder="Hotel / Company name..." class="logo-text-input">
                    <span class="logo-or">or</span>
                    <label class="logo-upload-btn">
                        📁 Upload Logo
                        <input type="file" id="roomingLogoFile" accept="image/*" onchange="previewRoomingLogo(this)" style="display:none">
                    </label>
                    <button class="logo-clear-btn" onclick="clearRoomingLogo()">✕ Clear</button>
                </div>
                <div id="roomingLogoPreview" class="logo-preview-thumb"></div>
            </div>
            
            <div id="roomingPreview" class="rooming-preview">
                <h3 style="color: var(--primary); text-align: center; margin-bottom: 20px;">ROOMING LIST</h3>
                <table class="rooming-table" id="roomingTable">
                    <thead>
                        <tr>
                            <th>GUEST NAME</th>
                            <th>ROOMS</th>
                            <th>ROOM TYPE</th>
                            <th>MEAL TYPE</th>
                            <th>VIEW TYPE</th>
                        </tr>
                    </thead>
                    <tbody id="roomingTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Extensions Maker -->
        <div class="tool-box" id="extensions">
            <div class="tool-title">📋 Extensions Maker - تمديدات الفنادق</div>
            
            <div class="extensions-header">
                <div>GUEST NAME</div>
                <div>OLD HCN</div>
                <div>NEW HCN</div>
                <div>FROM</div>
                <div>TO</div>
                <div></div>
            </div>
            
            <div id="extensionsList">
                <div class="extensions-row">
                    <input type="text" class="ext-guest-name" placeholder="Guest Name">
                    <input type="text" class="ext-old-hcn" placeholder="Old HCN">
                    <input type="text" class="ext-new-hcn" placeholder="New HCN">
                    <input type="date" class="ext-from">
                    <input type="date" class="ext-to">
                    <button class="remove-day-btn" onclick="removeExtensionRow(this)">✕</button>
                </div>
            </div>
            
            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="addExtensionRow()">➕ Add Extension</button>
            
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="generateExtensionsPreview()">👁️ Preview</button>
                <button class="btn btn-primary" onclick="saveExtensionsAsImage()">🖼️ Save as Image</button>
                <button class="btn btn-primary" onclick="saveExtensionsAsExcel()">📊 Save as Excel</button>
                <button class="btn btn-secondary" onclick="clearExtensionsList()">🗑️ Clear All</button>
            </div>

            <!-- Logo / Branding Strip -->
            <div class="logo-strip" id="extensionsLogoStrip">
                <div class="logo-strip-label">🏨 Bottom-Left Branding (optional)</div>
                <div class="logo-strip-row">
                    <input type="text" id="extensionsBrandText" placeholder="Hotel / Company name..." class="logo-text-input">
                    <span class="logo-or">or</span>
                    <label class="logo-upload-btn">
                        📁 Upload Logo
                        <input type="file" id="extensionsLogoFile" accept="image/*" onchange="previewExtensionsLogo(this)" style="display:none">
                    </label>
                    <button class="logo-clear-btn" onclick="clearExtensionsLogo()">✕ Clear</button>
                </div>
                <div id="extensionsLogoPreview" class="logo-preview-thumb"></div>
            </div>
            
            <div id="extensionsPreview" class="extensions-preview">
                <h3 style="color: var(--primary); text-align: center; margin-bottom: 20px;">EXTENSIONS LIST</h3>
                <table class="extensions-table" id="extensionsTable">
                    <thead>
                        <tr>
                            <th>GUEST NAME</th>
                            <th>OLD HCN</th>
                            <th>NEW HCN</th>
                            <th>FROM</th>
                            <th>TO</th>
                        </tr>
                    </thead>
                    <tbody id="extensionsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Task Manager & Notes Side by Side -->
        <div class="task-notes-grid">
            <!-- Task Manager -->
            <div class="tool-box" id="tasks">
                <div class="tool-title">✅ Task Manager - مدير المهام</div>
                
                <div class="task-input-group">
                    <input type="text" id="taskInput" class="task-input" placeholder="Add a new task..." onkeypress="if(event.key === 'Enter') addTask()">
                    <button class="add-task-btn" onclick="addTask()">➕ Add Task</button>
                </div>
                
                <div id="taskList" class="task-list"></div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveTasksManually()">💾 Save Tasks</button>
                    <button class="btn btn-primary" onclick="exportTasks()">📥 Export Tasks</button>
                    <button class="btn btn-secondary" onclick="clearCompletedTasks()">🗑️ Clear Completed</button>
                    <button class="btn btn-secondary" onclick="clearAllTasks()">🗑️ Clear All</button>
                </div>
            </div>
            
            <!-- Notes -->
            <div class="tool-box" id="notes">
                <div class="tool-title">📝 Quick Notes - ملاحظات سريعة</div>
                
                <textarea 
                    id="notesArea" 
                    class="notes-area" 
                    placeholder="Write your notes here..."
                    oninput="updateNotesCount()"
                ></textarea>
                
                <div class="notes-count" id="notesCount">0 characters</div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveNotes()">💾 Save Notes</button>
                    <button class="btn btn-primary" onclick="exportNotes()">📥 Export Notes</button>
                    <button class="btn btn-secondary" onclick="clearNotes()">🗑️ Clear Notes</button>
                </div>
            </div>
        </div>
        
        
        <!-- Email Forms Tool -->
        <div class="tool-box" id="email">
            <div class="tool-title">✉️ Email Forms - صيغ الإيميلات</div>
            
            <div id="emailFormsContainer"></div>
        </div>
        
<!-- Footer -->
        <footer>
            <div class="footer-content">⚡ THIS APP IS POWERED BY</div>
            <div class="footer-content">MR. HUSSIEN ALTANTAWY</div>
            <div class="footer-contact">
                <div class="footer-item">📱 +2 012 81 80 64 61</div>
                <div class="footer-item">📧 <a href="/cdn-cgi/l/email-protection#eda5b8bebea4a8a3c3aca1b9aca3b9acbab4adb4aca5a2a2c3aea2a0" style="color: white; text-decoration: none;"><span class="__cf_email__" data-cfemail="175f4244445e525939565b4356594356404e574e565f58583954585a">[email&#160;protected]</span></a></div>
            </div>
        


</footer>
    </div>
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // Email decode fallback (in case Cloudflare protection doesn't work)
        function decodeEmail(encodedString) {
            var email = '', r = parseInt(encodedString.substr(0, 2), 16), n, i;
            for (n = 2; encodedString.length - n; n += 2) {
                i = parseInt(encodedString.substr(n, 2), 16) ^ r;
                email += String.fromCharCode(i);
            }
            return email;
        }
        
        // Decode protected emails on page load
        document.addEventListener('DOMContentLoaded', function() {
            var emailElements = document.querySelectorAll('span[data-cfemail]');
            emailElements.forEach(function(element) {
                var encoded = element.getAttribute('data-cfemail');
                if (encoded) {
                    var decoded = decodeEmail(encoded);
                    element.textContent = decoded;
                    
                    // Update parent link if it exists
                    var parentLink = element.closest('a[href*="email-protection"]');
                    if (parentLink) {
                        parentLink.href = 'mailto:' + decoded;
                    }
                }
            });
        });
        
        // Enhanced Arabic to English Translation Map with Smart Phonetic Rules
        const arabicToEnglish = {
            'ا': 'A', 'أ': 'A', 'إ': 'I', 'آ': 'A',
            'ب': 'B', 'ت': 'T', 'ث': 'TH', 'ج': 'G',
            'ح': 'H', 'خ': 'KH', 'د': 'D', 'ذ': 'TH',
            'ر': 'R', 'ز': 'Z', 'س': 'S', 'ش': 'SH',
            'ص': 'S', 'ض': 'D', 'ط': 'T', 'ظ': 'Z',
            'ع': 'A', 'غ': 'GH', 'ف': 'F', 'ق': 'K',
            'ك': 'K', 'ل': 'L', 'م': 'M', 'ن': 'N',
            'ه': 'H', 'ة': 'H', 'و': 'W', 'ي': 'Y',
            'ى': 'A', 'ؤ': 'O', 'ئ': 'E', 'ء': 'A',
            'َ': 'A', 'ً': 'AN', 'ُ': 'U', 'ٌ': 'UN',
            'ِ': 'I', 'ٍ': 'IN', 'ْ': '', 'ّ': ''
        };
        
        // Smart phonetic patterns for better name transliteration
        
// ================= NAME TRANSLATION ENHANCEMENTS =================
const nameDictionary = {
    // ========== MALE NAMES - EGYPTIAN & GULF ==========
    
    // محمد variations and derivatives
    "محمد": ["MOHAMMED", "MOHAMED"],
    "محمود": ["MAHMOUD"],
    "مصطفى": ["MOSTAFA", "MUSTAFA"],
    "مروان": ["MARWAN"],
    "ماجد": ["MAJED"],
    "مالك": ["MALEK"],
    "ماهر": ["MAHER"],
    "مأمون": ["MAMOUN"],
    "مازن": ["MAZEN"],
    "معاذ": ["MOAZ"],
    "معتز": ["MOATAZ"],
    "مراد": ["MOURAD"],
    "مهند": ["MOHANNAD"],
    "مؤمن": ["MOAMEN"],
    "مجاهد": ["MOGAHED"],
    "مهاب": ["MOHAB"],
    "مصعب": ["MOSSAB"],
    
    // أحمد and similar
    "احمد": ["AHMED"],
    "أحمد": ["AHMED"],
    "أمجد": ["AMJAD"],
    "امجد": ["AMJAD"],
    "اشرف": ["ASHRAF"],
    "أشرف": ["ASHRAF"],
    "انور": ["ANWAR"],
    "أنور": ["ANWAR"],
    "أيمن": ["AYMAN"],
    "ايمن": ["AYMAN"],
    "أسامة": ["OSAMA"],
    "اسامه": ["OSAMA"],
    "أسعد": ["ASAAD"],
    "اسعد": ["ASAAD"],
    "أديب": ["ADEEB"],
    "اديب": ["ADEEB"],
    
    // عبد names (all variations) - 40+ combinations
    "عبدالله": ["ABDULLAH"],
    "عبد الله": ["ABDULLAH"],
    "عبدالرحمن": ["ABDULRAHMAN", "ABDUL RAHMAN"],
    "عبد الرحمن": ["ABDULRAHMAN", "ABDUL RAHMAN"],
    "عبدالعزيز": ["ABDULAZIZ", "ABDUL AZIZ"],
    "عبد العزيز": ["ABDULAZIZ", "ABDUL AZIZ"],
    "عبدالمجيد": ["ABDULMAJEED"],
    "عبد المجيد": ["ABDULMAJEED"],
    "عبدالكريم": ["ABDULKAREEM"],
    "عبد الكريم": ["ABDULKAREEM"],
    "عبدالمحسن": ["ABDULMOHSEN"],
    "عبد المحسن": ["ABDULMOHSEN"],
    "عبدالرحيم": ["ABDULRAHEEM"],
    "عبد الرحيم": ["ABDULRAHEEM"],
    "عبدالرؤوف": ["ABDULRAOUF"],
    "عبد الرؤوف": ["ABDULRAOUF"],
    "عبدالسلام": ["ABDULSALAM"],
    "عبد السلام": ["ABDULSALAM"],
    "عبدالفتاح": ["ABDULFATAH"],
    "عبد الفتاح": ["ABDULFATAH"],
    "عبدالقادر": ["ABDULKADER"],
    "عبد القادر": ["ABDULKADER"],
    "عبدالوهاب": ["ABDULWAHAB"],
    "عبد الوهاب": ["ABDULWAHAB"],
    "عبدالحميد": ["ABDULHAMEED"],
    "عبد الحميد": ["ABDULHAMEED"],
    "عبدالباسط": ["ABDULBASET"],
    "عبد الباسط": ["ABDULBASET"],
    "عبدالناصر": ["ABDULNASSER"],
    "عبد الناصر": ["ABDULNASSER"],
    "عبدالحكيم": ["ABDULHAKEEM"],
    "عبد الحكيم": ["ABDULHAKEEM"],
    "عبدالعليم": ["ABDULALEEM"],
    "عبد العليم": ["ABDULALEEM"],
    "عبدالجليل": ["ABDULJALEEL"],
    "عبد الجليل": ["ABDULJALEEL"],
    "عبدالجواد": ["ABDULJAWAD"],
    "عبد الجواد": ["ABDULJAWAD"],
    "عبدالحافظ": ["ABDULHAFEZ"],
    "عبد الحافظ": ["ABDULHAFEZ"],
    "عبدالخالق": ["ABDULKHALEK"],
    "عبد الخالق": ["ABDULKHALEK"],
    "عبدالرازق": ["ABDULRAZEK"],
    "عبد الرازق": ["ABDULRAZEK"],
    "عبدالصمد": ["ABDULSAMAD"],
    "عبد الصمد": ["ABDULSAMAD"],
    "عبدالعال": ["ABDULAAL"],
    "عبد العال": ["ABDULAAL"],
    "عبدالغني": ["ABDULGHANY"],
    "عبد الغني": ["ABDULGHANY"],
    "عبدالقوي": ["ABDULKAWY"],
    "عبد القوي": ["ABDULKAWY"],
    "عبدالملك": ["ABDULMALIK"],
    "عبد الملك": ["ABDULMALIK"],
    "عبدالمنعم": ["ABDULMONEM"],
    "عبد المنعم": ["ABDULMONEM"],
    "عبدالهادي": ["ABDULHADI"],
    "عبد الهادي": ["ABDULHADI"],
    
    // عمر and ع names
    "عمر": ["OMAR"],
    "عمرو": ["AMRO"],
    "عثمان": ["OTHMAN", "OSMAN"],
    "علي": ["ALI"],
    "عادل": ["ADEL"],
    "عماد": ["EMAD"],
    "عصام": ["ESSAM"],
    "عزيز": ["AZIZ"],
    "عاصم": ["ASEM"],
    "عامر": ["AMER"],
    "عاطف": ["ATEF"],
    "عزام": ["AZZAM"],
    "عابد": ["ABED"],
    "عارف": ["AREF"],
    "عاكف": ["AKEF"],
    "عدنان": ["ADNAN"],
    "عزمي": ["AZMY"],
    "عكاشة": ["OKASHA"],
    "عنان": ["ANAN"],
    "عوض": ["AWAD"],
    
    // حسن/حسين and ح names
    "حسين": ["HUSSEIN", "HUSSIEN"],
    "حسن": ["HASSAN"],
    "حمزة": ["HAMZA"],
    "حسام": ["HOSSAM"],
    "حمدي": ["HAMDY"],
    "حاتم": ["HATEM"],
    "حازم": ["HAZEM"],
    "حمد": ["HAMAD"],
    "حامد": ["HAMED"],
    "حبيب": ["HABIB"],
    "حذيفة": ["HOZAIFA"],
    "حسني": ["HOSNY"],
    "حكيم": ["HAKIM"],
    "حليم": ["HALIM"],
    "حمادة": ["HAMADA"],
    "حميد": ["HAMEED"],
    "حنفي": ["HANAFI"],
    
    // ه names
    "هادي": ["HADI"],
    "هاني": ["HANI"],
    "هشام": ["HESHAM"],
    "هيثم": ["HAITHAM"],
    "همام": ["HAMAM"],
    "هلال": ["HELAL"],
    
    // خ names
    "خالد": ["KHALID", "KHALED"],
    "خليل": ["KHALIL"],
    "خليفة": ["KHALIFA"],
    "خير الدين": ["KHAIRELDIN"],
    "خيري": ["KHAIRY"],
    "خطاب": ["KHATTAB"],
    
    // ك names
    "كريم": ["KARIM", "KAREEM"],
    "كمال": ["KAMAL"],
    "كامل": ["KAMEL"],
    
    // ي names
    "يوسف": ["YOUSSEF", "YOUSEF", "YUSUF"],
    "ياسر": ["YASSER"],
    "يحيى": ["YAHYA"],
    "يزيد": ["YAZEED"],
    "ياسين": ["YASEEN"],
    "يزن": ["YAZAN"],
    "يامن": ["YAMEN"],
    
    // س names
    "سعيد": ["SAEED"],
    "سامح": ["SAMEH"],
    "سامي": ["SAMY"],
    "سالم": ["SALEM"],
    "سليم": ["SALEEM"],
    "سليمان": ["SULAIMAN", "SOLIMAN"],
    "سعد": ["SAAD"],
    "سعود": ["SAUD"],
    "سيف": ["SEIF"],
    "سراج": ["SERAG"],
    "سهيل": ["SOHAIL"],
    "سمير": ["SAMIR"],
    "سالار": ["SALAR"],
    "ساهر": ["SAHER"],
    "سفيان": ["SOFYAN"],
    "سلطان": ["SULTAN"],
    "سند": ["SANAD"],
    
    // ش names
    "شريف": ["SHERIF"],
    "شادي": ["SHADY"],
    "شاكر": ["SHAKER"],
    "شهاب": ["SHEHAB"],
    "شوقي": ["SHAWKY"],
    "شاهين": ["SHAHIN"],
    "شعبان": ["SHAABAN"],
    "شفيق": ["SHAFIK"],
    
    // ص names
    "صلاح": ["SALAH"],
    "صالح": ["SALEH"],
    "صابر": ["SABER"],
    "صادق": ["SADEK"],
    "صفوت": ["SAFWAT"],
    "صفوان": ["SAFWAN"],
    "صلاح الدين": ["SALAHUDDIN"],
    "صبحي": ["SOBHY"],
    "صبري": ["SABRY"],
    
    // ط names
    "طارق": ["TAREK", "TARIQ"],
    "طاهر": ["TAHER"],
    "طلال": ["TALAL"],
    "طلعت": ["TALAAT"],
    "طه": ["TAHA"],
    
    // ف names
    "فهد": ["FAHAD", "FAHD"],
    "فارس": ["FARES"],
    "فيصل": ["FAISAL"],
    "فاروق": ["FAROUK"],
    "فتحي": ["FATHY"],
    "فايز": ["FAYEZ"],
    "فؤاد": ["FOUAD"],
    "فهمي": ["FAHMY"],
    "فراس": ["FERAS"],
    "فادي": ["FADI"],
    "فخري": ["FAKHRY"],
    "فلاح": ["FALAH"],
    "فهيم": ["FAHEEM"],
    "فوزي": ["FAWZY"],
    
    // ن names
    "نادر": ["NADER"],
    "ناصر": ["NASSER"],
    "نبيل": ["NABIL"],
    "نواف": ["NAWAF"],
    "نايف": ["NAYEF"],
    "نزار": ["NIZAR"],
    "نصر": ["NASR"],
    "نعمان": ["NOAMAN"],
    "نوح": ["NOUH"],
    "نور الدين": ["NOURELDIN"],
    
    // ر names
    "رامي": ["RAMY"],
    "رائد": ["RAED"],
    "رضا": ["REDA"],
    "رشيد": ["RASHEED"],
    "رياض": ["RIYAD"],
    "رشاد": ["RASHAD"],
    "ربيع": ["RABIE"],
    "رمضان": ["RAMADAN"],
    "رفيق": ["RAFIK"],
    "رفعت": ["REFAAT"],
    "رجب": ["RAGAB"],
    "راشد": ["RASHED"],
    "رضوان": ["RADWAN"],
    
    // ز names
    "زكريا": ["ZAKARIA", "ZAKARIYA"],
    "زياد": ["ZIAD"],
    "زيد": ["ZAID"],
    "زاهر": ["ZAHER"],
    "زاهد": ["ZAHED"],
    "زكي": ["ZAKY"],
    "زهير": ["ZOHAIR"],
    
    // و names
    "وليد": ["WALID", "WALEED"],
    "وائل": ["WAEL"],
    "وسام": ["WESAM"],
    "وسيم": ["WASEEM"],
    "وفيق": ["WAFIK"],
    
    // د names
    "داود": ["DAWOOD"],
    "دياب": ["DIAB"],
    
    // ب names
    "بسام": ["BASSAM"],
    "بلال": ["BILAL"],
    "باسم": ["BASEM"],
    "بدر": ["BADR"],
    "بشار": ["BASHAR"],
    "بشير": ["BASHIR"],
    "بكر": ["BAKR"],
    "بهاء": ["BAHAA"],
    "براء": ["BARAA"],
    
    // ت names
    "تامر": ["TAMER"],
    "توفيق": ["TAWFIK"],
    "تيسير": ["TAYSEER"],
    "تميم": ["TAMIM"],
    "ثابت": ["THABET"],
    "ثامر": ["THAMER"],
    "ثروت": ["THARWAT"],
    
    // ج names (Egyptian pronunciation)
    "جمال": ["GAMAL"],
    "جابر": ["GABER"],
    "جمعة": ["GOMAA"],
    "جلال": ["GALAL"],
    "جهاد": ["GEHAD"],
    "جميل": ["GAMIL"],
    
    // ج names (Gulf pronunciation)
    "جاسم": ["JASEM"],
    "جعفر": ["JAFAR"],
    "جواد": ["JAWAD"],
    
    // Egyptian Specific Names
    "منصور": ["MANSOUR"],
    "منير": ["MOUNIR"],
    "مجدي": ["MAGDY"],
    "مدحت": ["MEDHAT"],
    "ممدوح": ["MAMDOUH"],
    "ميلاد": ["MILAD"],
    "مكرم": ["MAKRAM"],
    "منتصر": ["MONTASER"],
    "سيد": ["SAYED"],
    "عزت": ["EZZAT"],
    
    // Gulf Specific Names  
    "تركي": ["TURKI"],
    "بندر": ["BANDAR"],
    "مشعل": ["MISHAAL"],
    "متعب": ["MUTEB"],
    "مساعد": ["MOSAAD"],
    "مشاري": ["MISHARI"],
    "مبارك": ["MUBARAK"],
    "سلمان": ["SALMAN"],
    
    // Islamic/Prophet Names
    "إبراهيم": ["IBRAHIM"],
    "ابراهيم": ["IBRAHIM"],
    "إسماعيل": ["ISMAIL"],
    "اسماعيل": ["ISMAIL"],
    "موسى": ["MUSA", "MOUSA"],
    "عيسى": ["EISSA", "ISA"],
    "آدم": ["ADAM"],
    "ادم": ["ADAM"],
    "إدريس": ["IDRIS"],
    "ادريس": ["IDRIS"],
    "إلياس": ["ELIAS"],
    "الياس": ["ELIAS"],
    "أيوب": ["AYOUB"],
    "ايوب": ["AYOUB"],
    "شعيب": ["SHOAIB"],
    "يعقوب": ["YACOUB"],
    "يونس": ["YOUNES"],
    "هارون": ["HAROUN"],
    "لقمان": ["LOKMAN"],
    
    // Sahaba Names (Companions)
    "أبو بكر": ["ABU BAKR"],
    "ابو بكر": ["ABU BAKR"],
    "أبوبكر": ["ABU BAKR"],
    "طلحة": ["TALHA"],
    "الزبير": ["ZUBAIR"],
    "معاوية": ["MOAWIA"],
    "عمار": ["AMMAR"],
    "صهيب": ["SOHAIB"],
    
    // Modern/Contemporary Names
    "أدهم": ["ADHAM"],
    "ادهم": ["ADHAM"],
    "آسر": ["ASSER"],
    "اسر": ["ASSER"],
    "تيم": ["TEEM"],
    "ريان": ["RAYAN"],
    "زين": ["ZAIN"],
    "سيف الدين": ["SAIFUDDIN"],
    "عز الدين": ["EZZUDDIN"],
    "قيس": ["QAIS"],
    "كنان": ["KINAN"],
    "لؤي": ["LOAI"],
    "معز": ["MOEZ"],
    "نديم": ["NADEEM"],
    "هاشم": ["HASHEM"],
    
    // ========== FEMALE NAMES - COMPREHENSIVE ==========
    
    // فاطمة variations
    "فاطمة": ["FATMA", "FATIMA"],
    "فاطمه": ["FATMA", "FATIMA"],
    "فاطمة الزهراء": ["FATMA ALZAHRAA"],
    
    // عائشة and ع names
    "عائشة": ["AISHA"],
    "عائشه": ["AISHA"],
    "عزة": ["AZZA"],
    "عزه": ["AZZA"],
    "عبير": ["ABEER"],
    "عفاف": ["AFAF"],
    "علياء": ["ALIAA"],
    "عالية": ["ALIA"],
    "عزيزة": ["AZIZA"],
    "عطاء": ["ATAA"],
    "عطية": ["ATIYA"],
    
    // خ names
    "خديجة": ["KHADIJA"],
    "خديجه": ["KHADIJA"],
    "خلود": ["KHOLOUD"],
    "خولة": ["KHAWLA"],
    "ختام": ["KHETAM"],
    
    // م names
    "مريم": ["MARIAM", "MARYAM"],
    "منى": ["MONA"],
    "مني": ["MONA"],
    "منال": ["MANAL"],
    "ملك": ["MALAK"],
    "ميرفت": ["MERVAT"],
    "ماجدة": ["MAGDA"],
    "مها": ["MAHA"],
    "ميساء": ["MAYSAA"],
    "ميادة": ["MAYADA"],
    "ميار": ["MAYAR"],
    "مروة": ["MARWA"],
    "ميرنا": ["MERNA"],
    "ميرة": ["MIRA"],
    "ملاك": ["MALAK"],
    "مديحة": ["MADIHA"],
    "منيرة": ["MONIRA"],
    "مكة": ["MAKKAH"],
    "منة": ["MENNA"],
    "منة الله": ["MENNATALLAH"],
    
    // ز names
    "زينب": ["ZAINAB"],
    "زهراء": ["ZAHRAA"],
    "زهرة": ["ZAHRA"],
    "زكية": ["ZAKYA"],
    "زينة": ["ZEINA"],
    
    // س names
    "سارة": ["SARAH", "SARA"],
    "ساره": ["SARAH", "SARA"],
    "سمية": ["SOMAYA"],
    "سميه": ["SOMAYA"],
    "سلمى": ["SALMA"],
    "سلوى": ["SALWA"],
    "سعاد": ["SOUAD"],
    "سهام": ["SEHAM"],
    "سهير": ["SOHAIR"],
    "سناء": ["SANAA"],
    "سمر": ["SAMAR"],
    "سحر": ["SAHAR"],
    "سلسبيل": ["SALSABIL"],
    "سارا": ["SARA"],
    "سيرين": ["SEREEN"],
    "سجى": ["SAJA"],
    "سدرة": ["SEDRA"],
    
    // ن names
    "نور": ["NOOR", "NOUR"],
    "نورة": ["NOURA"],
    "نوره": ["NOURA"],
    "ندى": ["NADA"],
    "نجلاء": ["NAGLAA"],
    "نرمين": ["NERMIN"],
    "نهى": ["NOHA"],
    "نهال": ["NEHAL"],
    "نادية": ["NADIA"],
    "نجاة": ["NAGAT"],
    "نيفين": ["NEVEEN"],
    "نسرين": ["NESRIN"],
    "نجوى": ["NAGWA"],
    "نجمة": ["Nagma"],
    "نسيم": ["Naseem"],
    "نور الهدى": ["NOOR ALHUDA"],
    "نور الدين": ["NOOR ALDIN"],
    
    // ه names
    "هدى": ["HODA"],
    "هبة": ["HEBA"],
    "هبه": ["HEBA"],
    "هناء": ["HANAA"],
    "هنا": ["HANA"],
    "هالة": ["HALA"],
    "هند": ["HEND"],
    "هيام": ["HAYAM"],
    "هويدا": ["HOWAIDA"],
    "هاجر": ["HAGAR"],
    "هيفاء": ["HAIFA"],
    "هدية": ["HEDAYA"],
    "هادية": ["HADIA"],
    
    // أ/ا names
    "أمل": ["AMAL"],
    "امل": ["AMAL"],
    "أسماء": ["ASMAA"],
    "اسماء": ["ASMAA"],
    "آمنة": ["AMENA"],
    "امنة": ["AMENA"],
    "آية": ["AYA"],
    "ايه": ["AYA"],
    "أميرة": ["AMIRA"],
    "اميره": ["AMIRA"],
    "إيمان": ["IMAN"],
    "ايمان": ["IMAN"],
    "إسراء": ["ESRAA"],
    "اسراء": ["ESRAA"],
    "الهام": ["ELHAM"],
    "ابتسام": ["EBTESAM"],
    "ابتهال": ["EBTEHAL"],
    "امينة": ["AMINA"],
    "انتصار": ["ENTESAR"],
    "اميمة": ["OMAIMA"],
    "أروى": ["ARWA"],
    "اروى": ["ARWA"],
    "آلاء": ["ALAA"],
    "الاء": ["ALAA"],
    "إخلاص": ["EKHLAS"],
    "اخلاص": ["EKHLAS"],
    "أحلام": ["AHLAM"],
    "احلام": ["AHLAM"],
    "افنان": ["AFNAN"],
    "أفنان": ["AFNAN"],
    
    // ر names
    "رانيا": ["RANIA"],
    "رحاب": ["REHAB"],
    "رشا": ["RASHA"],
    "رحمة": ["RAHMA"],
    "ريم": ["REEM"],
    "رنا": ["RANA"],
    "روان": ["RAWAN"],
    "رقية": ["ROKAYA"],
    "رباب": ["RABAB"],
    "رضوى": ["RADWA"],
    "رغد": ["RAGHAD"],
    "روضة": ["RAWDA"],
    "رويدا": ["RUWAIDA"],
    "رهف": ["RAHAF"],
    "ريناد": ["RENAD"],
    "روزا": ["ROSA"],
    
    // ش names
    "شيماء": ["SHAIMA", "SHIMAA"],
    "شيرين": ["SHEREEN"],
    "شهد": ["SHAHD"],
    "شذى": ["SHAZA"],
    "شروق": ["SHOROUK"],
    "شمس": ["SHAMS"],
    "شادية": ["SHADIA"],
    
    // د names
    "دينا": ["DINA"],
    "دعاء": ["DOAA"],
    "دنيا": ["DONIA"],
    "ديانا": ["DIANA"],
    "دلال": ["DALAL"],
    "ديمة": ["DIMA"],
    "درة": ["DORRA"],
    
    // ل names
    "ليلى": ["LAILA", "LAYLA"],
    "ليلي": ["LAILA", "LAYLA"],
    "لمياء": ["LAMIAA"],
    "لينا": ["LINA"],
    "لبنى": ["LOBNA"],
    "لطيفة": ["LATIFA"],
    "لجين": ["LOJAIN"],
    "لمى": ["LAMA"],
    "ليان": ["LAYAN"],
    "لولوة": ["LULWA"],
    "لؤلؤة": ["LOALOA"],
    
    // ج names
    "جميلة": ["GAMILA"],
    "جيهان": ["GEHAN"],
    "جهاد": ["GEHAD"],
    "جنى": ["JANA"],
    "جوري": ["JORY"],
    "جودي": ["JUDY"],
    "جنان": ["JANAN"],
    "جواهر": ["JAWAHER"],
    "جوليا": ["JULIA"],
    
    // ح names
    "حنان": ["HANAN"],
    "حنين": ["HANEEN"],
    "حسناء": ["HASNAA"],
    "حورية": ["HOURIA"],
    "حبيبة": ["HABIBA"],
    "حفصة": ["HAFSA"],
    "حياة": ["HAYAT"],
    "حلا": ["HALA"],
    
    // ي names
    "ياسمين": ["YASMIN", "YASMEEN"],
    "يسرا": ["YOSRA"],
    "يمنى": ["YOMNA"],
    "يارا": ["YARA"],
    "يقين": ["YAKEEN"],
    
    // و names
    "وفاء": ["WAFAA"],
    "ورود": ["WOROOD"],
    "وداد": ["WEDAD"],
    "وعد": ["WAAD"],
    "ولاء": ["WALAA"],
    
    // ب names
    "بسمة": ["BASMA"],
    "بشرى": ["BOSHRA"],
    "بتول": ["BATOUL"],
    "بدور": ["BODOUR"],
    "بثينة": ["BUTHAINA"],
    "بيان": ["BAYAN"],
    "بلقيس": ["BALQIS"],
    
    // ت names
    "تسنيم": ["TASNEEM"],
    "تالا": ["TALA"],
    "تالة": ["TALA"],
    "تمارا": ["TAMARA"],
    "تقوى": ["TAKWA"],
    "تهاني": ["TAHANY"],
    
    // غ names
    "غادة": ["GHADA"],
    "غالية": ["GHALIA"],
    "غيداء": ["GHAIDA"],
    
    // ص names
    "صفاء": ["SAFAA"],
    "صفية": ["SAFIYA"],
    "صبا": ["SABA"],
    
    // ف names
    "فريدة": ["FARIDA"],
    "فاتن": ["FATEN"],
    "فوزية": ["FAWZIA"],
    "فايزة": ["FAIZA"],
    "فريال": ["FERIAL"],
    "فدوى": ["FADWA"],
    "فلة": ["FOLLA"],
    
    // ك names
    "كوثر": ["KAWTHER"],
    "كريمة": ["KARIMA"],
    "كاميليا": ["CAMELIA"],
    
    // ط names
    "طيبة": ["TAYBA"],
    
    // ========== COMPOUND NAMES ==========
    "محمد علي": ["MOHAMED ALI"],
    "أحمد علي": ["AHMED ALI"],
    "علي محمد": ["ALI MOHAMED"],
    "محمد حسن": ["MOHAMED HASSAN"],
    "أحمد محمد": ["AHMED MOHAMED"],
    "حسن علي": ["HASSAN ALI"],
    "علي حسن": ["ALI HASSAN"],
    
    // ========== FAMILY/LAST NAMES (AL) ==========
    "الأحمد": ["AL AHMED"],
    "الاحمد": ["AL AHMED"],
    "السيد": ["AL SAYED"],
    "الشريف": ["AL SHARIF"],
    "المصري": ["AL MASRY"],
    "الخليفة": ["AL KHALIFA"],
    "العلي": ["AL ALI"],
    "القحطاني": ["AL QAHTANI"],
    "العتيبي": ["AL OTAIBI"],
    "الدوسري": ["AL DOSARI"],
    "الشمري": ["AL SHAMRI"],
    "العنزي": ["AL ENEZI"],
    "الحربي": ["AL HARBI"],
    "الزهراني": ["AL ZAHRANI"],
    "الغامدي": ["AL GHAMDI"],
    "المطيري": ["AL MUTAIRI"],
    "العمري": ["AL OMARI"],
    "السعيد": ["AL SAEED"],
    "الحسن": ["AL HASSAN"],
    "الحسين": ["AL HUSSEIN"],
    "المحمد": ["AL MOHAMED"],
    "الإبراهيم": ["AL IBRAHIM"],
    "الابراهيم": ["AL IBRAHIM"],
    "السلمان": ["AL SALMAN"],
    "الرشيد": ["AL RASHEED"],
    "الفهد": ["AL FAHAD"],
    "المالك": ["AL MALEK"],
    "البدر": ["AL BADR"],
    "الحمد": ["AL HAMAD"],
    "الصالح": ["AL SALEH"],
    "الخالد": ["AL KHALED"],
    "العازمي": ["AL AZMI"],
    "المري": ["AL MARRI"],
    "الكعبي": ["AL KAABI"],
    "النعيمي": ["AL NUAIMI"],
    "الشهري": ["AL SHAHRI"],
    "القرني": ["AL QARNI"],
    "العسيري": ["AL ASIRI"],
    "البلوي": ["AL BALAWI"],
    "الجهني": ["AL JEHANI"],
    "العطوي": ["AL OTOWI"],
    "السبيعي": ["AL SUBAIE"],
    "الرويلي": ["AL RUWAILY"],
    "البقمي": ["AL BAKMI"],
    "الزعبي": ["AL ZOABI"],
    "الطائي": ["AL TAIE"],
    "التميمي": ["AL TAMIMI"],
    "الفيفي": ["AL FAIFI"],
    "الجابر": ["AL JABER"],
    "الصباح": ["AL SABAH"],
    "ال سعود": ["AL SAUD"],
    "آل سعود": ["AL SAUD"],
    "ال ثاني": ["AL THANI"],
    "آل ثاني": ["AL THANI"],
    "ال نهيان": ["AL NAHYAN"],
    "آل نهيان": ["AL NAHYAN"],
    "ال مكتوم": ["AL MAKTOUM"],
    "آل مكتوم": ["AL MAKTOUM"]
};

function pickPreferredSpelling(spellings, arabicWord) {
    if (arabicWord === "حسين") {
        return document.getElementById('husseinPreference').value;
    }
    if (arabicWord === "محمد") {
        return document.getElementById('mohamedPreference').value;
    }
    return spellings[0];
}
// ================= END NAME ENHANCEMENTS =================

function capitalizeName(text) {
    return text
        .toLowerCase()
        .split(' ')
        .map(word => word ? word.charAt(0).toUpperCase() + word.slice(1) : '')
        .join(' ');
}

function loadNamePreferences() {
    const h = localStorage.getItem('husseinPreference');
    const m = localStorage.getItem('mohamedPreference');
    if (h) document.getElementById('husseinPreference').value = h;
    if (m) document.getElementById('mohamedPreference').value = m;
}

function saveNamePreferences() {
    localStorage.setItem('husseinPreference', document.getElementById('husseinPreference').value);
    localStorage.setItem('mohamedPreference', document.getElementById('mohamedPreference').value);
}

document.addEventListener('DOMContentLoaded', () => {
    loadNamePreferences();
    document.getElementById('husseinPreference').addEventListener('change', saveNamePreferences);
    document.getElementById('mohamedPreference').addEventListener('change', saveNamePreferences);
});


function smartTransliterate(word) {
            let result = '';
            const chars = word.split('');
            
            for (let i = 0; i < chars.length; i++) {
                const char = chars[i];
                const nextChar = chars[i + 1] || '';
                const prevChar = chars[i - 1] || '';
                
                if (char === ' ') {
                    result += ' ';
                    continue;
                }
                
                // Handle special combinations
                if (char === 'س' && nextChar === 'ك' && chars[i + 2] === 'ا' && chars[i + 3] === 'ي') {
                    // سكاي = SKY
                    result += 'SKY';
                    i += 3;
                    continue;
                }
                
                if (char === 'ج' && nextChar === 'ر' && chars[i + 2] === 'و' && chars[i + 3] === 'ب') {
                    // جروب = GROUP
                    result += 'GROUP';
                    i += 3;
                    continue;
                }
                
                if (char === 'ج' && nextChar === 'ي' && chars[i + 2] === 'م' && chars[i + 3] === 'س') {
                    // جيمس = JAMES
                    result += 'JAMES';
                    i += 3;
                    continue;
                }
                
                if (char === 'ج' && nextChar === 'و' && chars[i + 2] === 'ن') {
                    // جون = JOHN
                    result += 'JOHN';
                    i += 2;
                    continue;
                }
                
                // Handle 'ج' more intelligently
                if (char === 'ج') {
                    // Check if it's likely a 'J' sound (like James, John)
                    if (nextChar === 'ي' || nextChar === 'و') {
                        result += 'J';
                    } else {
                        result += 'G';
                    }
                    continue;
                }
                
                // Handle 'ق' as 'K' for names
                if (char === 'ق') {
                    result += 'K';
                    continue;
                }
                
                // Handle double vowels
                if (char === 'و' && prevChar === 'و') {
                    result += 'O';
                    continue;
                }
                
                if (char === 'ي' && prevChar === 'ي') {
                    result += 'E';
                    continue;
                }
                
                // Handle 'ة' at the end of words
                if (char === 'ة' || char === 'ه') {
                    if (i === chars.length - 1 || chars[i + 1] === ' ') {
                        result += 'H';
                        continue;
                    }
                }
                
                // Standard transliteration
                if (arabicToEnglish[char]) {
                    result += arabicToEnglish[char];
                }
            }
            
            return result;
        }
        
        
function translateName() {
    const input = document.getElementById('inputText').value;
    const lines = input.split('\n');

    const translatedLines = lines.map(line => {
        if (!line.trim()) return '';

        // Try to match the entire line first (for compound names)
        const fullLine = line.trim();
        if (nameDictionary[fullLine]) {
            return toTitleCase(pickPreferredSpelling(nameDictionary[fullLine], fullLine));
        }

        // Split into words
        const words = fullLine.split(/\s+/);
        const translatedWords = [];
        let i = 0;
        
        while (i < words.length) {
            const word = words[i];
            
            // Check for compound names (عبد + next word)
            if (word.startsWith('عبد') && i + 1 < words.length) {
                const compound = word + ' ' + words[i + 1];
                if (nameDictionary[compound]) {
                    translatedWords.push(toTitleCase(pickPreferredSpelling(nameDictionary[compound], compound)));
                    i += 2; // Skip both words
                    continue;
                }
            }
            
            // Check if single word exists in dictionary
            if (nameDictionary[word]) {
                translatedWords.push(toTitleCase(pickPreferredSpelling(nameDictionary[word], word)));
            } else {
                // Use smart transliteration for unknown names
                translatedWords.push(toTitleCase(smartTransliterate(word)));
            }
            
            i++;
        }

        return translatedWords.join(' ');
    });

    document.getElementById('outputText').value = translatedLines.join('\n');
}

// Helper function for Title Case (First Letter Capital Only)
function toTitleCase(text) {
    return text
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}
function swapLanguages() {
            const input = document.getElementById('inputText');
            const output = document.getElementById('outputText');
            const temp = input.value;
            input.value = output.value;
            output.value = temp;
        }
        
        function copyToClipboard() {
            const output = document.getElementById('outputText');
            output.select();
            document.execCommand('copy');
            showToast('Copied to clipboard!');
        }
        
        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('outputText').value = '';
            showToast('Cleared!');
        }
        
        function downloadAsText() {
            let output = document.getElementById('outputText').value;
            if (!output.trim()) {
                showToast('Nothing to download!');
                return;
            }
            output = addTextWatermark(output);
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'translated_names.txt';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Downloaded!');
        }
        
        // Date Converter Functions
        function convertToHijri() {
            const gregorianInput = document.getElementById('gregorianInput').value;
            if (!gregorianInput) {
                showToast('Please select a Gregorian date!');
                return;
            }
            
            const gregorianDate = moment(gregorianInput, 'YYYY-MM-DD');
            const hijriMonthNames = [
                'Muharram', 'Safar', 'Rabi al-Awwal', 'Rabi al-Thani',
                'Jumada al-Awwal', 'Jumada al-Thani', 'Rajab', "Sha'ban",
                'Ramadan', 'Shawwal', "Dhu al-Qi'dah", 'Dhu al-Hijjah'
            ];
            const hijriDay = gregorianDate.iDate();
            const hijriMonthIndex = gregorianDate.iMonth();
            const hijriYear = gregorianDate.iYear();
            const hijriMonthName = hijriMonthNames[hijriMonthIndex];
            const hijriDateFormatted = hijriDay + ' ' + hijriMonthName + ' ' + hijriYear;
            const dayName = gregorianDate.format('dddd');
            
            const resultBox = document.getElementById('hijriResult');
            const dateElement = document.getElementById('hijriDate');
            
            // Check if Thursday or Friday
            if (dayName === 'Thursday' || dayName === 'Friday') {
                resultBox.classList.add('weekend');
                dateElement.innerHTML = `${hijriDateFormatted}<br>${dayName} <span class="weekend-badge">(WEEK END)</span>`;
            } else {
                resultBox.classList.remove('weekend');
                dateElement.innerHTML = `${hijriDateFormatted}<br>${dayName}`;
            }
            
            resultBox.style.display = 'block';
        }
        
        function convertToGregorian() {
            const day = document.getElementById('hijriDay').value;
            const month = document.getElementById('hijriMonth').value;
            const year = document.getElementById('hijriYear').value;
            
            if (!day || !month || !year) {
                showToast('Please fill all Hijri date fields!');
                return;
            }
            
            if (day < 1 || day > 30) {
                showToast('Day must be between 1 and 30!');
                return;
            }
            
            if (year < 1) {
                showToast('Please enter a valid year!');
                return;
            }
            
            const hijriDate = moment(`${year}/${month}/${day}`, 'iYYYY/iM/iD');
            const gregorianFormatted = hijriDate.format('DD/MM/YYYY');
            const dayName = hijriDate.format('dddd');
            
            const resultBox = document.getElementById('gregorianResult');
            const dateElement = document.getElementById('gregorianDate');
            
            // Check if Thursday or Friday
            if (dayName === 'Thursday' || dayName === 'Friday') {
                resultBox.classList.add('weekend');
                dateElement.innerHTML = `${gregorianFormatted}<br>${dayName} <span class="weekend-badge">(WEEK END)</span>`;
            } else {
                resultBox.classList.remove('weekend');
                dateElement.innerHTML = `${gregorianFormatted}<br>${dayName}`;
            }
            
            resultBox.style.display = 'block';
        }
        
        // Universal copy value function
        function copyValue(elementId) {
            const value = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(value).then(() => {
                showToast('Copied: ' + value);
            });
        }
        
        // VAT Calculator
        function calculateVATFromIncluding() {
            const amount = parseFloat(document.getElementById('vatAmount').value);
            const result = document.getElementById('vatResult');
            
            // Clear the other input
            document.getElementById('vatAmountExcluding').value = '';
            
            if (!amount || amount <= 0) {
                result.style.display = 'none';
                return;
            }
            
            const withoutVat = (amount * 100) / 115;
            const vatOnly = amount - withoutVat;
            
            document.getElementById('vatWithout').textContent = withoutVat.toFixed(2);
            document.getElementById('vatWith').textContent = amount.toFixed(2);
            document.getElementById('vatOnly').textContent = vatOnly.toFixed(2);
            
            // Show only "Amount Without VAT" and "VAT Amount" (hide "Amount With VAT")
            document.getElementById('vatWithout').closest('.result-item').style.display = 'flex';
            document.getElementById('vatWith').closest('.result-item').style.display = 'none';
            document.getElementById('vatOnly').closest('.result-item').style.display = 'flex';
            
            result.style.display = 'block';
        }
        
        function calculateVATFromExcluding() {
            const amount = parseFloat(document.getElementById('vatAmountExcluding').value);
            const result = document.getElementById('vatResult');
            
            // Clear the other input
            document.getElementById('vatAmount').value = '';
            
            if (!amount || amount <= 0) {
                result.style.display = 'none';
                return;
            }
            
            const withVat = amount * 1.15;
            const vatOnly = withVat - amount;
            
            document.getElementById('vatWithout').textContent = amount.toFixed(2);
            document.getElementById('vatWith').textContent = withVat.toFixed(2);
            document.getElementById('vatOnly').textContent = vatOnly.toFixed(2);
            
            // Show only "Amount With VAT" and "VAT Amount" (hide "Amount Without VAT")
            document.getElementById('vatWithout').closest('.result-item').style.display = 'none';
            document.getElementById('vatWith').closest('.result-item').style.display = 'flex';
            document.getElementById('vatOnly').closest('.result-item').style.display = 'flex';
            
            result.style.display = 'block';
        }
        
        // Keep old function for backward compatibility
        function calculateVAT() {
            calculateVATFromIncluding();
        }
        
        // Meals Calculator
        function calculateMeals() {
            const price = parseFloat(document.getElementById('mealPrice').value);
            const days = parseFloat(document.getElementById('mealDays').value);
            const result = document.getElementById('mealsResult');
            
            if (!price || !days || price <= 0 || days <= 0) {
                result.style.display = 'none';
                return;
            }
            
            const withVat = price * days;
            const withoutVat = (withVat * 100) / 115 + 0.01;
            
            document.getElementById('mealsWithVat').textContent = withVat.toFixed(2);
            document.getElementById('mealsWithoutVat').textContent = withoutVat.toFixed(2);
            result.style.display = 'block';
        }
        
        // Nights Calculator
        function calculateNights() {
            const checkIn = document.getElementById('checkInDate').value;
            const checkOut = document.getElementById('checkOutDate').value;
            
            if (!checkIn || !checkOut) {
                document.getElementById('nightsValue').textContent = '0';
                document.getElementById('weekdayValue').textContent = '0';
                document.getElementById('weekendValue').textContent = '0';
                return;
            }
            
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            
            // Calculate difference in milliseconds
            const diffTime = checkOutDate - checkInDate;
            
            // Convert to days
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Ensure it's not negative
            const nights = diffDays > 0 ? diffDays : 0;
            
            // Calculate weekday and weekend nights
            let weekdayNights = 0;
            let weekendNights = 0;
            
            if (nights > 0) {
                // Iterate through each night
                const currentDate = new Date(checkInDate);
                
                for (let i = 0; i < nights; i++) {
                    const dayOfWeek = currentDate.getDay();
                    
                    // Weekend is Thursday (4) and Friday (5)
                    // Weekday is Saturday (6), Sunday (0), Monday (1), Tuesday (2), Wednesday (3)
                    if (dayOfWeek === 4 || dayOfWeek === 5) {
                        weekendNights++;
                    } else {
                        weekdayNights++;
                    }
                    
                    // Move to next day
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            // Display results
            document.getElementById('nightsValue').textContent = nights;
            document.getElementById('weekdayValue').textContent = weekdayNights;
            document.getElementById('weekendValue').textContent = weekendNights;
        }
        
        // Business Calculator
        // Package Calculator
        function calculatePackage() {
            const total  = parseFloat(document.getElementById('pkgTotal').value);
            const nights = parseFloat(document.getElementById('pkgNights').value);
            const resultEl = document.getElementById('pkgNightRate');

            if (!isNaN(total) && !isNaN(nights) && nights > 0) {
                const raw = total / nights;
                // Only add 0.01 if the result has decimal fractions
                const hasDecimal = (raw % 1) !== 0;
                const nightRate  = hasDecimal
                    ? Math.round((raw + 0.01) * 100) / 100
                    : raw;
                resultEl.textContent = nightRate.toFixed(2);
                resultEl.classList.add('positive');
                resultEl.classList.remove('negative');
            } else {
                resultEl.textContent = '0.00';
            }
        }

        // Housing Ratio Calculator — smart unified version
        function calculateHousingRatioSmart() {
            const totalRooms = parseFloat(document.getElementById('hrTotalRooms').value);
            const totalPax   = parseFloat(document.getElementById('hrTotalPax').value);
            const ratio      = parseFloat(document.getElementById('hrRatio').value);
            const labelEl    = document.getElementById('hrResultLabel');
            const valueEl    = document.getElementById('hrResultValue');
            const iconsEl    = document.getElementById('hrBedIcons');

            const hasPax   = !isNaN(totalPax)   && totalPax > 0;
            const hasRooms = !isNaN(totalRooms)  && totalRooms > 0;
            const hasRatio = !isNaN(ratio)        && ratio > 0;

            // Store both for layout engine regardless of ratio
            if (hasPax)   { window._hrComputedPax   = totalPax; }
            if (hasRooms) { window._hrComputedRooms  = totalRooms; }

            if (hasPax && hasRatio) {
                const roomTotal = Math.floor(totalPax / ratio);
                labelEl.textContent = 'TOTAL ROOM إجمالي الغرف';
                valueEl.textContent = roomTotal;
                iconsEl.textContent = '';
                valueEl.classList.add('positive');
                window._hrComputedRooms = roomTotal;
                window._hrComputedPax   = totalPax;
            } else if (hasRooms && hasRatio) {
                const paxTotal = Math.floor(totalRooms * ratio);
                labelEl.textContent = 'PAX TOTAL - إجمالي الأشخاص:';
                valueEl.textContent = paxTotal;
                iconsEl.textContent = '';
                valueEl.classList.add('positive');
                window._hrComputedPax   = paxTotal;
                window._hrComputedRooms = totalRooms;
            } else if (hasRooms && hasPax) {
                // Both entered, show the ratio
                const computedRatio = (totalPax / totalRooms).toFixed(2);
                labelEl.textContent = 'RATIO (PAX/ROOM) النسبة:';
                valueEl.textContent = computedRatio;
                iconsEl.textContent = '';
                valueEl.classList.add('positive');
            } else {
                labelEl.textContent = 'RESULT:';
                valueEl.textContent = '0';
                iconsEl.textContent = '';
            }
        }

        // Keep old name as alias for ratio input oninput
        function calculateHousingRatio() { calculateHousingRatioSmart(); }
        function clearHrPax() {}   // no-op, kept for any stale references
        function clearHrRooms() {} // no-op


        // ===== Room Layout Logic =====
        (function initRoomLayoutDrag() {
            let dragSrc = null;

            function updatePriorityBadges() {
                const boxes = document.querySelectorAll('#roomLayoutBoxes .room-type-box');
                boxes.forEach((box, i) => {
                    const badge = box.querySelector('.priority-badge');
                    if (badge) badge.textContent = i + 1;
                });
            }

            function attachDragEvents() {
                const boxes = document.querySelectorAll('#roomLayoutBoxes .room-type-box');
                boxes.forEach(box => {
                    box.addEventListener('dragstart', function(e) {
                        dragSrc = this;
                        this.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    box.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                        document.querySelectorAll('.room-type-box').forEach(b => b.classList.remove('drag-over'));
                        updatePriorityBadges();
                        calculateRoomLayout();
                    });
                    box.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        if (this !== dragSrc) {
                            document.querySelectorAll('.room-type-box').forEach(b => b.classList.remove('drag-over'));
                            this.classList.add('drag-over');
                        }
                    });
                    box.addEventListener('dragleave', function() {
                        this.classList.remove('drag-over');
                    });
                    box.addEventListener('drop', function(e) {
                        e.preventDefault();
                        if (this !== dragSrc) {
                            const container = document.getElementById('roomLayoutBoxes');
                            const allBoxes = Array.from(container.querySelectorAll('.room-type-box'));
                            const srcIdx = allBoxes.indexOf(dragSrc);
                            const tgtIdx = allBoxes.indexOf(this);
                            if (srcIdx < tgtIdx) {
                                container.insertBefore(dragSrc, this.nextSibling);
                            } else {
                                container.insertBefore(dragSrc, this);
                            }
                            this.classList.remove('drag-over');
                        }
                    });
                });
            }

            // Init on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    attachDragEvents();
                    updatePriorityBadges();
                    // Style checked state on load
                    document.querySelectorAll('.room-type-checkbox').forEach(chk => {
                        chk.addEventListener('change', function() {
                            const box = this.closest('.room-type-box');
                            box.classList.toggle('checked', this.checked);
                        });
                    });
                });
            } else {
                attachDragEvents();
                updatePriorityBadges();
                document.querySelectorAll('.room-type-checkbox').forEach(chk => {
                    chk.addEventListener('change', function() {
                        const box = this.closest('.room-type-box');
                        box.classList.toggle('checked', this.checked);
                    });
                });
            }
        })();

        function clearHousingRatio() {
            document.getElementById('hrTotalRooms').value = '';
            document.getElementById('hrTotalPax').value = '';
            document.getElementById('hrRatio').value = '';
            document.getElementById('hrResultLabel').textContent = 'RESULT:';
            document.getElementById('hrResultValue').textContent = '0';
            document.getElementById('hrBedIcons').textContent = '';
            window._hrComputedRooms = 0;
            window._hrComputedPax = 0;
            window._currentAllocation = null;
            window._allLayouts = [];
            const resultSection = document.getElementById('layoutResult');
            if (resultSection) resultSection.style.display = 'none';
            const msgEl = document.getElementById('layoutMessage');
            if (msgEl) { msgEl.innerHTML = ''; msgEl.style.display = 'none'; }
        }

        // Store all valid alternative layouts
        window._allLayouts = [];
        window._layoutIndex = 0;

        function showNextLayout() {
            if (!window._allLayouts || window._allLayouts.length <= 1) return;
            window._layoutIndex = (window._layoutIndex + 1) % window._allLayouts.length;
            renderLayoutAlloc(window._allLayouts[window._layoutIndex]);
            const btn = document.getElementById('nextLayoutBtn');
            if (btn) btn.textContent = `🔄 Layout ${window._layoutIndex + 1}/${window._allLayouts.length} - توزيع آخر`;
        }

        /* ═══════════════════════════════════════════════════════
           SMART ROOM LAYOUT ENGINE
           ═══════════════════════════════════════════════════════ */

        // Render the allocation rows with editable inputs + smart messages
        function renderLayoutAlloc(allocation) {
            const resultRows = document.getElementById('layoutResultRows');
            const msgEl      = document.getElementById('layoutMessage');
            const targetPax  = (parseInt(document.getElementById('hrTotalPax').value) || 0)
                             || (window._hrComputedPax || 0);
            const targetRooms = (parseInt(document.getElementById('hrTotalRooms').value) || 0)
                             || (window._hrComputedRooms || 0);

            const totalAllocPax   = allocation.reduce((s, a) => s + a.count * a.pax, 0);
            const totalAllocRooms = allocation.reduce((s, a) => s + a.count, 0);
            const paxDiff         = totalAllocPax - targetPax;

            // Render rows
            resultRows.innerHTML = allocation.map((a, i) => `
                <div class="layout-result-row" id="layoutRow_${i}">
                    <span class="layout-result-type">${a.type}</span>
                    <input type="number"
                        id="layoutOverride_${i}"
                        value="${a.count}"
                        min="0"
                        oninput="applyLayoutOverride(${i})"
                        style="width:62px; padding:4px 8px; border-radius:7px; border:2px solid rgba(255,255,255,0.4); background:rgba(255,255,255,0.18); color:#fff; font-size:1rem; font-weight:800; text-align:center; outline:none;"
                        title="Edit rooms for ${a.type}"
                    >
                    <span class="layout-result-count">&nbsp;rooms</span>
                    <span class="layout-result-pax" id="layoutPaxLabel_${i}">= ${a.count * a.pax} pax</span>
                </div>
            `).join('') + `
                <div class="layout-result-row" style="background:rgba(255,255,255,0.22); margin-top:4px;">
                    <span class="layout-result-type">TOTAL</span>
                    <span class="layout-result-count" id="layoutTotalRooms">${totalAllocRooms} rooms</span>
                    <span class="layout-result-pax" id="layoutTotalPax">= ${totalAllocPax} pax ${_paxBadge(paxDiff, targetPax)}</span>
                </div>`;

            // Smart status message
            _updateLayoutMessage(paxDiff, totalAllocRooms, targetRooms, targetPax, allocation);

            // Store live allocation
            window._currentAllocation = allocation.map(a => ({...a}));
        }

        function _paxBadge(diff, target) {
            if (diff === 0) return '✅';
            const sign = diff > 0 ? '+' : '';
            const color = Math.abs(diff) <= 2 ? '#fbbf24' : '#f87171';
            return `<span style="color:${color}">(${sign}${diff} pax)</span>`;
        }

        function _updateLayoutMessage(paxDiff, allocRooms, targetRooms, targetPax, allocation) {
            const msgEl = document.getElementById('layoutMessage');
            if (!msgEl) return;
            msgEl.innerHTML = '';
            msgEl.style.display = 'none';

            const msgs = [];

            // Pax mismatch messages
            if (paxDiff > 0) {
                msgs.push({
                    icon: '🛏️',
                    color: '#fbbf24',
                    text: `You have <strong>${paxDiff} additional bed${paxDiff>1?'s':''}</strong> (${paxDiff} extra PAX capacity). Consider adjusting room types or reducing a room.`
                });
            } else if (paxDiff < 0) {
                const needed = Math.abs(paxDiff);
                msgs.push({
                    icon: '⚠️',
                    color: '#f87171',
                    text: `<strong>${needed} PAX unaccommodated!</strong> You need ${needed} more bed${needed>1?'s':''}. Add rooms or switch to a higher-capacity type.`
                });
            }

            // Rooms mismatch (when both rooms & pax were specified)
            if (targetRooms > 0 && allocRooms !== targetRooms) {
                const roomDiff = allocRooms - targetRooms;
                if (roomDiff > 0) {
                    msgs.push({
                        icon: '🏨',
                        color: '#fbbf24',
                        text: `Using <strong>${roomDiff} more room${roomDiff>1?'s':''}</strong> than your total rooms input (${targetRooms}). Check your distribution.`
                    });
                } else {
                    const short = Math.abs(roomDiff);
                    msgs.push({
                        icon: '🏨',
                        color: '#f87171',
                        text: `<strong>${short} more room${short>1?'s':''} needed!</strong> Current rooms (${allocRooms}) are less than target (${targetRooms}). Add ${short} room${short>1?'s':''} to your layout.`
                    });
                }
            }

            // Exact match celebration
            if (paxDiff === 0 && (targetRooms === 0 || allocRooms === targetRooms)) {
                msgs.push({
                    icon: '🎯',
                    color: '#34d399',
                    text: `<strong>Perfect match!</strong> All ${targetPax} PAX accommodated in ${allocRooms} rooms.`
                });
            }

            if (msgs.length > 0) {
                msgEl.style.display = 'block';
                msgEl.innerHTML = msgs.map(m => `
                    <div style="display:flex; align-items:flex-start; gap:8px; padding:8px 12px; background:rgba(0,0,0,0.18); border-left:3px solid ${m.color}; border-radius:6px; margin-bottom:6px; font-size:0.82rem; line-height:1.4; color:#fff;">
                        <span style="font-size:1rem; flex-shrink:0;">${m.icon}</span>
                        <span>${m.text}</span>
                    </div>`).join('');
            }
        }

        // When user manually edits a room count input
        function applyLayoutOverride(changedIdx) {
            if (!window._currentAllocation) return;
            const alloc = window._currentAllocation;
            const newCount = parseInt(document.getElementById('layoutOverride_' + changedIdx).value) || 0;

            // Compute how many rooms are left for the OTHER types
            const targetRooms = (parseInt(document.getElementById('hrTotalRooms').value) || 0)
                              || (window._hrComputedRooms || 0);
            const targetPax   = (parseInt(document.getElementById('hrTotalPax').value) || 0)
                              || (window._hrComputedPax || 0);

            // Update changed type
            alloc[changedIdx].count = newCount;

            // If we have a target room count, redistribute remaining rooms to OTHER types
            // using the same priority-aware solver (higher index = lower priority)
            if (targetRooms > 0) {
                const usedRooms  = newCount;
                const otherTypes = alloc.filter((_, i) => i !== changedIdx);
                const remaining  = targetRooms - usedRooms;

                if (remaining > 0 && otherTypes.length > 0) {
                    // Redistribute remaining rooms to other types smartly
                    // Try to match remaining pax as closely as possible
                    const remainingPax = targetPax - newCount * alloc[changedIdx].pax;
                    const redistributed = _smartDistribute(otherTypes, remaining, remainingPax);
                    let ri = 0;
                    alloc.forEach((a, i) => {
                        if (i !== changedIdx) {
                            a.count = redistributed[ri] || 0;
                            ri++;
                        }
                    });
                } else if (remaining <= 0) {
                    // No rooms left — set all others to 0
                    alloc.forEach((a, i) => { if (i !== changedIdx) a.count = 0; });
                }
            }

            // Update all input fields and pax labels
            alloc.forEach((a, i) => {
                const inp = document.getElementById('layoutOverride_' + i);
                if (inp && i !== changedIdx) inp.value = a.count;
                const lbl = document.getElementById('layoutPaxLabel_' + i);
                if (lbl) lbl.textContent = '= ' + (a.count * a.pax) + ' pax';
            });

            // Update totals
            const totalAllocPax   = alloc.reduce((s, a) => s + a.count * a.pax, 0);
            const totalAllocRooms = alloc.reduce((s, a) => s + a.count, 0);
            const paxDiff         = totalAllocPax - targetPax;

            document.getElementById('layoutTotalRooms').textContent = totalAllocRooms + ' rooms';
            document.getElementById('layoutTotalPax').innerHTML =
                '= ' + totalAllocPax + ' pax ' + _paxBadge(paxDiff, targetPax);

            // Update smart messages
            _updateLayoutMessage(paxDiff, totalAllocRooms, targetRooms, targetPax, alloc);
        }

        // Distribute `rooms` among `types` to best match `targetPax`, no priority constraint
        function _smartDistribute(types, rooms, targetPax) {
            if (types.length === 0) return [];
            if (types.length === 1) return [rooms];

            const n = types.length;
            const allocs = [];
            const seen = new Set();

            function solve(idx, rem, current) {
                if (idx === n - 1) {
                    const cnt = rem;
                    if (cnt >= 0) {
                        const key = [...current, cnt].join(',');
                        if (!seen.has(key)) { seen.add(key); allocs.push([...current, cnt]); }
                    }
                    return;
                }
                const maxC = rem;
                for (let c = maxC; c >= 0; c--) {
                    solve(idx + 1, rem - c, [...current, c]);
                    if (allocs.length > 500) return; // cap
                }
            }
            solve(0, rooms, []);

            if (allocs.length === 0) {
                // fallback: split evenly
                const base = Math.floor(rooms / n);
                const extra = rooms % n;
                return types.map((_, i) => base + (i < extra ? 1 : 0));
            }

            // Pick the one closest to targetPax
            allocs.sort((a, b) => {
                const pA = a.reduce((s, c, i) => s + c * types[i].pax, 0);
                const pB = b.reduce((s, c, i) => s + c * types[i].pax, 0);
                return Math.abs(pA - targetPax) - Math.abs(pB - targetPax);
            });
            return allocs[0];
        }

        function calculateRoomLayout() {
            const inputRooms = parseInt(document.getElementById('hrTotalRooms').value) || 0;
            const inputPax   = parseInt(document.getElementById('hrTotalPax').value) || 0;
            let totalRooms   = inputRooms || (window._hrComputedRooms || 0);
            let totalPax     = inputPax   || (window._hrComputedPax   || 0);

            const boxes = Array.from(document.querySelectorAll('#roomLayoutBoxes .room-type-box'));
            const selected = boxes
                .filter(b => b.querySelector('.room-type-checkbox').checked)
                .map(b => ({ type: b.dataset.type, pax: parseInt(b.dataset.pax) }));

            const resultSection = document.getElementById('layoutResult');
            const nextBtn       = document.getElementById('nextLayoutBtn');

            // Case: only PAX entered (no rooms, no ratio) → estimate rooms from types
            if (totalPax > 0 && totalRooms === 0 && selected.length > 0) {
                const avgPax = selected.reduce((s, t) => s + t.pax, 0) / selected.length;
                totalRooms = Math.round(totalPax / avgPax);
                window._hrComputedRooms = totalRooms;
            }

            if (selected.length === 0 || totalRooms === 0 || totalPax === 0) {
                if (resultSection) resultSection.style.display = 'none';
                return;
            }

            const rooms = totalRooms;
            const pax   = totalPax;

            // Minimum rooms needed to accommodate all pax
            const maxPaxPerRoom = Math.max(...selected.map(t => t.pax));
            const minRoomsNeeded = Math.ceil(pax / maxPaxPerRoom);

            // Check if rooms are enough at all
            const msgEl = document.getElementById('layoutMessage');

            if (rooms < selected.length) {
                // Not even 1 room per type
                if (resultSection) resultSection.style.display = 'none';
                return;
            }

            // Collect ALL valid allocations (priority order: count[i] >= count[i+1])
            const allValidAllocs = [];

            if (selected.length === 1) {
                allValidAllocs.push([rooms]);
            } else {
                const n = selected.length;
                const seen = new Set();
                function solve(idx, remRooms, current) {
                    if (idx === n - 1) {
                        const cnt = remRooms;
                        const prevCount = current.length > 0 ? current[current.length - 1] : rooms;
                        if (cnt >= 1 && cnt <= prevCount) {
                            const key = [...current, cnt].join(',');
                            if (!seen.has(key)) { seen.add(key); allValidAllocs.push([...current, cnt]); }
                        }
                        return;
                    }
                    const prevCount = current.length > 0 ? current[current.length - 1] : rooms;
                    const remaining_types = n - idx - 1;
                    const maxC = Math.min(prevCount, remRooms - remaining_types);
                    for (let c = maxC; c >= 1; c--) {
                        solve(idx + 1, remRooms - c, [...current, c]);
                        if (allValidAllocs.length > 2000) return;
                    }
                }
                solve(0, rooms, []);

                allValidAllocs.sort((a, b) => {
                    const paxA = a.reduce((s, c, i) => s + c * selected[i].pax, 0);
                    const paxB = b.reduce((s, c, i) => s + c * selected[i].pax, 0);
                    const diffA = Math.abs(paxA - pax);
                    const diffB = Math.abs(paxB - pax);
                    if (diffA !== diffB) return diffA - diffB;
                    return (Math.max(...a) - Math.min(...a)) - (Math.max(...b) - Math.min(...b));
                });
            }

            const layoutObjects = allValidAllocs.map(counts =>
                selected.map((t, i) => ({ ...t, count: counts[i] }))
            );

            if (layoutObjects.length === 0) {
                const base = Math.floor(rooms / selected.length);
                const extra = rooms - base * selected.length;
                layoutObjects.push(selected.map((t, i) => ({ ...t, count: base + (i < extra ? 1 : 0) })));
            }

            window._allLayouts   = layoutObjects;
            window._layoutIndex  = 0;

            if (nextBtn) {
                if (layoutObjects.length > 1) {
                    nextBtn.style.display = 'flex';
                    nextBtn.textContent = `🔄 Layout 1/${layoutObjects.length} - توزيع آخر`;
                } else {
                    nextBtn.style.display = 'none';
                }
            }

            renderLayoutAlloc(layoutObjects[0]);
            resultSection.style.display = 'block';
        }
        // ===== END Room Layout Logic =====

        function calculateBusiness() {
            const cost = parseFloat(document.getElementById('businessCost').value) || 0;
            const sell = parseFloat(document.getElementById('businessSell').value) || 0;
            
            const profit = sell - cost;
            const profitElement = document.getElementById('businessProfit');
            const resultBox = document.getElementById('businessResult');
            
            profitElement.textContent = profit.toFixed(2);
            
            if (profit < 0) {
                profitElement.classList.add('negative');
                profitElement.classList.remove('positive');
                resultBox.classList.add('loss');
            } else {
                profitElement.classList.add('positive');
                profitElement.classList.remove('negative');
                resultBox.classList.remove('loss');
            }
        }
        
        // Reservation Counter Functions
        function addReservationBox() {
            const container = document.getElementById('reservationBoxes');
            const div = document.createElement('div');
            div.className = 'reservation-item';
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
            div.innerHTML = `
                <input type="number" class="reservation-input" placeholder="0" oninput="calculateReservationTotal()" style="flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem;">
                <button onclick="removeReservationBox(this)" style="background: var(--error); color: white; border: none; border-radius: 8px; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem;">✕</button>
            `;
            container.appendChild(div);
            calculateReservationTotal();
        }
        
        function removeReservationBox(btn) {
            const container = document.getElementById('reservationBoxes');
            if (container.children.length > 1) {
                btn.parentElement.remove();
                calculateReservationTotal();
            } else {
                showToast('Cannot remove the last box!');
            }
        }
        
        function calculateReservationTotal() {
            const inputs = document.querySelectorAll('.reservation-input');
            let total = 0;
            
            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            document.getElementById('reservationTotal').textContent = total;
        }
        
        // Flat Rate Calculators
        function calculateFlatRate1() {
            const wdPrice = parseFloat(document.getElementById('wdPrice').value) || 0;
            const wdDays = parseFloat(document.getElementById('wdDays').value) || 0;
            const wePrice = parseFloat(document.getElementById('wePrice').value) || 0;
            const weDays = parseFloat(document.getElementById('weDays').value) || 0;
            
            const total = (wdPrice * wdDays) + (wePrice * weDays);
            const totalDays = wdDays + weDays;
            const flatRate = totalDays > 0 ? Math.round(total / totalDays) : 0;
            
            document.getElementById('flatRate1').textContent = flatRate;
        }
        
        function copyFlatRate1() {
            const value = document.getElementById('flatRate1').textContent;
            navigator.clipboard.writeText(value).then(() => {
                showToast('Flat rate copied: ' + value);
            });
        }
        
        function calculateFlatRate2() {
            const dayItems = document.querySelectorAll('#dailyPricesList .day-item');
            let total = 0;
            let count = 0;
            
            dayItems.forEach(item => {
                const price = parseFloat(item.querySelector('.day-price').value) || 0;
                if (price > 0) {
                    total += price;
                    count++;
                }
            });
            
            const flatRate = count > 0 ? Math.round(total / count) : 0;
            document.getElementById('flatRate2').textContent = flatRate;
        }
        
        function copyFlatRate2() {
            const value = document.getElementById('flatRate2').textContent;
            navigator.clipboard.writeText(value).then(() => {
                showToast('Flat rate copied: ' + value);
            });
        }
        
        
function addDayItem() {
    const list = document.getElementById('dailyPricesList');
    const lastItem = list.lastElementChild;
    const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

    let nextDay = "Saturday";

    if (lastItem) {
        const lastSelect = lastItem.querySelector('.day-select');
        const currentIndex = days.indexOf(lastSelect.value);
        nextDay = days[(currentIndex + 1) % days.length];
    }

    const div = document.createElement('div');
    div.className = 'day-item';
    div.innerHTML = `
        <select class="day-select" onchange="updateDaySequence(this)">
            ${days.map(d => `<option value="${d}" ${d === nextDay ? 'selected' : ''}>${d}</option>`).join('')}
        </select>
        <input type="number" class="day-price" placeholder="Price" oninput="calculateFlatRate2()">
        <button class="remove-day-btn" onclick="removeDayItem(this)">✕</button>
    `;
    list.appendChild(div);
}

function updateDaySequence(changedSelect) {
    const days = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const list = document.getElementById('dailyPricesList');
    const allItems = Array.from(list.querySelectorAll('.day-item'));
    const changedItem = changedSelect.closest('.day-item');
    const changedIndex = allItems.indexOf(changedItem);
    const selectedDay = changedSelect.value;
    const selectedDayIndex = days.indexOf(selectedDay);
    
    // Update previous items (going backwards)
    for (let i = changedIndex - 1; i >= 0; i--) {
        const prevSelect = allItems[i].querySelector('.day-select');
        const stepsBack = changedIndex - i;
        const prevDayIndex = (selectedDayIndex - stepsBack + 7) % 7;
        prevSelect.value = days[prevDayIndex];
    }
    
    // Update next items (going forwards)
    for (let i = changedIndex + 1; i < allItems.length; i++) {
        const nextSelect = allItems[i].querySelector('.day-select');
        const stepsForward = i - changedIndex;
        const nextDayIndex = (selectedDayIndex + stepsForward) % 7;
        nextSelect.value = days[nextDayIndex];
    }
}
function removeDayItem(btn) {
            const list = document.getElementById('dailyPricesList');
            if (list.children.length > 1) {
                btn.parentElement.remove();
                calculateFlatRate2();
            } else {
                showToast('Cannot remove the last day!');
            }
        }
        
        // Rooming List Functions
        function addRoomingRow() {
            const list = document.getElementById('roomingList');
            const newRow = document.createElement('div');
            newRow.className = 'rooming-row';
            newRow.innerHTML = `
                <input type="text" class="guest-name" placeholder="Guest Name">
                <input type="number" class="room-number" placeholder="Rooms" min="1">
                
<input list="roomTypes" class="room-type" placeholder="Room Type">
<datalist id="roomTypes">
  <option value="SGL"><option value="DBL"><option value="TRPL"><option value="QUAD">
  <option value="QUIENT"><option value="STUDIO">
  <option value="1B SUITE"><option value="2B SUITE"><option value="3B SUITE">
  <option value="ROYAL SUITE">
  <option value="1B APARTMENT"><option value="2B APARTMENT"><option value="3B APARTMENT">
</datalist>

<input list="mealTypes" class="meal-type" placeholder="Meal Type">
<datalist id="mealTypes">
  <option value="R.O"><option value="B.B"><option value="H.B"><option value="F.B">
</datalist>

<input list="viewTypes" class="view-type" placeholder="View Type">
<datalist id="viewTypes">
  <option value="C.V"><option value="N.V"><option value="K.V"><option value="H.V">
  <option value="PARTIAL K.V"><option value="PARTIAL H.V"><option value="PREMIER K.V">
</datalist>

                <button class="remove-day-btn" onclick="removeRoomingRow(this)">✕</button>
            `;
            list.appendChild(newRow);
        }
        
        function removeRoomingRow(btn) {
            const list = document.getElementById('roomingList');
            if (list.children.length > 1) {
                btn.parentElement.remove();
            } else {
                showToast('Cannot remove the last row!');
            }
        }
        
        function clearRoomingList() {
            if (confirm('Are you sure you want to clear all rooming data?')) {
                const list = document.getElementById('roomingList');
                list.innerHTML = `
                    <div class="rooming-row">
                        <input type="text" class="guest-name" placeholder="Guest Name">
                        <input type="number" class="room-number" placeholder="Rooms" min="1">
                        
<input list="roomTypes" class="room-type" placeholder="Room Type">
<datalist id="roomTypes">
  <option value="SGL"><option value="DBL"><option value="TRPL"><option value="QUAD">
  <option value="QUIENT"><option value="STUDIO">
  <option value="1B SUITE"><option value="2B SUITE"><option value="3B SUITE">
  <option value="ROYAL SUITE">
  <option value="1B APARTMENT"><option value="2B APARTMENT"><option value="3B APARTMENT">
</datalist>

<input list="mealTypes" class="meal-type" placeholder="Meal Type">
<datalist id="mealTypes">
  <option value="R.O"><option value="B.B"><option value="H.B"><option value="F.B">
</datalist>

<input list="viewTypes" class="view-type" placeholder="View Type">
<datalist id="viewTypes">
  <option value="C.V"><option value="N.V"><option value="K.V"><option value="H.V">
  <option value="PARTIAL K.V"><option value="PARTIAL H.V"><option value="PREMIER K.V">
</datalist>

                        <button class="remove-day-btn" onclick="removeRoomingRow(this)">✕</button>
                    </div>
                `;
                document.getElementById('roomingPreview').style.display = 'none';
                showToast('Rooming list cleared!');
            }
        }
        
        function generateRoomingPreview(silent) {
            const rows = document.querySelectorAll('#roomingList .rooming-row');
            const tbody = document.getElementById('roomingTableBody');
            tbody.innerHTML = '';
            
            let hasData = false;
            
            rows.forEach(row => {
                const guestName = row.querySelector('.guest-name').value.trim();
                const rooms = row.querySelector('.room-number').value;
                const roomType = row.querySelector('.room-type').value;
                const mealType = row.querySelector('.meal-type').value;
                const viewType = row.querySelector('.view-type').value;
                
                if (guestName || rooms || roomType || mealType || viewType) {
                    hasData = true;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${guestName}</td>
                        <td>${rooms}</td>
                        <td>${roomType}</td>
                        <td>${mealType}</td>
                        <td>${viewType}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            
            if (!hasData) {
                if (!silent) showToast('Please fill in some data first!');
                return;
            }
            
            document.getElementById('roomingPreview').style.display = 'block';
            if (!silent) showToast('Preview generated!');
        }
        
        // ── Logo / Branding helpers ────────────────────────────────
        let roomingLogoSrc = null;
        let extensionsLogoSrc = null;

        function previewRoomingLogo(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                roomingLogoSrc = e.target.result;
                const thumb = document.getElementById('roomingLogoPreview');
                thumb.innerHTML = `<img src="${roomingLogoSrc}" alt="logo"> <span style="font-size:0.82rem;color:#64748b;">Logo ready ✅</span>`;
                document.getElementById('roomingBrandText').value = '';
            };
            reader.readAsDataURL(file);
        }

        function previewExtensionsLogo(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                extensionsLogoSrc = e.target.result;
                const thumb = document.getElementById('extensionsLogoPreview');
                thumb.innerHTML = `<img src="${extensionsLogoSrc}" alt="logo"> <span style="font-size:0.82rem;color:#64748b;">Logo ready ✅</span>`;
                document.getElementById('extensionsBrandText').value = '';
            };
            reader.readAsDataURL(file);
        }

        function clearRoomingLogo() {
            roomingLogoSrc = null;
            document.getElementById('roomingLogoPreview').innerHTML = '';
            document.getElementById('roomingBrandText').value = '';
            document.getElementById('roomingLogoFile').value = '';
        }

        function clearExtensionsLogo() {
            extensionsLogoSrc = null;
            document.getElementById('extensionsLogoPreview').innerHTML = '';
            document.getElementById('extensionsBrandText').value = '';
            document.getElementById('extensionsLogoFile').value = '';
        }

        function getRoomingLogoData() {
            if (roomingLogoSrc) return { type: 'image', src: roomingLogoSrc };
            const txt = document.getElementById('roomingBrandText').value.trim();
            if (txt) return { type: 'text', text: txt };
            return null;
        }

        function getExtensionsLogoData() {
            if (extensionsLogoSrc) return { type: 'image', src: extensionsLogoSrc };
            const txt = document.getElementById('extensionsBrandText').value.trim();
            if (txt) return { type: 'text', text: txt };
            return null;
        }
        // ── End logo helpers ───────────────────────────────────────

        function saveRoomingAsImage() {
            // Auto-generate data without requiring Preview click
            generateRoomingPreview(true);
            const preview = document.getElementById('roomingPreview');
            if (!preview || getComputedStyle(preview).display === 'none') return;
            const logoData = getRoomingLogoData();
            tableToCanvas('roomingTable', 'ROOMING LIST', `rooming_list_${new Date().toISOString().split('T')[0]}.png`, logoData);
        }
        
        function saveRoomingAsExcel() {
            generateRoomingPreview(true);
            const preview = document.getElementById('roomingPreview');
            if (!preview || getComputedStyle(preview).display === 'none') return;
            
            const table = document.getElementById('roomingTable');
            let wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Rooming List');
            wb = addXlsxWatermark(wb);
            XLSX.writeFile(wb, `rooming_list_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Saved as Excel!');
        }
        
        // Extensions Functions
        function addExtensionRow() {
            const list = document.getElementById('extensionsList');
            const newRow = document.createElement('div');
            newRow.className = 'extensions-row';
            newRow.innerHTML = `
                <input type="text" class="ext-guest-name" placeholder="Guest Name">
                <input type="text" class="ext-old-hcn" placeholder="Old HCN">
                <input type="text" class="ext-new-hcn" placeholder="New HCN">
                <input type="date" class="ext-from">
                <input type="date" class="ext-to">
                <button class="remove-day-btn" onclick="removeExtensionRow(this)">✕</button>
            `;
            list.appendChild(newRow);
        }
        
        function removeExtensionRow(btn) {
            const list = document.getElementById('extensionsList');
            if (list.children.length > 1) {
                btn.parentElement.remove();
            } else {
                showToast('Cannot remove the last row!');
            }
        }
        
        function clearExtensionsList() {
            if (confirm('Are you sure you want to clear all extensions data?')) {
                const list = document.getElementById('extensionsList');
                list.innerHTML = `
                    <div class="extensions-row">
                        <input type="text" class="ext-guest-name" placeholder="Guest Name">
                        <input type="text" class="ext-old-hcn" placeholder="Old HCN">
                        <input type="text" class="ext-new-hcn" placeholder="New HCN">
                        <input type="date" class="ext-from">
                        <input type="date" class="ext-to">
                        <button class="remove-day-btn" onclick="removeExtensionRow(this)">✕</button>
                    </div>
                `;
                document.getElementById('extensionsPreview').style.display = 'none';
                showToast('Extensions cleared!');
            }
        }
        
        function generateExtensionsPreview(silent) {
            const rows = document.querySelectorAll('#extensionsList .extensions-row');
            const tbody = document.getElementById('extensionsTableBody');
            tbody.innerHTML = '';
            
            let hasData = false;
            
            rows.forEach(row => {
                const guestName = row.querySelector('.ext-guest-name').value.trim();
                const oldHcn = row.querySelector('.ext-old-hcn').value;
                const newHcn = row.querySelector('.ext-new-hcn').value;
                const from = row.querySelector('.ext-from').value;
                const to = row.querySelector('.ext-to').value;
                
                if (guestName || oldHcn || newHcn || from || to) {
                    hasData = true;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${guestName}</td>
                        <td>${oldHcn}</td>
                        <td>${newHcn}</td>
                        <td>${from}</td>
                        <td>${to}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            
            if (!hasData) {
                if (!silent) showToast('Please fill in some data first!');
                return;
            }
            
            document.getElementById('extensionsPreview').style.display = 'block';
            if (!silent) showToast('Preview generated!');
        }
        
        function saveExtensionsAsImage() {
            // Auto-generate data without requiring Preview click
            generateExtensionsPreview(true);
            const preview = document.getElementById('extensionsPreview');
            if (!preview || getComputedStyle(preview).display === 'none') return;
            const logoData = getExtensionsLogoData();
            tableToCanvas('extensionsTable', 'EXTENSIONS LIST', `extensions_${new Date().toISOString().split('T')[0]}.png`, logoData);
        }
        
        function saveExtensionsAsExcel() {
            generateExtensionsPreview(true);
            const preview = document.getElementById('extensionsPreview');
            if (!preview || getComputedStyle(preview).display === 'none') return;
            
            const table = document.getElementById('extensionsTable');
            let wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Extensions');
            wb = addXlsxWatermark(wb);
            XLSX.writeFile(wb, `extensions_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Saved as Excel!');
        }
        
        // Task Manager Functions
        let tasks = JSON.parse(localStorage.getItem('workSmartTasks')) || [];
        
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            tasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskItem.innerHTML = `
                    <div class="task-text">${task.text}</div>
                    <div class="task-actions">
                        <button class="task-btn complete" onclick="toggleTask(${index})">
                            ${task.completed ? '↩️' : '✓'}
                        </button>
                        <button class="task-btn delete" onclick="deleteTask(${index})">
                            🗑️
                        </button>
                    </div>
                `;
                taskList.appendChild(taskItem);
            });
            
            saveTasks();
        }
        
        function addTask() {
            const input = document.getElementById('taskInput');
            const taskText = input.value.trim();
            
            if (!taskText) return;
            
            tasks.unshift({
                text: taskText,
                completed: false,
                date: new Date().toISOString()
            });
            
            input.value = '';
            renderTasks();
            showToast('Task added!');
        }
        
        function toggleTask(index) {
            tasks[index].completed = !tasks[index].completed;
            renderTasks();
        }
        
        function deleteTask(index) {
            tasks.splice(index, 1);
            renderTasks();
            showToast('Task deleted!');
        }
        
        function clearCompletedTasks() {
            tasks = tasks.filter(task => !task.completed);
            renderTasks();
            showToast('Completed tasks cleared!');
        }
        
        function clearAllTasks() {
            if (confirm('Are you sure you want to delete all tasks?')) {
                tasks = [];
                renderTasks();
                showToast('All tasks cleared!');
            }
        }
        
        function saveTasks() {
            localStorage.setItem('workSmartTasks', JSON.stringify(tasks));
        }
        
        function saveTasksManually() {
            saveTasks();
            showToast('Tasks saved successfully!');
        }
        
        function exportTasks() {
            if (tasks.length === 0) {
                showToast('No tasks to export!');
                return;
            }
            
            let text = '=== MY TASKS ===\n\n';
            
            const pendingTasks = tasks.filter(t => !t.completed);
            const completedTasks = tasks.filter(t => t.completed);
            
            if (pendingTasks.length > 0) {
                text += '📋 PENDING TASKS:\n';
                pendingTasks.forEach((task, index) => {
                    text += `${index + 1}. ☐ ${task.text}\n`;
                });
                text += '\n';
            }
            
            if (completedTasks.length > 0) {
                text += '✅ COMPLETED TASKS:\n';
                completedTasks.forEach((task, index) => {
                    text += `${index + 1}. ☑ ${task.text}\n`;
                });
            }
            
            text += `\n---\nTotal: ${tasks.length} tasks\nCompleted: ${completedTasks.length}\nPending: ${pendingTasks.length}\n`;
            text += `Exported on: ${new Date().toLocaleString()}\n`;
            text = addTextWatermark(text);
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tasks_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Tasks exported!');
        }
        
        // Notes Functions
        let notes = localStorage.getItem('workSmartNotes') || '';
        
        function loadNotes() {
            const notesArea = document.getElementById('notesArea');
            notesArea.value = notes;
            updateNotesCount();
        }
        
        function updateNotesCount() {
            const notesArea = document.getElementById('notesArea');
            const count = notesArea.value.length;
            document.getElementById('notesCount').textContent = `${count} characters`;
        }
        
        function saveNotes() {
            const notesArea = document.getElementById('notesArea');
            notes = notesArea.value;
            localStorage.setItem('workSmartNotes', notes);
            showToast('Notes saved!');
        }
        
        function exportNotes() {
            const notesArea = document.getElementById('notesArea');
            let text = notesArea.value;
            
            if (!text.trim()) {
                showToast('No notes to export!');
                return;
            }
            
            text = addTextWatermark(text);
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `notes_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Notes exported!');
        }
        
        function clearNotes() {
            if (confirm('Are you sure you want to clear all notes?')) {
                document.getElementById('notesArea').value = '';
                notes = '';
                localStorage.removeItem('workSmartNotes');
                updateNotesCount();
                showToast('Notes cleared!');
            }
        }
        
        // Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            renderTasks();
            loadNotes();
        });
        
        // Add Enter key support for adding tasks
        document.addEventListener('DOMContentLoaded', () => {
            const taskInput = document.getElementById('taskInput');
            if (taskInput) {
                taskInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addTask();
                    }
                });
            }
        });
    

</script>

<!-- ===================== EXTRACTOR DATA PRO ADDONS ===================== -->
<script>
/* ===== OCR MODES ===== */
let ocrMode = "standard";

function setOCRMode(mode){
  ocrMode = mode;
  // Update active tab button
  ['standard','passport','rooming'].forEach(m => {
    const btn = document.getElementById('modeBtn_' + m);
    if(btn) btn.classList.toggle('ocr-mode-active', m === mode);
  });
  showOCRStatus("Mode: " + mode.toUpperCase(), "#3498db");
}

/* ===== DRAG & DROP ===== */
function handleDrop(e){
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('drop-zone-hover');
  const files = e.dataTransfer.files;
  if(!files.length) return;
  const input = document.getElementById('ocrImage');
  // Transfer files to the input
  const dt = new DataTransfer();
  for(const f of files) dt.items.add(f);
  input.files = dt.files;
  runBatchOCR();
}

/* ===== CHAR COUNT ===== */
function updateCharCount(){
  const ta = document.getElementById('ocrResult');
  const count = ta ? ta.value.length : 0;
  const el = document.getElementById('charCount');
  if(el) el.textContent = count.toLocaleString() + ' chars';
}

/* ===== COPY RESULT ===== */
function copyOCRResult(){
  const ta = document.getElementById('ocrResult');
  if(!ta || !ta.value.trim()){ showOCRStatus("Nothing to copy!", "#e74c3c"); return; }
  navigator.clipboard.writeText(ta.value).then(()=>{
    showOCRStatus("✅ Copied to clipboard!", "#27ae60");
  }).catch(()=>{
    ta.select();
    document.execCommand('copy');
    showOCRStatus("✅ Copied!", "#27ae60");
  });
}

/* ===== CLEAR RESULT ===== */
function clearOCRResult(){
  const ta = document.getElementById('ocrResult');
  if(ta){ ta.value = ''; updateCharCount(); }
  document.getElementById('filePreviewList').style.display = 'none';
  document.getElementById('filePreviewList').innerHTML = '';
  // Hide search bar
  const sb = document.getElementById('ocrSearchBar');
  if (sb) { sb.style.display = 'none'; sb.value = ''; }
  // Clear preview panel
  clearExtractionPreview();
  window.lastExtractedData = null;
  window.accumulatedScans = [];
  showOCRStatus("Cleared.", "#888");
}

/* ===== OCR STATUS ===== */
function showOCRStatus(msg, color){
  const el = document.getElementById('ocrStatus');
  if(!el) return;
  el.textContent = msg;
  el.style.background = color + '18';
  el.style.color = color;
  el.style.border = '1px solid ' + color + '44';
  el.style.display = 'block';
  clearTimeout(el._timer);
  el._timer = setTimeout(()=>{ el.style.display='none'; }, 3000);
}

/* ===== PROGRESS BAR ===== */
function setProgress(pct, label){
  const wrap = document.getElementById('ocrProgressWrap');
  const bar = document.getElementById('ocrProgressBar');
  const lbl = document.getElementById('ocrProgressLabel');
  if(!wrap) return;
  if(pct >= 100){ setTimeout(()=>{ wrap.style.display='none'; bar.style.width='0%'; }, 600); }
  else { wrap.style.display='block'; }
  bar.style.width = pct + '%';
  if(lbl && label) lbl.textContent = label;
}

function hideProgress(){
  const wrap = document.getElementById('ocrProgressWrap');
  const bar = document.getElementById('ocrProgressBar');
  if(wrap) wrap.style.display = 'none';
  if(bar) bar.style.width = '0%';
}

/* ===== FILE PREVIEW ===== */
function showFilePreview(files){
  const el = document.getElementById('filePreviewList');
  if(!el || !files.length){ el.style.display='none'; return; }
  el.innerHTML = Array.from(files).map(f =>
    `<span style="display:inline-block;background:#ebf5fb;border:1px solid #aed6f1;border-radius:6px;padding:3px 10px;margin:3px;">📄 ${f.name} <span style="color:#aaa;">(${(f.size/1024).toFixed(1)} KB)</span></span>`
  ).join('');
  el.style.display = 'block';
}

/* ===== PDF OCR ===== */
async function runPdfOCR(file){
  const reader = new FileReader();
  reader.onload = async function(){
    const typedarray = new Uint8Array(this.result);
    const pdf = await pdfjsLib.getDocument(typedarray).promise;
    let fullText = "";
    for(let i=1;i<=pdf.numPages;i++){
      setProgress(Math.round((i/pdf.numPages)*90), `Reading PDF page ${i} of ${pdf.numPages}...`);
      const page = await pdf.getPage(i);
      const viewport = page.getViewport({scale:2});
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      await page.render({canvasContext:ctx, viewport}).promise;
      const { data:{ text } } = await Tesseract.recognize(canvas, "ara+eng");
      fullText += text + "\n";
    }
    setProgress(100, "Done!");
    postProcessOCR(fullText);
  };
  reader.readAsArrayBuffer(file);
}

/* ===== AI CLEANUP ===== */
/* ===== PASSPORT / ID OCR ===== */
function passportParser(text){
  const passport = {};
  const lines = text.split("\n");
  lines.forEach(l=>{
    if(/passport/i.test(l)) passport.type="PASSPORT";
    if(/name/i.test(l)) passport.name=l.split(":").pop().trim();
    if(/nationality/i.test(l)) passport.nationality=l.split(":").pop().trim();
    if(/date of birth|dob/i.test(l)) passport.dob=l.split(":").pop().trim();
    if(/passport no|number/i.test(l)) passport.number=l.split(":").pop().trim();
  });
  return Object.entries(passport).map(([k,v])=>k.toUpperCase()+": "+v).join("\n");
}

/* ===== AUTO ROOM TYPE DETECTION ===== */
function detectRoomType(nameLine){
  const n = nameLine.toUpperCase();
  if(n.includes("SGL") || n.includes("SINGLE")) return "SGL";
  if(n.includes("DBL") || n.includes("DOUBLE")) return "DBL";
  if(n.includes("TRPL") || n.includes("TRIPLE")) return "TRPL";
  if(n.includes("SUITE")) return "SUITE";
  return "";
}

/* ===== POST PROCESS ===== */
function postProcessOCR(rawText){
  let text = aiCleanup(rawText);
  if(ocrMode==="passport"){ text = passportParser(text); }
  document.getElementById("ocrResult").value = text;
  updateCharCount();
  detectArabic(text);
  const lines = text.split("\n").filter(l=>l.trim()).length;
  showOCRStatus(`✅ Done! ${lines} lines extracted.`, "#27ae60");
}

/* ===== IMAGE PRE-PROCESSING FOR BETTER OCR (ENHANCED v2) ===== */
async function preprocessImageForOCR(file) {
  // Use the enhanced version if available (defined in AI engine script)
  if (typeof enhancedPreprocessImage === 'function') {
    return enhancedPreprocessImage(file);
  }
  // Fallback: original single-pass version
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = function(e) {
      img.onload = function() {
        const scale = 2;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width  = img.width  * scale;
        canvas.height = img.height * scale;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const d = imageData.data;
        const contrast = 1.4;
        const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
        for (let i = 0; i < d.length; i += 4) {
          d[i]   = Math.min(255, Math.max(0, factor * (d[i]   - 128) + 128));
          d[i+1] = Math.min(255, Math.max(0, factor * (d[i+1] - 128) + 128));
          d[i+2] = Math.min(255, Math.max(0, factor * (d[i+2] - 128) + 128));
        }
        ctx.putImageData(imageData, 0, 0);
        canvas.toBlob(blob => resolve(blob), 'image/png', 1.0);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ===== ADVANCED OCR (DUAL-PASS WHEN AVAILABLE) ===== */
async function runAdvancedOCR(file, progressBase, progressRange) {
  // Use dual-pass if available (defined in AI engine)
  if (typeof dualPassOCR === 'function') {
    return dualPassOCR(file, progressBase, progressRange);
  }
  // Fallback: single enhanced pass
  const processedImage = await preprocessImageForOCR(file);
  const { data: { text } } = await Tesseract.recognize(
    processedImage,
    'ara+eng',
    {
      logger: m => {
        if (m.status === 'recognizing text') {
          const pct = progressBase + Math.round(m.progress * progressRange);
          setProgress(pct, `Reading text… ${Math.round(m.progress * 100)}%`);
        } else if (m.status === 'loading tesseract core') {
          setProgress(progressBase + 2, 'Loading OCR engine…');
        } else if (m.status === 'initializing tesseract') {
          setProgress(progressBase + 5, 'Initializing…');
        } else if (m.status === 'loading language traineddata') {
          setProgress(progressBase + 10, 'Loading language data…');
        }
      }
    }
  );
  return text;
}

/* ===== BATCH OCR — MAIN ENTRY POINT ===== */
async function runBatchOCR() {
  const files = document.getElementById('ocrImage').files;
  if (!files.length) return;

  showFilePreview(files);
  let output = '';

  for (let i = 0; i < files.length; i++) {
    const f = files[i];
    const base  = Math.round((i / files.length) * 80);
    const range = Math.round(80 / files.length) - 5;

    setProgress(base + 2, `File ${i + 1}/${files.length}: ${f.name}`);

    if (f.type === 'application/pdf') {
      await runPdfOCR(f);
      return; // runPdfOCR handles postProcess itself
    }

    try {
      setProgress(base + 3, `Enhancing image…`);
      const text = await runAdvancedOCR(f, base + 5, range);
      output += text + '\n\n';
    } catch (err) {
      console.error('OCR error:', err);
      // Plain fallback — no preprocessing, no options object
      setProgress(base + 5, `Fallback OCR…`);
      try {
        const { data: { text } } = await Tesseract.recognize(f, 'ara+eng');
        output += text + '\n\n';
      } catch (err2) {
        console.error('Fallback OCR also failed:', err2);
        output += `[Error reading ${f.name}]\n\n`;
      }
    }
  }

  setProgress(100, 'Done!');
  setTimeout(() => hideProgress(), 800);
  postProcessOCR(output);
}

/* ===== SEND TO ROOMING WITH AUTO TYPE ===== */
function sendToRooming(){
  const text = document.getElementById("ocrResult").value;
  const names = text.split("\n").filter(l=>l.trim());
  const container = document.getElementById("roomingList");
  container.innerHTML="";
  names.forEach(line=>{
    const roomType = detectRoomType(line);
    const cleanName = line.replace(/SGL|DBL|TRPL|DOUBLE|SINGLE|SUITE/gi,"").trim();
    const row=document.createElement("div");
    row.className="rooming-row";
    row.innerHTML=`
      <input type="text" class="guest-name" value="${cleanName}">
      <input type="number" class="room-number" placeholder="Rooms">
      <input list="roomTypes" class="room-type" value="${roomType}">
      <input list="mealTypes" class="meal-type">
      <input list="viewTypes" class="view-type">
      <button class="remove-day-btn" onclick="removeRoomingRow(this)">✕</button>
    `;
    container.appendChild(row);
  });
  showToast("Rooming list generated!");
  window.scrollTo({top:container.offsetTop,behavior:"smooth"});
}
</script>

<!-- PDF.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>


<!-- ===================== EXTRACTOR DATA ULTIMATE ADDONS ===================== -->
<script>
/* ===== LANGUAGE AUTO DETECTION ===== */
function detectLanguage(text){
  if(/[\u0600-\u06FF]/.test(text)) return "ara";
  return "eng";
}

/* ===== DETECT ARABIC AND SHOW TRANSLATE BUTTON ===== */
function detectArabic(text){
  const hasArabic = /[\u0600-\u06FF]/.test(text);
  const btn = document.getElementById('sendToTranslatorBtn');
  if(btn) {
    btn.style.display = hasArabic ? 'inline-block' : 'none';
  }
}

/* ===== SEND TO TRANSLATOR ===== */
function sendToTranslator(){
  const text = document.getElementById('ocrResult').value;
  if(!text.trim()){
    showToast('❌ No text to translate!');
    return;
  }
  
  // Scroll to translator
  const translatorSection = document.getElementById('translator');
  if(translatorSection) {
    translatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Set the text in the translator input
    setTimeout(() => {
      const inputText = document.getElementById('inputText');
      if(inputText) {
        inputText.value = text;
        // Trigger translation
        if(typeof translateName === 'function') {
          translateName();
        }
        showToast('✅ Text sent to translator!');
      }
    }, 500);
  }
}

/* ===== MRZ PASSPORT READER (ICAO) - ENHANCED ===== */
function parseMRZ(text){
  const lines = text.split("\n").filter(l=>l.includes("<"));
  if(lines.length < 2) return text;

  const l1 = lines[0];
  const l2 = lines[1];

  // Parse MRZ fields
  const passport = {
    type: l1.substring(0,2).replace(/</g,""),
    country: l1.substring(2,5).replace(/</g,""),
    surname: "",
    givenNames: "",
    passportNumber: l2.substring(0,9).replace(/</g,""),
    nationality: l2.substring(10,13).replace(/</g,""),
    dob: "",
    gender: l2.substring(20,21),
    expiry: "",
    personalNumber: l2.substring(28,42).replace(/</g,"")
  };
  
  // Parse name from line 1 (format: SURNAME<<GIVENNAMES)
  const namePart = l1.substring(5);
  const nameParts = namePart.split("<<");
  if (nameParts.length >= 1) {
    passport.surname = nameParts[0].replace(/</g, " ").trim();
  }
  if (nameParts.length >= 2) {
    passport.givenNames = nameParts[1].replace(/</g, " ").trim();
  }
  
  // Parse and format date of birth (YYMMDD to readable format)
  const dobRaw = l2.substring(13,19);
  if (dobRaw.length === 6) {
    const year = parseInt(dobRaw.substring(0,2)) > 30 ? '19' + dobRaw.substring(0,2) : '20' + dobRaw.substring(0,2);
    const month = dobRaw.substring(2,4);
    const day = dobRaw.substring(4,6);
    passport.dob = `${day}/${month}/${year}`;
  }
  
  // Parse and format expiry date
  const expiryRaw = l2.substring(21,27);
  if (expiryRaw.length === 6) {
    const year = parseInt(expiryRaw.substring(0,2)) > 30 ? '19' + expiryRaw.substring(0,2) : '20' + expiryRaw.substring(0,2);
    const month = expiryRaw.substring(2,4);
    const day = expiryRaw.substring(4,6);
    passport.expiry = `${day}/${month}/${year}`;
  }
  
  // Format gender
  const genderMap = { 'M': 'Male', 'F': 'Female', 'X': 'Unspecified' };
  passport.gender = genderMap[passport.gender] || passport.gender;
  
  // Build formatted output
  let output = `╔═══════════════════════════════════════════╗
║         PASSPORT INFORMATION (MRZ)        ║
╚═══════════════════════════════════════════╝

👤 NAME
   Surname:      ${passport.surname}
   Given Name:   ${passport.givenNames}
   Full Name:    ${passport.givenNames} ${passport.surname}

🛂 PASSPORT DETAILS
   Passport No:  ${passport.passportNumber}
   Type:         ${passport.type}
   Nationality:  ${passport.nationality}

📅 DATES
   Date of Birth:  ${passport.dob}
   Expiry Date:    ${passport.expiry}

ℹ️  OTHER
   Gender:          ${passport.gender}
   Personal Number: ${passport.personalNumber || 'N/A'}
   Issuing Country: ${passport.country}

═══════════════════════════════════════════════`;

  return output;
}

/* ===== AI NAME CORRECTION (ENHANCED) ===== */
function aiNameFix(name){
  return name
    .replace(/0/g,"O")
    .replace(/1/g,"I")
    .replace(/5/g,"S")
    .replace(/8/g,"B")
    .replace(/\|/g,"I")
    .replace(/\s{2,}/g," ")
    .replace(/[^\w\u0600-\u06FF\s.,@()-]/g,"")
    .trim();
}

/* ===== ADVANCED NUMBER/LETTER CONTEXT DETECTION (NEW) ===== */

// Detect if a string should be numbers or letters based on context
function detectNumberOrLetterContext(text, position) {
  // Get surrounding context (10 chars before and after)
  const before = text.substring(Math.max(0, position - 10), position);
  const after = text.substring(position, Math.min(text.length, position + 10));
  const context = before + after;
  
  // Number context indicators
  const numberIndicators = [
    /phone|tel|mobile|cell|fax/i,
    /passport|id|license|number|no\./i,
    /\d{2,}/,  // Already has 2+ digits
    /amount|price|cost|total|sum/i,
    /date|birth|expiry|issue/i,
    /\+\d|00\d/,  // International phone prefix
    /room|flight|booking|confirmation/i
  ];
  
  // Letter context indicators
  const letterIndicators = [
    /name|surname|given|first|last/i,
    /address|street|city|country/i,
    /email|@/,
    /nationality|gender/i,
    /[a-z]{3,}/i  // Already has 3+ letters
  ];
  
  let numberScore = 0;
  let letterScore = 0;
  
  numberIndicators.forEach(pattern => {
    if (pattern.test(context)) numberScore++;
  });
  
  letterIndicators.forEach(pattern => {
    if (pattern.test(context)) letterScore++;
  });
  
  return {
    isNumber: numberScore > letterScore,
    isLetter: letterScore > numberScore,
    confidence: Math.abs(numberScore - letterScore)
  };
}

// Smart character conversion based on context
function smartCharacterCorrection(text) {
  let corrected = '';
  let i = 0;
  
  while (i < text.length) {
    const char = text[i];
    const context = detectNumberOrLetterContext(text, i);
    
    // If we're in a number context
    if (context.isNumber && context.confidence > 0) {
      const charUpper = char.toUpperCase();
      
      // Convert letters to numbers
      if (charUpper === 'O' || charUpper === 'Q') corrected += '0';
      else if (charUpper === 'I' || charUpper === 'L') corrected += '1';
      else if (charUpper === 'Z') corrected += '2';
      else if (charUpper === 'E') corrected += '3';
      else if (charUpper === 'A' || charUpper === 'H') corrected += '4';
      else if (charUpper === 'S') corrected += '5';
      else if (charUpper === 'G' || charUpper === 'B') corrected += '6';
      else if (charUpper === 'T') corrected += '7';
      else if (charUpper === 'B') corrected += '8';
      else if (charUpper === 'G' || charUpper === 'Q') corrected += '9';
      else corrected += char;
    }
    // If we're in a letter context
    else if (context.isLetter && context.confidence > 0) {
      // Convert numbers to letters
      if (char === '0') corrected += 'O';
      else if (char === '1') corrected += 'I';
      else if (char === '3') corrected += 'E';
      else if (char === '4') corrected += 'A';
      else if (char === '5') corrected += 'S';
      else if (char === '6') corrected += 'G';
      else if (char === '7') corrected += 'T';
      else if (char === '8') corrected += 'B';
      else corrected += char;
    }
    else {
      corrected += char;
    }
    
    i++;
  }
  
  return corrected;
}

// Detect and fix number sequences that have been read as letters
function fixNumberSequences(text) {
  let fixed = text;
  
  // Pattern 1: Phone numbers (common formats)
  // +XX XXX XXX XXXX or similar
  fixed = fixed.replace(/\+?[A-Z0-9]{1,4}\s*[A-Z0-9]{3,4}\s*[A-Z0-9]{3,4}\s*[A-Z0-9]{3,4}/g, (match) => {
    // If it's near phone/mobile/tel keywords, convert letters to numbers
    return match
      .replace(/O/g, '0')
      .replace(/I/g, '1')
      .replace(/Z/g, '2')
      .replace(/E/g, '3')
      .replace(/A/g, '4')
      .replace(/S/g, '5')
      .replace(/G/g, '6')
      .replace(/T/g, '7')
      .replace(/B/g, '8')
      .replace(/Q/g, '9')
      .replace(/L/g, '1');
  });
  
  // Pattern 2: After "Phone:", "Mobile:", "Tel:", etc.
  fixed = fixed.replace(/(phone|mobile|tel|cell|fax)[\s:]+([A-Z0-9\s\-\+\(\)]{10,})/gi, (match, label, number) => {
    const convertedNumber = number
      .replace(/O/g, '0')
      .replace(/I/g, '1')
      .replace(/Z/g, '2')
      .replace(/E/g, '3')
      .replace(/A/g, '4')
      .replace(/S/g, '5')
      .replace(/G/g, '6')
      .replace(/T/g, '7')
      .replace(/B/g, '8')
      .replace(/Q/g, '9')
      .replace(/L/g, '1');
    return label + ': ' + convertedNumber;
  });
  
  // Pattern 3: Passport numbers (2 letters + digits)
  fixed = fixed.replace(/(passport|id)[\s:]+([A-Z]{1,2})([A-Z0-9]{6,9})/gi, (match, label, letters, numbers) => {
    const convertedNumbers = numbers
      .replace(/O/g, '0')
      .replace(/I/g, '1')
      .replace(/S/g, '5')
      .replace(/B/g, '8')
      .replace(/G/g, '6')
      .replace(/L/g, '1');
    return label + ': ' + letters + convertedNumbers;
  });
  
  // Pattern 4: Date of birth / Dates (DD/MM/YYYY or similar)
  fixed = fixed.replace(/(date|birth|dob|expiry|issue)[\s:]+([A-Z0-9\/\-\.]{8,12})/gi, (match, label, date) => {
    const convertedDate = date
      .replace(/O/g, '0')
      .replace(/I/g, '1')
      .replace(/S/g, '5')
      .replace(/B/g, '8')
      .replace(/L/g, '1')
      .replace(/Z/g, '2');
    return label + ': ' + convertedDate;
  });
  
  // Pattern 5: Confirmation/Booking numbers
  fixed = fixed.replace(/(confirmation|booking|reservation|ref|hcn|cnf)[\s:#-]+([A-Z0-9]{6,})/gi, (match, label, number) => {
    // Keep first 2-3 chars as letters, rest might be numbers
    const firstPart = number.substring(0, 3);
    const restPart = number.substring(3)
      .replace(/O/g, '0')
      .replace(/I/g, '1')
      .replace(/S/g, '5')
      .replace(/B/g, '8')
      .replace(/L/g, '1');
    return label + ': ' + firstPart + restPart;
  });
  
  // Pattern 6: Room numbers, flight numbers
  fixed = fixed.replace(/(room|flight)[\s:#-]+([A-Z0-9]{2,6})/gi, (match, label, number) => {
    // First 2 chars letters, rest numbers
    if (number.length > 2) {
      const letters = number.substring(0, 2);
      const digits = number.substring(2)
        .replace(/O/g, '0')
        .replace(/I/g, '1')
        .replace(/S/g, '5')
        .replace(/B/g, '8')
        .replace(/L/g, '1');
      return label + ': ' + letters + digits;
    }
    return match;
  });
  
  // Pattern 7: Standalone number sequences (10+ chars that look like phone numbers)
  fixed = fixed.replace(/\b([A-Z0-9]{10,})\b/g, (match) => {
    // Count how many look like letter substitutions
    const letterCount = (match.match(/[OILSZBGTEAQ]/g) || []).length;
    const totalLength = match.length;
    
    // If >40% are common letter substitutions, probably a number
    if (letterCount / totalLength > 0.4) {
      return match
        .replace(/O/g, '0')
        .replace(/I/g, '1')
        .replace(/Z/g, '2')
        .replace(/E/g, '3')
        .replace(/A/g, '4')
        .replace(/S/g, '5')
        .replace(/G/g, '6')
        .replace(/T/g, '7')
        .replace(/B/g, '8')
        .replace(/Q/g, '9')
        .replace(/L/g, '1');
    }
    return match;
  });
  
  return fixed;
}

// Fix amounts/prices that have been read as letters
function fixAmountSequences(text) {
  let fixed = text;
  
  // Pattern: Currency symbol or code followed by letter-number mix
  fixed = fixed.replace(/(USD|EUR|GBP|SAR|EGP|AED|[$€£¥])[\s]*([A-Z0-9,\.]{1,15})/gi, (match, currency, amount) => {
    const convertedAmount = amount
      .replace(/O/g, '0')
      .replace(/I/g, '1')
      .replace(/S/g, '5')
      .replace(/B/g, '8')
      .replace(/L/g, '1')
      .replace(/Z/g, '2');
    return currency + ' ' + convertedAmount;
  });
  
  // Pattern: Amount/Price/Cost/Total followed by number
  fixed = fixed.replace(/(amount|price|cost|total|fee|charge)[\s:]+([A-Z0-9,\.]{1,15})/gi, (match, label, amount) => {
    const convertedAmount = amount
      .replace(/O/g, '0')
      .replace(/I/g, '1')
      .replace(/S/g, '5')
      .replace(/B/g, '8')
      .replace(/L/g, '1');
    return label + ': ' + convertedAmount;
  });
  
  return fixed;
}

// Fix credit card numbers
function fixCardNumbers(text) {
  let fixed = text;
  
  // Pattern: 16 digit sequences with possible spaces/dashes
  fixed = fixed.replace(/\b([A-Z0-9]{4}[\s\-]?[A-Z0-9]{4}[\s\-]?[A-Z0-9]{4}[\s\-]?[A-Z0-9]{4})\b/g, (match) => {
    // If it has many letter substitutions, convert to numbers
    const letterCount = (match.match(/[OILSZBGTEAQ]/g) || []).length;
    if (letterCount >= 4) {
      return match
        .replace(/O/g, '0')
        .replace(/I/g, '1')
        .replace(/S/g, '5')
        .replace(/B/g, '8')
        .replace(/L/g, '1')
        .replace(/Z/g, '2');
    }
    return match;
  });
  
  return fixed;
}

/* ═══════════════════════════════════════════════════════════════
   REBUILT AI CLEANUP v4 — Processes Arabic & English separately,
   never merges lines, keeps ALL written content
   ═══════════════════════════════════════════════════════════════ */
function aiCleanup(text) {
  if (!text || !text.trim()) return text;
  let cleaned = text;

  // ── STAGE 0: LINE ENDING & ENCODING FIX ─────────────────────────────────
  cleaned = cleaned
    .replace(/\r\n/g, '\n').replace(/\r/g, '\n')
    .replace(/\t/g, '  ')
    .replace(/\u00A0/g, ' ')
    .replace(/\uFEFF/g, '');

  // ── STAGE 1: LINE-BY-LINE PROCESSING (never cross lines) ────────────────
  const processedLines = cleaned.split('\n').map(line => {
    const t = line.trim();
    if (!t) return '';

    const arabicCount  = (t.match(/[\u0600-\u06FF]/g)  || []).length;
    const englishCount = (t.match(/[a-zA-Z]/g)         || []).length;
    const digitCount   = (t.match(/[0-9]/g)            || []).length;
    const total        = Math.max(t.replace(/\s/g,'').length, 1);

    const mainlyArabic  = arabicCount  / total > 0.35;
    const mainlyEnglish = englishCount / total > 0.35;
    const mainlyDigits  = digitCount   / total > 0.50;

    let l = line;

    // English-only corrections — NEVER run on Arabic lines
    if (mainlyEnglish && !mainlyArabic) {
      l = l
        .replace(/(?<=[a-z])rn(?=[a-z])/g, 'm')
        .replace(/\brnr\b/gi, 'Mr').replace(/\brnrs\b/gi, 'Mrs')
        .replace(/\bpassp0rt\b/gi, 'Passport').replace(/\bpassporl\b/gi, 'Passport')
        .replace(/\bnarne\b/gi, 'Name').replace(/\bnaMe\b/gi, 'Name')
        .replace(/\bnati0nality\b/gi, 'Nationality').replace(/\bnationahty\b/gi, 'Nationality')
        .replace(/\bnum[b8]er\b/gi, 'Number').replace(/\bnurnber\b/gi, 'Number')
        .replace(/\bGlVEN\b/gi, 'GIVEN')
        // 0/1 only when sandwiched between letters (not near digits)
        .replace(/(?<=[a-zA-Z])0(?=[a-zA-Z]{2,})/g, 'o')
        .replace(/(?<=[a-zA-Z])1(?=[a-zA-Z]{2,})/g, 'i')
        .replace(/\b0(?=[a-zA-Z]{3,})/g, 'O')
        .replace(/\b1(?=[a-zA-Z]{3,})/g, 'I');
    }

    // Arabic-only corrections — NEVER run on English lines
    if (mainlyArabic && !mainlyEnglish) {
      l = l
        .replace(/[\u064B-\u0652\u0670\u0640]/g, '') // remove diacritics
        .replace(/[أإآ]/g, 'ا');                      // normalize Alef only
      // Do NOT touch ة ى ؤ ئ — they are distinct letters
    }

    // Number-context corrections — safe on all scripts
    if (mainlyDigits) {
      l = l
        .replace(/(?<=\d)[Oo](?=\d)/g, '0')
        .replace(/(?<=\d)[lI](?=\d)/g, '1')
        .replace(/(?<=\d)[Ss](?=\d)/g, '5')
        .replace(/(?<=\d)[Bb](?=\d)/g, '8')
        .replace(/(?<=\d)[Gg](?=\d)/g, '6')
        .replace(/(?<=\d)[Zz](?=\d)/g, '2');
    }

    // Universal safe fixes (script-neutral)
    l = l
      .replace(/[`´'']/g, "'").replace(/[""«»]/g, '"')
      .replace(/[—–]/g, '-').replace(/…/g, '...')
      .replace(/([a-zA-Z0-9._-]+)\s+@\s+([a-zA-Z0-9.-]+)/g, '$1@$2')
      .replace(/(\d{1,2})\s*\/\s*(\d{1,2})\s*\/\s*(\d{2,4})/g, '$1/$2/$3')
      .replace(/  +/g, ' ')
      .replace(/^\s+/, '').replace(/\s+$/, '');

    return l;
  });

  cleaned = processedLines.join('\n');

  // ── STAGE 2: MINIMAL LINE FILTER (keep EVERYTHING with real content) ─────
  const finalLines = cleaned.split('\n').filter(line => {
    const t = line.trim();
    if (!t) return false;
    // Only remove pure-symbol garbage (no letter/digit at all)
    if (!/[a-zA-Z0-9\u0600-\u06FF\u0660-\u0669]/.test(t)) return false;
    // Only remove 6+ repeated same-char noise lines
    if (/^(.)\1{5,}$/.test(t)) return false;
    return true;
  });

  // ── STAGE 3: FIELD LABEL CAPITALIZATION (start of line only) ────────────
  cleaned = finalLines.join('\n')
    .replace(/^(name|nationality|passport|visa|email|address|gender|phone|mobile|tel|id|iqama|date|expiry|issue|birth|arrival|departure|checkin|checkout|flight|hotel|room|meal|amount|total|remarks|notes)(\s*:)/gmi,
      (_, lbl, col) => lbl.toUpperCase() + col)
    .replace(/\n{3,}/g, '\n\n')
    .trim();

  return cleaned;
}

// (old cleanup helper stubs — no longer called by aiCleanup)
function _unused_fixNumberSequences(text) { return text; }
function _unused_fixAmountSequences(text) { return text; }
function _unused_fixCardNumbers(text) { return text; }

/* ===== AUTO MEAL PLAN DETECTION ===== */
function detectMealPlan(line){
  const l = line.toUpperCase();
  if(l.includes("BB") || l.includes("B.B")) return "B.B";
  if(l.includes("HB") || l.includes("H.B")) return "H.B";
  if(l.includes("FB") || l.includes("F.B")) return "F.B";
  if(l.includes("AI") || l.includes("ALL")) return "AI";
  if(l.includes("RO") || l.includes("R.O")) return "R.O";
  return "";
}

/* ===== OVERRIDE POST PROCESS (MEGA UPGRADED WITH VALIDATION + LIVE PREVIEW) ===== */
function postProcessOCR(rawText){
  let text = aiCleanup(rawText);

  // MRZ detection
  if(text.includes("<<")){
    text = parseMRZ(text);
  }

  document.getElementById("ocrResult").value = text;
  updateCharCount();
  detectArabic(text);
  
  // Show search bar after scan
  const searchBar = document.getElementById('ocrSearchBar');
  if (searchBar) searchBar.style.display = 'block';
  
  // SMART DATA EXTRACTION - Extract all data automatically
  const extractedData = smartExtractAll(text);
  
  // VALIDATE AND CORRECT DATA
  const validatedData = validateAndCorrectData(extractedData);
  
  // RAW LINE FALLBACK: if very little was extracted, capture all non-empty lines
  const totalExtracted = Object.values(validatedData).reduce((sum, arr) => sum + (arr ? arr.length : 0), 0);
  if (totalExtracted < 3 && text.trim().length > 20) {
    const rawLines = text.split('\n').map(l=>l.trim()).filter(l=>l.length>2);
    if (!validatedData.rawLines) validatedData.rawLines = [];
    rawLines.forEach(l => validatedData.rawLines.push(l));
    // Also try to add to FIELD_CONFIG if not already
    if (!FIELD_CONFIG.find(f=>f.key==='rawLines')) {
      FIELD_CONFIG.push({ key:'rawLines', label:'📄 All Extracted Lines', color:'#475569' });
    }
  }
  
  // Calculate data quality
  const quality = calculateDataQuality(validatedData);
  
  // Log to console for debugging
  logExtractedData(validatedData);
  
  // Enhanced success message
  const lines = text.split('\n').filter(l => l.trim()).length;
  const fieldsFound = Object.values(validatedData).reduce((s,a)=>s+(a?a.length:0),0);
  showOCRStatus(`✅ Done! ${lines} lines · ${fieldsFound} data fields · ${quality.qualityScore}% quality`, "#27ae60");
  showToast(`✅ Extraction complete! ${fieldsFound} fields found`);
  
  // Store validated data globally for export
  window.lastExtractedData = validatedData;
  
  // Accumulate scan rows for multi-scan export
  if (!window.accumulatedScans) window.accumulatedScans = [];
  window.accumulatedScans.push(validatedData);
  
  // Render the live preview panel
  renderExtractionPreview(validatedData, quality);
}

/* ===== SMART TYPE CAST: read numbers as numbers, text as text ===== */
function smartCast(value) {
  if (value === null || value === undefined || value === '') return '';
  const str = String(value).trim();
  // Pure integer (no leading zero that signals a code like passport/phone)
  if (/^\d+$/.test(str) && str.length <= 12 && !str.startsWith('0')) {
    const n = Number(str);
    if (!isNaN(n)) return n;
  }
  // Decimal number
  if (/^\d{1,10}[.,]\d{1,4}$/.test(str)) {
    const n = parseFloat(str.replace(',', '.'));
    if (!isNaN(n)) return n;
  }
  // Return as text
  return str;
}

/* ===== EXPORT EXTRACTED DATA AS EXCEL (MEGA UPGRADED) ===== */
function exportExtractedExcel(){
  const text = document.getElementById("ocrResult").value;
  if(!text.trim()){
    showToast('❌ No data to export!');
    return;
  }
  
  // Use validated data if available, otherwise extract fresh
  let smartData = window.lastExtractedData || validateAndCorrectData(smartExtractAll(text));
  
  // Create workbook
  const wb = XLSX.utils.book_new();
  
  // ── SHEET 1: ONE LINE PER SCAN (all fields on the same row) ──────────────
  // Build dynamic headers from all non-empty categories
  const oneLineHeaders = [];

  // Fixed column order for hospitality workflow
  const fieldOrder = [
    { key: 'names',         label: 'Guest Name(s)' },
    { key: 'checkin',       label: 'Check-In' },
    { key: 'checkout',      label: 'Check-Out' },
    { key: 'nights',        label: 'Nights' },
    { key: 'pax',           label: 'Pax / Guests' },
    { key: 'dates',         label: 'Other Dates' },
    { key: 'hotels',        label: 'Hotel' },
    { key: 'roomTypes',     label: 'Room Type' },
    { key: 'mealPlans',     label: 'Meal Plan' },
    { key: 'confirmations', label: 'Confirmation No.' },
    { key: 'passports',     label: 'Passport No.' },
    { key: 'idNumbers',     label: 'ID / Iqama No.' },
    { key: 'visaData',      label: 'Visa Info' },
    { key: 'nationalities', label: 'Nationality' },
    { key: 'genderTitle',   label: 'Gender / Title' },
    { key: 'phones',        label: 'All Numbers' },
    { key: 'emails',        label: 'Email' },
    { key: 'amounts',       label: 'Amount' },
    { key: 'flights',       label: 'Flight No.' },
    { key: 'cities',        label: 'City / Destination' },
    { key: 'addresses',     label: 'Address' },
    { key: 'remarks',       label: 'Remarks / Notes' },
    { key: 'roomingRows',   label: 'Rooming Row' },
  ];

  // Use all accumulated scans if available, otherwise just current
  const scansToExport = (window.accumulatedScans && window.accumulatedScans.length > 0)
    ? window.accumulatedScans
    : [smartData];

  // Determine max columns needed across all scans
  const headerSet = new Map(); // label -> max count
  scansToExport.forEach(scan => {
    fieldOrder.forEach(({ key, label }) => {
      const values = scan[key];
      if (values && values.length > 0) {
        const prev = headerSet.get(label) || 0;
        headerSet.set(label, Math.max(prev, values.length));
      }
    });
  });

  // Build headers
  headerSet.forEach((count, label) => {
    if (count === 1) {
      oneLineHeaders.push(label);
    } else {
      for (let i = 1; i <= count; i++) {
        oneLineHeaders.push(`${label} ${i}`);
      }
    }
  });

  // Build rows (one per scan)
  const oneLineRows = scansToExport.map((scan, scanIdx) => {
    const row = [];
    headerSet.forEach((count, label) => {
      // Find the field key for this label
      const fieldDef = fieldOrder.find(f => f.label === label);
      if (!fieldDef) { for (let i = 0; i < count; i++) row.push(''); return; }
      const values = scan[fieldDef.key] || [];
      for (let i = 0; i < count; i++) {
        row.push(values[i] !== undefined ? smartCast(values[i]) : '');
      }
    });
    return row;
  });

  if (oneLineHeaders.length > 0) {
    const ws0 = XLSX.utils.aoa_to_sheet([oneLineHeaders, ...oneLineRows]);
    // Auto-width columns
    ws0["!cols"] = oneLineHeaders.map(h => ({ wpx: Math.max(h.length * 9, 100) }));
    XLSX.utils.book_append_sheet(wb, ws0, "📋 One Line");
  }

  // ── SHEET 2: Raw extracted text ──────────────────────────────────────────
  const lines = text.split("\n").filter(l => l.trim());
  const rawData = [["Extracted Text"]];
  lines.forEach(line => {
    rawData.push([line.trim()]);
  });
  const ws1 = XLSX.utils.aoa_to_sheet(rawData);
  ws1["!cols"] = [{wpx:500}];
  XLSX.utils.book_append_sheet(wb, ws1, "Raw Text");
  
  // ── SHEET 3: Validated smart extracted data (typed) ──────────────────────
  const structuredData = [["Category", "Value", "Status"]];
  
  Object.entries(smartData).forEach(([category, values]) => {
    if (values && values.length > 0) {
      structuredData.push([category.toUpperCase(), '', '']);
      values.forEach(value => {
        structuredData.push(['', smartCast(value), '✓ Valid']);
      });
      structuredData.push(['', '', '']);
    }
  });
  
  const ws2 = XLSX.utils.aoa_to_sheet(structuredData);
  ws2["!cols"] = [{wpx:150}, {wpx:300}, {wpx:100}];
  XLSX.utils.book_append_sheet(wb, ws2, "Extracted Data");
  
  // ── SHEET 4: Organized by type ───────────────────────────────────────────
  const organizedData = [];
  
  if (smartData.names && smartData.names.length > 0) {
    organizedData.push(['GUEST INFORMATION', '', '']);
    organizedData.push(['Names:', '', '']);
    smartData.names.forEach((name, i) => {
      organizedData.push(['', `${i + 1}. ${name}`, '']);
    });
    organizedData.push(['', '', '']);
  }
  
  if ((smartData.emails && smartData.emails.length > 0) || (smartData.phones && smartData.phones.length > 0)) {
    organizedData.push(['CONTACT INFORMATION', '', '']);
    if (smartData.emails && smartData.emails.length > 0) {
      organizedData.push(['Emails:', '', '']);
      smartData.emails.forEach(email => {
        organizedData.push(['', email, '']);
      });
    }
    if (smartData.phones && smartData.phones.length > 0) {
      organizedData.push(['Phones:', '', '']);
      smartData.phones.forEach(phone => {
        organizedData.push(['', phone, '']);
      });
    }
    organizedData.push(['', '', '']);
  }
  
  if ((smartData.confirmations && smartData.confirmations.length > 0) || 
      (smartData.hotels && smartData.hotels.length > 0) ||
      (smartData.roomTypes && smartData.roomTypes.length > 0)) {
    organizedData.push(['BOOKING DETAILS', '', '']);
    if (smartData.confirmations && smartData.confirmations.length > 0) {
      organizedData.push(['Confirmation Numbers:', '', '']);
      smartData.confirmations.forEach(conf => {
        organizedData.push(['', conf, '']);
      });
    }
    if (smartData.hotels && smartData.hotels.length > 0) {
      organizedData.push(['Hotels:', '', '']);
      smartData.hotels.forEach(hotel => {
        organizedData.push(['', hotel, '']);
      });
    }
    if (smartData.roomTypes && smartData.roomTypes.length > 0) {
      organizedData.push(['Room Types:', smartData.roomTypes.join(', '), '']);
    }
    if (smartData.mealPlans && smartData.mealPlans.length > 0) {
      organizedData.push(['Meal Plans:', smartData.mealPlans.join(', '), '']);
    }
    organizedData.push(['', '', '']);
  }
  
  if ((smartData.checkin && smartData.checkin.length > 0) || 
      (smartData.checkout && smartData.checkout.length > 0) ||
      (smartData.dates && smartData.dates.length > 0)) {
    organizedData.push(['TRAVEL DATES', '', '']);
    if (smartData.checkin && smartData.checkin.length > 0) {
      organizedData.push(['Check-in:', smartData.checkin.join(', '), '']);
    }
    if (smartData.checkout && smartData.checkout.length > 0) {
      organizedData.push(['Check-out:', smartData.checkout.join(', '), '']);
    }
    if (smartData.dates && smartData.dates.length > 0) {
      organizedData.push(['Other Dates:', '', '']);
      smartData.dates.forEach(date => {
        organizedData.push(['', date, '']);
      });
    }
    organizedData.push(['', '', '']);
  }
  
  if ((smartData.passports && smartData.passports.length > 0) || 
      (smartData.nationalities && smartData.nationalities.length > 0)) {
    organizedData.push(['TRAVEL DOCUMENTS', '', '']);
    if (smartData.passports && smartData.passports.length > 0) {
      organizedData.push(['Passport Numbers:', '', '']);
      smartData.passports.forEach(passport => {
        organizedData.push(['', passport, '']);
      });
    }
    if (smartData.nationalities && smartData.nationalities.length > 0) {
      organizedData.push(['Nationalities:', smartData.nationalities.join(', '), '']);
    }
    organizedData.push(['', '', '']);
  }
  
  if (smartData.amounts && smartData.amounts.length > 0) {
    organizedData.push(['FINANCIAL INFORMATION', '', '']);
    organizedData.push(['Amounts:', '', '']);
    smartData.amounts.forEach(amount => {
      // amounts: keep as typed (number if pure number)
      organizedData.push(['', smartCast(amount), '']);
    });
    organizedData.push(['', '', '']);
  }
  
  if ((smartData.flights && smartData.flights.length > 0) || 
      (smartData.cities && smartData.cities.length > 0)) {
    organizedData.push(['FLIGHT & DESTINATION', '', '']);
    if (smartData.flights && smartData.flights.length > 0) {
      organizedData.push(['Flight Numbers:', smartData.flights.join(', '), '']);
    }
    if (smartData.cities && smartData.cities.length > 0) {
      organizedData.push(['Cities/Destinations:', smartData.cities.join(', '), '']);
    }
  }
  
  if (organizedData.length > 0) {
    const ws3 = XLSX.utils.aoa_to_sheet(organizedData);
    ws3["!cols"] = [{wpx:180}, {wpx:300}, {wpx:80}];
    XLSX.utils.book_append_sheet(wb, ws3, "Organized Data");
  }
  
  // ── SHEET 5: Summary statistics ──────────────────────────────────────────
  const quality = calculateDataQuality(smartData);
  const stats = [];
  stats.push(['EXTRACTION SUMMARY', '', '']);
  stats.push(['', '', '']);
  stats.push(['Data Type', 'Count', 'Status']);
  
  Object.entries(smartData).forEach(([category, values]) => {
    if (values && values.length > 0) {
      const status = values.length > 0 ? '✓' : '✗';
      stats.push([category.charAt(0).toUpperCase() + category.slice(1), values.length, status]);
    }
  });
  
  stats.push(['', '', '']);
  stats.push(['QUALITY METRICS', '', '']);
  stats.push(['Total Lines', lines.length, '']);
  stats.push(['Total Characters', text.length, '']);
  stats.push(['Data Fields Extracted', quality.totalFields, '']);
  stats.push(['Valid Fields', quality.validFields, '']);
  stats.push(['Quality Score', quality.qualityScore + '%', quality.qualityScore >= 80 ? '✓ High' : quality.qualityScore >= 60 ? '⚠ Medium' : '✗ Low']);
  stats.push(['', '', '']);
  stats.push(['Extraction Date', new Date().toLocaleString(), '']);
  
  const ws4 = XLSX.utils.aoa_to_sheet(stats);
  ws4["!cols"] = [{wpx:180}, {wpx:120}, {wpx:100}];
  XLSX.utils.book_append_sheet(wb, ws4, "Summary");
  
  // Generate filename with timestamp
  const fileName = `Smart_Extraction_${new Date().toISOString().slice(0,10)}_${Date.now()}.xlsx`;
  addXlsxWatermark(wb);
  XLSX.writeFile(wb, fileName);
  
  const scanCount = (window.accumulatedScans && window.accumulatedScans.length) || 1;
  showToast(`✅ Excel exported! ${scanCount} scan row${scanCount > 1 ? 's' : ''} — 5 sheets — Quality: ${quality.qualityScore}%`);
}

/* ===== EXPORT EXTRACTED DATA AS TEXT FILE ===== */
function exportExtractedText(){
  let text = document.getElementById("ocrResult").value;
  if(!text.trim()){
    showToast('❌ No data to export!');
    return;
  }
  
  text = addTextWatermark(text);
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Extracted_Data_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('✅ Text file downloaded!');
}

/* ===== ROOMING → EXCEL (FORMATTED) ===== */
function exportRoomingExcel(){
  const rows = document.querySelectorAll(".rooming-row");
  const data = [["Guest Name","Rooms","Room Type","Meal Plan","View"]];

  rows.forEach(r=>{
    const inputs = r.querySelectorAll("input");
    data.push([
      inputs[0].value,
      inputs[1].value,
      inputs[2].value,
      inputs[3].value,
      inputs[4].value
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(data);
  ws["!cols"] = [{wpx:200},{wpx:80},{wpx:100},{wpx:100},{wpx:100}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Rooming List");
  XLSX.writeFile(wb, "Rooming_List.xlsx");
}

/* ===== SEND TO ROOMING (SMART) ===== */
function sendToRooming(){
  const text = document.getElementById("ocrResult").value;
  const lines = text.split("\n").filter(l=>l.trim());
  const container = document.getElementById("roomingList");
  container.innerHTML="";

  lines.forEach(line=>{
    const roomType = detectRoomType(line);
    const meal = detectMealPlan(line);
    // Additional logic would go here
  });
}

/* ===== DATA VALIDATION AND CORRECTION SYSTEM (MEGA ENHANCED) ===== */

// Common English first names database for validation
const commonFirstNames = ['JOHN', 'MARY', 'JAMES', 'PATRICIA', 'ROBERT', 'JENNIFER', 'MICHAEL', 'LINDA', 
  'WILLIAM', 'ELIZABETH', 'DAVID', 'BARBARA', 'RICHARD', 'SUSAN', 'JOSEPH', 'JESSICA', 'THOMAS', 'SARAH',
  'CHARLES', 'KAREN', 'CHRISTOPHER', 'NANCY', 'DANIEL', 'MARGARET', 'MATTHEW', 'LISA', 'ANTHONY', 'BETTY',
  'MARK', 'DOROTHY', 'DONALD', 'SANDRA', 'STEVEN', 'ASHLEY', 'PAUL', 'KIMBERLY', 'ANDREW', 'DONNA',
  'JOSHUA', 'EMILY', 'KENNETH', 'MICHELLE', 'KEVIN', 'CAROL', 'BRIAN', 'AMANDA', 'GEORGE', 'MELISSA',
  'AHMED', 'MOHAMMED', 'MUHAMMAD', 'ALI', 'OMAR', 'HASSAN', 'IBRAHIM', 'KHALID', 'ABDUL', 'ABDULLAH',
  'FATIMA', 'AISHA', 'MARYAM', 'ZAINAB', 'SARAH', 'NOOR', 'LAYLA', 'AMINA', 'KHADIJA', 'RANIA'];

// Common last names for validation
const commonLastNames = ['SMITH', 'JOHNSON', 'WILLIAMS', 'BROWN', 'JONES', 'GARCIA', 'MILLER', 'DAVIS',
  'RODRIGUEZ', 'MARTINEZ', 'HERNANDEZ', 'LOPEZ', 'GONZALEZ', 'WILSON', 'ANDERSON', 'THOMAS', 'TAYLOR',
  'MOORE', 'JACKSON', 'MARTIN', 'LEE', 'PEREZ', 'THOMPSON', 'WHITE', 'HARRIS', 'SANCHEZ', 'CLARK',
  'KHAN', 'AHMED', 'ALI', 'HASSAN', 'HUSSEIN', 'RAHMAN', 'ABDULLAH', 'MOHAMMED', 'IBRAHIM'];

// Calculate Levenshtein distance for spell checking
function levenshteinDistance(str1, str2) {
  const matrix = [];
  
  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }
  
  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }
  
  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }
  
  return matrix[str2.length][str1.length];
}

// Auto-correct name using dictionary
function spellCheckName(name) {
  const words = name.toUpperCase().split(' ');
  const corrected = words.map((word, index) => {
    // Check against common names
    const nameList = index === 0 ? commonFirstNames : commonLastNames;
    
    // If exact match, return it
    if (nameList.includes(word)) return word;
    
    // Find closest match
    let minDistance = Infinity;
    let bestMatch = word;
    
    nameList.forEach(commonName => {
      const distance = levenshteinDistance(word, commonName);
      // Only suggest if very close (distance <= 2)
      if (distance < minDistance && distance <= 2 && distance > 0) {
        minDistance = distance;
        bestMatch = commonName;
      }
    });
    
    return bestMatch;
  });
  
  // Return with proper capitalization
  return corrected.map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' ');
}

// Validate and correct email addresses (ENHANCED)
function validateEmail(email) {
  // Remove spaces
  email = email.replace(/\s/g, '');
  
  // Common OCR corrections
  email = email
    .replace(/\[at\]/gi, '@')
    .replace(/\(at\)/gi, '@')
    .replace(/\s*dot\s*/gi, '.')
    .replace(/0(?=@)/g, 'o')
    .replace(/O(?=@)/gi, 'o')
    .replace(/1(?=@)/g, 'l')
    .replace(/rn/g, 'm')
    .replace(/[|]/g, 'l')
    .toLowerCase();
  
  // Check basic format
  const emailRegex = /^[a-zA-Z0-9][a-zA-Z0-9._%+-]*@[a-zA-Z0-9][a-zA-Z0-9.-]*\.[a-zA-Z]{2,}$/;
  if (!emailRegex.test(email)) return null;
  
  // Validate TLD
  const tld = email.split('.').pop().toLowerCase();
  const validTLDs = ['com', 'net', 'org', 'edu', 'gov', 'mil', 'co', 'uk', 'us', 'ca', 'au', 
                     'de', 'fr', 'jp', 'cn', 'in', 'br', 'sa', 'ae', 'eg', 'io', 'me', 'info', 
                     'biz', 'mobi', 'name', 'tel', 'travel', 'xxx', 'asia', 'tv'];
  if (!validTLDs.includes(tld)) return null;
  
  // Fix common domain typos
  email = email
    .replace(/@gmai\.com$/, '@gmail.com')
    .replace(/@gmaii\.com$/, '@gmail.com')
    .replace(/@grnail\.com$/, '@gmail.com')
    .replace(/@hotmaii\.com$/, '@hotmail.com')
    .replace(/@yah00\.com$/, '@yahoo.com')
    .replace(/@yahooo\.com$/, '@yahoo.com');
  
  return email;
}

// Validate and correct phone numbers (ENHANCED)
function validatePhone(phone) {
  // Remove common OCR errors in numbers
  phone = phone
    .replace(/[oO]/g, '0')
    .replace(/[lI]/g, '1')
    .replace(/[S]/g, '5')
    .replace(/[B]/g, '8')
    .replace(/[Z]/g, '2')
    .replace(/[G]/g, '6')
    .replace(/[b]/g, '6')
    .replace(/[A]/g, '4');
  
  // Check if it has enough digits
  const digitCount = (phone.match(/\d/g) || []).length;
  if (digitCount < 7 || digitCount > 15) return null;
  
  // Format nicely
  phone = phone.replace(/\s+/g, ' ').trim();
  
  return phone;
}

// Validate and correct dates (ENHANCED)
function validateDate(dateStr) {
  // Remove extra spaces
  dateStr = dateStr.replace(/\s+/g, ' ').trim();
  
  let day, month, year;
  
  // Try DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
  let match = dateStr.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
  if (match) {
    day = parseInt(match[1]);
    month = parseInt(match[2]);
    year = parseInt(match[3]);
  } else {
    // Try YYYY-MM-DD or YYYY/MM/DD
    match = dateStr.match(/(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})/);
    if (match) {
      year = parseInt(match[1]);
      month = parseInt(match[2]);
      day = parseInt(match[3]);
    } else {
      return null;
    }
  }
  
  // Validate ranges
  if (day < 1 || day > 31) return null;
  if (month < 1 || month > 12) return null;
  if (year < 1900 || year > 2100) return null;
  
  // Check if date is valid (handles Feb 30, etc.)
  const date = new Date(year, month - 1, day);
  if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
    return null;
  }
  
  // Return in standard format DD/MM/YYYY
  return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
}

// Validate passport number (ENHANCED)
function validatePassport(passport) {
  // Remove spaces and convert to uppercase
  passport = passport.replace(/\s/g, '').toUpperCase();
  
  // Fix common OCR errors
  passport = passport
    .replace(/O/g, '0')  // In passport numbers, O is usually 0
    .replace(/I/g, '1')  // I is usually 1
    .replace(/S/g, '5')
    .replace(/B/g, '8');
  
  // Reverse the O->0 for letter positions (first 1-2 chars should be letters)
  const parts = passport.match(/^([A-Z0-9]{1,2})(\d+)$/);
  if (parts) {
    let letters = parts[1].replace(/0/g, 'O').replace(/1/g, 'I');
    let numbers = parts[2];
    passport = letters + numbers;
  }
  
  // Check format (common patterns)
  if (!/^[A-Z]{1,2}\d{6,9}$/.test(passport) && !/^[A-Z]\d{7,8}$/.test(passport)) {
    return null;
  }
  
  return passport;
}

// Auto-correct common OCR mistakes in names (ENHANCED)
function correctName(name) {
  // Remove extra spaces
  name = name.replace(/\s+/g, ' ').trim();
  
  // Fix common OCR errors BEFORE capitalization
  name = name
    .replace(/\b0/g, 'O')           // 0 at start of word -> O
    .replace(/1(?=[a-z])/g, 'I')    // 1 before lowercase -> I
    .replace(/rn(?=[a-z])/g, 'm')   // rn -> m (very common)
    .replace(/\|/g, 'I')
    .replace(/vv/g, 'w')
    .replace(/tti/g, 'tti')
    .replace(/cl/g, 'd');
  
  // Capitalize properly
  name = name.split(' ').map(word => {
    // Handle abbreviations (e.g., "O'Brien", "McDonald")
    if (word.includes("'")) {
      return word.split("'").map(part => 
        part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
      ).join("'");
    }
    
    // Handle Scottish/Irish names (Mc, Mac)
    if (word.toLowerCase().startsWith('mc') && word.length > 2) {
      return 'Mc' + word.charAt(2).toUpperCase() + word.slice(3).toLowerCase();
    }
    if (word.toLowerCase().startsWith('mac') && word.length > 3) {
      return 'Mac' + word.charAt(3).toUpperCase() + word.slice(4).toLowerCase();
    }
    
    // Handle Van, Von, De, etc.
    if (['van', 'von', 'de', 'da', 'del', 'della', 'di'].includes(word.toLowerCase())) {
      return word.toLowerCase();
    }
    
    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
  }).join(' ');
  
  // Apply spell checking for common names
  name = spellCheckName(name);
  
  return name;
}

// Validate and auto-correct all extracted data (MEGA ENHANCED)
function validateAndCorrectData(data) {
  const corrected = {
    names:         (data.names||[]).map(correctName).filter(n => n && n.length > 2),
    emails:        (data.emails||[]).map(validateEmail).filter(Boolean),
    phones:        (data.phones||[]).map(validatePhone).filter(Boolean),
    dates:         (data.dates||[]).map(d => d.startsWith('Hijri:') ? d : validateDate(d)).filter(Boolean),
    checkin:       (data.checkin||[]).map(validateDate).filter(Boolean),
    checkout:      (data.checkout||[]).map(validateDate).filter(Boolean),
    nights:        (data.nights||[]),
    pax:           (data.pax||[]),
    passports:     (data.passports||[]).map(validatePassport).filter(Boolean),
    idNumbers:     (data.idNumbers||[]),
    visaData:      (data.visaData||[]),
    confirmations: (data.confirmations||[]),
    nationalities: (data.nationalities||[]),
    amounts:       (data.amounts||[]),
    roomTypes:     (data.roomTypes||[]),
    mealPlans:     (data.mealPlans||[]),
    hotels:        (data.hotels||[]),
    flights:       (data.flights||[]),
    cities:        (data.cities||[]),
    addresses:     (data.addresses||[]),
    genderTitle:   (data.genderTitle||[]),
    remarks:       (data.remarks||[]),
    roomingRows:   (data.roomingRows||[]),
  };

  // Remove duplicates from all arrays
  Object.keys(corrected).forEach(key => {
    if (Array.isArray(corrected[key])) {
      corrected[key] = [...new Set(corrected[key])];
    }
  });

  return corrected;
}

// Calculate data quality score (ENHANCED with field weighting)
function calculateDataQuality(data) {
  let totalFields = 0;
  let validFields = 0;
  let categoryScores = {};
  
  // Field importance weights (higher = more important for quality score)
  const fieldWeights = {
    names: 3, checkin: 3, checkout: 3, passports: 3, confirmations: 2,
    hotels: 2, roomTypes: 2, mealPlans: 2, phones: 1, emails: 2,
    nationalities: 1, amounts: 1, flights: 1, dates: 1, nights: 2, pax: 1,
    idNumbers: 2, visaData: 2, genderTitle: 1, cities: 1, addresses: 1, remarks: 1
  };
  
  Object.entries(data).forEach(([category, values]) => {
    if (values && Array.isArray(values) && values.length > 0) {
      const weight = fieldWeights[category] || 1;
      totalFields += values.length * weight;
      validFields += values.length * weight;
      categoryScores[category] = values.length;
    }
  });
  
  // Bonus: name + dates + hotel all found = high confidence doc
  const hasCore = (data.names?.length > 0) &&
                  ((data.checkin?.length > 0) || (data.dates?.length > 0)) &&
                  (data.hotels?.length > 0 || data.confirmations?.length > 0);
  
  const rawScore = totalFields > 0 ? Math.round((validFields / Math.max(totalFields, 15)) * 100) : 0;
  const qualityScore = Math.min(100, rawScore + (hasCore ? 15 : 0));
  
  let confidence = 'Low';
  if (totalFields >= 20 || hasCore) confidence = 'High';
  else if (totalFields >= 8) confidence = 'Medium';
  
  return { 
    totalFields, 
    validFields, 
    qualityScore, 
    confidence,
    categoryScores 
  };
}

/* ===== ADVANCED DATA EXTRACTION UTILITIES (MEGA UPGRADED) ===== */

// Extract all names from text with MAXIMUM accuracy
function extractNames(text) {
  const names = new Set();
  const lines = text.split('\n');
  
  // Pattern 1: After labels like "Name:", "Guest:", "PAX:"
  const labelPattern = /(?:name|guest|pax|passenger|client|traveler|booker|holder)[\s:]+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,4})/gi;
  let matches = text.matchAll(labelPattern);
  for (let match of matches) {
    if (match[1] && match[1].length > 3) names.add(match[1].trim());
  }
  
  // Pattern 2: Title + Name (Mr, Mrs, Ms, Dr)
  const titlePattern = /(?:Mr|Mrs|Ms|Dr|Miss|Prof|Sir|Eng|Capt|Col|Gen)\.?\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,4})/g;
  matches = text.matchAll(titlePattern);
  for (let match of matches) {
    if (match[1] && match[1].length > 3) names.add(match[1].trim());
  }
  
  // Pattern 3: Full capitalized names (2-4 words)
  const capsPattern = /\b([A-Z][A-Z]+(?:\s+[A-Z][A-Z]+){1,3})\b/g;
  matches = text.matchAll(capsPattern);
  for (let match of matches) {
    const name = match[1].trim();
    const excludeWords = ['PASSPORT', 'VISA', 'NATIONALITY', 'NUMBER', 'DATE', 'BIRTH', 'ISSUE', 'EXPIRY', 
                          'VALID', 'UNTIL', 'TYPE', 'CARD', 'IDENTITY', 'REPUBLIC', 'KINGDOM', 'UNITED',
                          'STATES', 'DOCUMENT', 'TRAVEL', 'PERSONAL', 'GIVEN', 'SURNAME', 'GENDER', 'CODE'];
    
    if (name.length > 5 && name.split(' ').length >= 2 && name.split(' ').length <= 4) {
      // Check if it's not in exclude list
      const isExcluded = excludeWords.some(word => name.includes(word));
      if (!isExcluded) {
        names.add(name.split(' ').map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' '));
      }
    }
  }
  
  // Pattern 4: Mixed case names (FirstName LastName)
  const mixedPattern = /\b([A-Z][a-z]{2,}\s+[A-Z][a-z]{2,}(?:\s+[A-Z][a-z]{2,})?(?:\s+[A-Z][a-z]{2,})?)\b/g;
  matches = text.matchAll(mixedPattern);
  for (let match of matches) {
    const name = match[1].trim();
    const words = name.split(' ');
    const excludeWords = ['Date Of', 'Place Of', 'Date and', 'Given Names', 'Family Name'];
    const isExcluded = excludeWords.some(phrase => name.includes(phrase));
    
    if (!isExcluded && words.length >= 2 && words.length <= 4 && words.every(w => w.length >= 3)) {
      names.add(name);
    }
  }
  
  // Pattern 5: Arabic names
  const arabicPattern = /[\u0600-\u06FF]{3,}(?:\s+[\u0600-\u06FF]{3,}){1,3}/g;
  matches = text.match(arabicPattern);
  if (matches) {
    matches.forEach(name => {
      if (name.length > 5 && name.split(' ').length >= 2 && name.split(' ').length <= 4) {
        names.add(name.trim());
      }
    });
  }
  
  // Pattern 6: Names in format "SURNAME, Firstname"
  const surnameFirstPattern = /([A-Z]{2,}),\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/g;
  matches = text.matchAll(surnameFirstPattern);
  for (let match of matches) {
    const surname = match[1].charAt(0) + match[1].slice(1).toLowerCase();
    const firstname = match[2];
    names.add(`${firstname} ${surname}`);
  }
  
  // Filter and clean results
  const filteredNames = Array.from(names).filter(name => {
    // Remove names that are too short or too long
    if (name.length < 4 || name.length > 60) return false;
    
    // Remove names with numbers
    if (/\d/.test(name)) return false;
    
    // Remove names with too many special characters
    if ((name.match(/[^a-zA-Z\u0600-\u06FF\s]/g) || []).length > 2) return false;
    
    return true;
  });
  
  return filteredNames;
}

// Extract all emails with validation
function extractEmails(text) {
  const emailPattern = /\b[a-zA-Z0-9][a-zA-Z0-9._%+-]*@[a-zA-Z0-9][a-zA-Z0-9.-]*\.[a-zA-Z]{2,}\b/g;
  const emails = text.match(emailPattern) || [];
  
  // Validate and filter
  return Array.from(new Set(emails.filter(email => {
    // Must have valid TLD
    const tld = email.split('.').pop().toLowerCase();
    const validTLDs = ['com', 'net', 'org', 'edu', 'gov', 'mil', 'co', 'uk', 'us', 'ca', 'au', 
                       'de', 'fr', 'jp', 'cn', 'in', 'br', 'sa', 'ae', 'eg', 'io', 'me', 'info'];
    return validTLDs.includes(tld);
  })));
}

// ══════════════════════════════════════════════════════════════════
//  extractAllNumbers — catches EVERY number sequence in the document
// ══════════════════════════════════════════════════════════════════
function extractAllNumbers(text) {
  const numbers = new Set();

  // 1. International phone: +XX... or 00XX...
  for (let m of text.matchAll(/(\+\d{1,4}[\s\-]?[\d\s\-\(\)]{6,18})/g)) {
    const cleaned = m[1].replace(/\s+/g,' ').trim();
    if ((cleaned.match(/\d/g)||[]).length >= 7) numbers.add(cleaned);
  }
  for (let m of text.matchAll(/(00\d{1,4}[\s\-]?[\d\s\-]{6,16})/g)) {
    const cleaned = m[1].replace(/\s+/g,' ').trim();
    if ((cleaned.match(/\d/g)||[]).length >= 7) numbers.add(cleaned);
  }

  // 2. Any standalone digit sequence 4–18 digits (IDs, phones, codes, amounts, rooms)
  for (let m of text.matchAll(/\b(\d[\d\s\-\.]{2,17}\d)\b/g)) {
    const raw = m[1].replace(/\s+/g,' ').trim();
    const digitsOnly = raw.replace(/\D/g,'');
    if (digitsOnly.length >= 4 && digitsOnly.length <= 18) {
      numbers.add(raw);
    }
  }

  // 3. Arabic-Indic digits (٠١٢٣٤٥٦٧٨٩)
  for (let m of text.matchAll(/[\u0660-\u0669]{3,}/g)) {
    numbers.add(m[0]);
  }

  // 4. Numbers with labels (extract the number part)
  const labelPatterns = [
    /(?:phone|mobile|tel|fax|cell|mob)[\s:#\-]*([+\d][\d\s\-\(\)]{5,18})/gi,
    /(?:id|iqama|national)[\s:#\-]*(\d{6,15})/gi,
    /(?:passport|pp)[\s:#\-]*([A-Z]{0,2}\d{5,12})/gi,
    /(?:amount|total|price|cost|fee|charge|rate)[\s:#\-]*([0-9,\.]+)/gi,
    /(?:room|floor|suite|no\.?)[\s:#\-]*(\d{1,6})/gi,
    /(?:hcn|cnf|ref|booking|reservation|confirmation)[\s:#\-]*([A-Z0-9]{4,14})/gi,
  ];
  labelPatterns.forEach(p => {
    for (let m of text.matchAll(p)) {
      if (m[1]) numbers.add(m[1].trim());
    }
  });

  // Deduplicate: remove values already captured as substrings of longer ones
  const arr = [...numbers].filter(n => n.replace(/\D/g,'').length >= 4 || /[A-Z]/.test(n));
  return [...new Set(arr)];
}

// Keep extractPhones as alias so nothing else breaks
function extractPhones(text) { return extractAllNumbers(text); }

// Extract all dates in multiple formats (ENHANCED)
function extractDates(text) {
  const dates = new Set();
  
  // DD/MM/YYYY or DD-MM-YYYY
  const dmyPattern = /\b(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})\b/g;
  let matches = text.matchAll(dmyPattern);
  for (let match of matches) {
    const day = parseInt(match[1]);
    const month = parseInt(match[2]);
    const year = parseInt(match[3]);
    // Validate date
    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
      dates.add(match[0]);
    }
  }
  
  // YYYY-MM-DD or YYYY/MM/DD
  const ymdPattern = /\b(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})\b/g;
  matches = text.matchAll(ymdPattern);
  for (let match of matches) {
    const year = parseInt(match[1]);
    const month = parseInt(match[2]);
    const day = parseInt(match[3]);
    if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2100) {
      dates.add(match[0]);
    }
  }
  
  // DD Month YYYY (e.g., 25 December 2025, 25 Dec 2025)
  const textDatePattern = /\b(\d{1,2})\s+(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{4})\b/gi;
  matches = text.matchAll(textDatePattern);
  for (let match of matches) {
    dates.add(match[0]);
  }
  
  // Month DD, YYYY (e.g., December 25, 2025)
  const usDatePattern = /\b(January|February|March|April|May|June|July|August|September|October|November|December|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{1,2}),?\s+(\d{4})\b/gi;
  matches = text.matchAll(usDatePattern);
  for (let match of matches) {
    dates.add(match[0]);
  }
  
  return Array.from(dates);
}

// Extract passport numbers (ENHANCED)
function extractPassportNumbers(text) {
  const passports = new Set();
  
  // Common passport formats
  // 2 letters + 6-9 digits
  const pattern1 = /\b([A-Z]{2}\d{6,9})\b/g;
  let matches = text.match(pattern1);
  if (matches) matches.forEach(p => passports.add(p));
  
  // 1 letter + 7-8 digits
  const pattern2 = /\b([A-Z]\d{7,8})\b/g;
  matches = text.match(pattern2);
  if (matches) matches.forEach(p => passports.add(p));
  
  // Some countries use different formats
  const pattern3 = /\b([A-Z]{1,2}\d{5,10})\b/g;
  matches = text.match(pattern3);
  if (matches) {
    matches.forEach(p => {
      // Filter out obvious non-passports
      if (p.length >= 7 && p.length <= 12) {
        passports.add(p);
      }
    });
  }
  
  // Pattern from passport label
  const labelPattern = /(?:passport\s*(?:no|number|#)?\s*:?\s*)([A-Z0-9]{6,12})/gi;
  matches = text.matchAll(labelPattern);
  for (let match of matches) {
    if (match[1]) passports.add(match[1].toUpperCase());
  }
  
  return Array.from(passports);
}

// Extract confirmation/reservation numbers (ENHANCED)
function extractConfirmationNumbers(text) {
  const confirmations = new Set();
  
  // HCN, CNF, RES, BKG, CONF followed by alphanumeric
  const pattern1 = /\b(HCN|CNF|RES|BKG|CONF|CONFIRMATION|BOOKING|RESERVATION)[-\s:#]?([A-Z0-9]{4,12})\b/gi;
  let matches = text.matchAll(pattern1);
  for (let match of matches) {
    if (match[2]) confirmations.add(match[1].toUpperCase() + match[2].toUpperCase());
  }
  
  // Generic confirmation patterns (starts with letters, ends with numbers)
  const pattern2 = /\b([A-Z]{2,4}\d{6,10})\b/g;
  matches = text.match(pattern2);
  if (matches) {
    matches.forEach(c => {
      // Filter out dates and other numbers
      if (!/^(19|20)\d{2}/.test(c)) {
        confirmations.add(c);
      }
    });
  }
  
  // Alphanumeric codes often used for confirmations
  const pattern3 = /\b([A-Z0-9]{6,12})\b/g;
  matches = text.match(pattern3);
  if (matches) {
    matches.forEach(c => {
      // Only add if it has both letters and numbers
      if (/[A-Z]/.test(c) && /\d/.test(c) && c.length >= 6 && c.length <= 12) {
        confirmations.add(c);
      }
    });
  }
  
  return Array.from(confirmations);
}

// Extract nationalities (EXPANDED DATABASE)
function extractNationalities(text) {
  const nationalities = [
    // Middle East & North Africa
    'Egyptian', 'Saudi', 'Emirati', 'Kuwaiti', 'Qatari', 'Bahraini', 'Omani', 'Yemeni',
    'Iraqi', 'Syrian', 'Jordanian', 'Lebanese', 'Palestinian', 'Turkish', 'Iranian', 'Israeli',
    'Tunisian', 'Algerian', 'Moroccan', 'Libyan', 'Sudanese', 'Mauritanian',
    
    // Europe
    'British', 'English', 'Scottish', 'Welsh', 'Irish', 'French', 'German', 'Italian', 'Spanish', 
    'Portuguese', 'Dutch', 'Belgian', 'Swiss', 'Austrian', 'Swedish', 'Norwegian', 'Danish', 
    'Finnish', 'Polish', 'Czech', 'Slovak', 'Hungarian', 'Romanian', 'Bulgarian', 'Greek',
    'Russian', 'Ukrainian', 'Croatian', 'Serbian', 'Slovenian', 'Estonian', 'Latvian', 'Lithuanian',
    
    // Asia
    'Indian', 'Pakistani', 'Bangladeshi', 'Chinese', 'Japanese', 'Korean', 'Thai', 'Vietnamese',
    'Indonesian', 'Malaysian', 'Filipino', 'Singaporean', 'Burmese', 'Cambodian', 'Laotian',
    'Nepalese', 'Sri Lankan', 'Afghan', 'Mongolian', 'Taiwanese',
    
    // Africa
    'Somali', 'Ethiopian', 'Kenyan', 'Tanzanian', 'Ugandan', 'Nigerian', 'Ghanaian', 'South African',
    'Zimbabwean', 'Zambian', 'Botswanan', 'Namibian', 'Angolan', 'Mozambican', 'Malawian',
    'Senegalese', 'Ivorian', 'Cameroonian', 'Congolese', 'Rwandan',
    
    // Americas
    'American', 'Canadian', 'Mexican', 'Brazilian', 'Argentinian', 'Chilean', 'Colombian',
    'Peruvian', 'Venezuelan', 'Ecuadorian', 'Bolivian', 'Uruguayan', 'Paraguayan',
    'Cuban', 'Jamaican', 'Haitian', 'Dominican',
    
    // Oceania
    'Australian', 'New Zealander', 'Fijian', 'Papua New Guinean'
  ];
  
  const found = new Set();
  const upperText = text.toUpperCase();
  
  nationalities.forEach(nat => {
    const pattern = new RegExp('\\b' + nat + '\\b', 'gi');
    if (pattern.test(text)) {
      found.add(nat);
    }
  });
  
  return Array.from(found);
}

// Extract amounts/prices (ENHANCED)
function extractAmounts(text) {
  const amounts = new Set();
  
  // Pattern 1: Currency symbol/code + number
  const pattern1 = /(?:USD|EUR|GBP|SAR|EGP|AED|QAR|KWD|OMR|BHD|JOD|TRY|INR|PKR|CNY|JPY|KRW)\s*\$?€?£?¥?\s*\d{1,10}(?:[.,]\d{2,3})?/gi;
  let matches = text.match(pattern1);
  if (matches) matches.forEach(a => amounts.add(a.trim()));
  
  // Pattern 2: Symbol + number
  const pattern2 = /[$€£¥]\s*\d{1,10}(?:[.,]\d{2})?/g;
  matches = text.match(pattern2);
  if (matches) matches.forEach(a => amounts.add(a.trim()));
  
  // Pattern 3: Number + currency code
  const pattern3 = /\b\d{1,10}(?:[.,]\d{2,3})?\s*(?:USD|EUR|GBP|SAR|EGP|AED|QAR|KWD|OMR|BHD|JOD|TRY|INR|PKR|CNY|JPY|KRW)\b/gi;
  matches = text.match(pattern3);
  if (matches) matches.forEach(a => amounts.add(a.trim()));
  
  // Pattern 4: Common price labels
  const pattern4 = /(?:price|cost|amount|total|fee|charge|rate|fare)[\s:]+\$?€?£?¥?\s*\d{1,10}(?:[.,]\d{2})?/gi;
  matches = text.match(pattern4);
  if (matches) {
    matches.forEach(match => {
      const amount = match.match(/\$?€?£?¥?\s*\d{1,10}(?:[.,]\d{2})?/);
      if (amount) amounts.add(amount[0].trim());
    });
  }
  
  return Array.from(amounts);
}

// Extract room types with better patterns (ENHANCED)
function extractRoomTypes(text) {
  const roomTypes = new Set();
  
  // Main room type pattern
  const mainPattern = /\b(SINGLE|DOUBLE|TRIPLE|QUAD|TWIN|KING|QUEEN|SUITE|STUDIO|APARTMENT|VILLA|BUNGALOW|SGL|DBL|TRPL|TPL|QAUD|TWN|KNG|QN|STE|STD|DLX|SUP|EXEC|PRES|JR)(?:\s+(?:DELUXE|SUPERIOR|STANDARD|EXECUTIVE|PRESIDENTIAL|JUNIOR|FAMILY|CONNECTING|ADJOINING))?\b/gi;
  let matches = text.match(mainPattern);
  if (matches) matches.forEach(r => roomTypes.add(r.toUpperCase()));
  
  // View type pattern
  const viewPattern = /\b(?:CITY|SEA|OCEAN|BEACH|POOL|GARDEN|MOUNTAIN|LAKE|VALLEY|RIVER|GOLF|PARK|COURTYARD|PARTIAL|FULL|LIMITED)\s+VIEW\b/gi;
  matches = text.match(viewPattern);
  if (matches) matches.forEach(v => roomTypes.add(v.toUpperCase()));
  
  // Abbreviated view pattern
  const abbrViewPattern = /\b(CV|GV|PV|SV|MV|OV|BV|CITY\s*VIEW|GARDEN\s*VIEW|POOL\s*VIEW|SEA\s*VIEW|MOUNTAIN\s*VIEW|OCEAN\s*VIEW)\b/gi;
  matches = text.match(abbrViewPattern);
  if (matches) matches.forEach(v => roomTypes.add(v.toUpperCase().replace(/\s+/g, ' ')));
  
  return Array.from(roomTypes);
}

// Extract meal plans with more variations (ENHANCED)
function extractMealPlans(text) {
  const mealPlans = new Set();
  
  // Abbreviated formats
  const abbrPattern = /\b(BB|HB|FB|AI|UAI|SC|RO|EP|CP|MAP|AP|B\.B|H\.B|F\.B|A\.I|U\.A\.I|R\.O)\b/gi;
  let matches = text.match(abbrPattern);
  if (matches) matches.forEach(m => mealPlans.add(m.toUpperCase()));
  
  // Full text formats
  const fullPattern = /\b(BED\s+AND\s+BREAKFAST|HALF\s+BOARD|FULL\s+BOARD|ALL\s+INCLUSIVE|ULTRA\s+ALL\s+INCLUSIVE|ROOM\s+ONLY|SELF\s+CATERING|BREAKFAST\s+ONLY|DINNER\s+BED\s+BREAKFAST|BREAKFAST\s+LUNCH|BREAKFAST\s+DINNER)\b/gi;
  matches = text.match(fullPattern);
  if (matches) matches.forEach(m => mealPlans.add(m.toUpperCase().replace(/\s+/g, ' ')));
  
  // Common variations
  const varPattern = /\b(FULL\s+PENSION|HALF\s+PENSION|DEMI\s+PENSION|BED\s+BREAKFAST|CONTINENTAL\s+BREAKFAST|AMERICAN\s+BREAKFAST)\b/gi;
  matches = text.match(varPattern);
  if (matches) matches.forEach(m => mealPlans.add(m.toUpperCase().replace(/\s+/g, ' ')));
  
  return Array.from(mealPlans);
}

// Extract hotel names
function extractHotelNames(text) {
  const hotels = new Set();
  
  // Pattern 1: After "Hotel" keyword
  const pattern1 = /\b([A-Z][A-Za-z\s&'-]+?)\s+(?:Hotel|Resort|Inn|Lodge|Suites?|Residences?|Villas?|Palace|Grand|Plaza)\b/gi;
  let matches = text.matchAll(pattern1);
  for (let match of matches) {
    if (match[0] && match[0].length > 5 && match[0].length < 60) {
      hotels.add(match[0].trim());
    }
  }
  
  // Pattern 2: Hotel/Resort followed by name
  const pattern2 = /\b(?:Hotel|Resort|Inn|Lodge|Suites?)\s+([A-Z][A-Za-z\s&'-]{3,50})\b/gi;
  matches = text.matchAll(pattern2);
  for (let match of matches) {
    if (match[0] && match[0].length > 5) {
      hotels.add(match[0].trim());
    }
  }
  
  return Array.from(hotels);
}

// Extract flight numbers
function extractFlightNumbers(text) {
  const flights = new Set();
  
  // Standard airline code + flight number (e.g., BA123, SV456)
  const pattern1 = /\b([A-Z]{2}\s?\d{3,4})\b/g;
  let matches = text.match(pattern1);
  if (matches) {
    matches.forEach(f => {
      // Filter out dates and other patterns
      if (!/^(19|20)\d{2}/.test(f) && !/^\d{4}/.test(f)) {
        flights.add(f.replace(/\s/g, ''));
      }
    });
  }
  
  // Flight with label
  const pattern2 = /(?:flight|flt)[\s:#]*([A-Z]{2}\s?\d{3,4})/gi;
  matches = text.matchAll(pattern2);
  for (let match of matches) {
    if (match[1]) flights.add(match[1].replace(/\s/g, '').toUpperCase());
  }
  
  return Array.from(flights);
}

// Extract cities/destinations
function extractCities(text) {
  const commonCities = [
    // Saudi Arabia
    'Makkah', 'Mecca', 'Madinah', 'Medina', 'Jeddah', 'Riyadh', 'Dammam', 'Khobar', 'Dhahran', 'Taif', 'Abha', 'Tabuk', 'Yanbu',
    
    // UAE
    'Dubai', 'Abu Dhabi', 'Sharjah', 'Ajman', 'Ras Al Khaimah', 'Fujairah', 'Umm Al Quwain',
    
    // Egypt
    'Cairo', 'Alexandria', 'Giza', 'Sharm El Sheikh', 'Hurghada', 'Luxor', 'Aswan', 'Port Said', 'Dahab', 'Marsa Alam',
    
    // Other Middle East
    'Jerusalem', 'Tel Aviv', 'Amman', 'Petra', 'Aqaba', 'Beirut', 'Damascus', 'Baghdad', 'Basra', 'Istanbul', 'Ankara', 'Antalya',
    
    // Europe
    'London', 'Paris', 'Rome', 'Madrid', 'Barcelona', 'Berlin', 'Munich', 'Vienna', 'Amsterdam', 'Brussels', 'Athens', 'Milan',
    
    // Asia
    'Bangkok', 'Singapore', 'Kuala Lumpur', 'Jakarta', 'Manila', 'Tokyo', 'Seoul', 'Hong Kong', 'Shanghai', 'Beijing', 'Delhi', 'Mumbai',
    
    // Americas
    'New York', 'Los Angeles', 'Chicago', 'Miami', 'Las Vegas', 'Toronto', 'Vancouver', 'Mexico City', 'Sao Paulo', 'Rio de Janeiro'
  ];
  
  const found = new Set();
  
  commonCities.forEach(city => {
    const pattern = new RegExp('\\b' + city + '\\b', 'gi');
    if (pattern.test(text)) {
      found.add(city);
    }
  });
  
  return Array.from(found);
}

// Extract check-in/check-out dates specifically
function extractCheckinCheckout(text) {
  const result = { checkin: [], checkout: [] };
  
  // Check-in patterns
  const checkinPattern = /(?:check[-\s]?in|arrival|arrive|arriving|from)[\s:]*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2})/gi;
  let matches = text.matchAll(checkinPattern);
  for (let match of matches) {
    if (match[1]) result.checkin.push(match[1]);
  }
  
  // Check-out patterns
  const checkoutPattern = /(?:check[-\s]?out|departure|depart|departing|to|until)[\s:]*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2})/gi;
  matches = text.matchAll(checkoutPattern);
  for (let match of matches) {
    if (match[1]) result.checkout.push(match[1]);
  }
  
  return result;
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: ID / IQAMA / NATIONAL ID NUMBERS
// ══════════════════════════════════════════════════════════════════
function extractIDNumbers(text) {
  const ids = new Set();
  // Saudi National ID / Iqama (10 digits starting with 1 or 2)
  const saudiPattern = /\b([12]\d{9})\b/g;
  let m = text.match(saudiPattern);
  if (m) m.forEach(v => ids.add(v));
  // Generic National ID label
  const labelPattern = /(?:national\s*id|iqama|id\s*no|id\s*number|identity\s*no)[\s:#]*([A-Z0-9]{6,15})/gi;
  for (let match of text.matchAll(labelPattern)) {
    if (match[1]) ids.add(match[1].toUpperCase());
  }
  // Emirates ID (784-YYYY-XXXXXXX-D)
  const emiratesPattern = /784[-\s]?\d{4}[-\s]?\d{7}[-\s]?\d/g;
  m = text.match(emiratesPattern);
  if (m) m.forEach(v => ids.add(v.replace(/\s/g,'-')));
  return [...ids];
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: VISA NUMBERS & TYPES
// ══════════════════════════════════════════════════════════════════
function extractVisaData(text) {
  const visas = new Set();
  // Visa number label
  const numPat = /(?:visa\s*(?:no|number|#|num)?)[\s:#]*([A-Z0-9]{5,15})/gi;
  for (let m of text.matchAll(numPat)) if (m[1]) visas.add('VISA: ' + m[1].toUpperCase());
  // Visa type
  const typePat = /(?:visa\s*type|type\s*of\s*visa)[\s:#]*([A-Z0-9\s\/]{2,30})/gi;
  for (let m of text.matchAll(typePat)) if (m[1]) visas.add('Type: ' + m[1].trim());
  // Common visa types as standalone words
  const types = ['TOURIST', 'BUSINESS', 'TRANSIT', 'STUDENT', 'WORK', 'HAJJ', 'UMRAH', 'VISIT', 'MULTIPLE ENTRY', 'SINGLE ENTRY'];
  types.forEach(t => { if (new RegExp('\\b' + t + '\\b','i').test(text)) visas.add('Type: ' + t); });
  return [...visas];
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: GENDER & TITLE
// ══════════════════════════════════════════════════════════════════
function extractGenderTitle(text) {
  const found = new Set();
  if (/\b(Mr|MR|MALE|M)\b/.test(text)) found.add('Male');
  if (/\b(Mrs|MS|Miss|FEMALE|F)\b/.test(text)) found.add('Female');
  const titlePat = /\b(Mr|Mrs|Ms|Miss|Dr|Prof|Eng|Capt|Col|Gen|Haj|Hajja)\.?\s/g;
  for (let m of text.matchAll(titlePat)) found.add(m[1]);
  return [...found];
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: PAX COUNT / NUMBER OF GUESTS
// ══════════════════════════════════════════════════════════════════
function extractPaxCount(text) {
  const pax = new Set();
  const patterns = [
    /(?:pax|guests?|persons?|adults?|people)[\s:#]*(\d{1,3})/gi,
    /(\d{1,3})\s*(?:pax|guests?|persons?|adults?|people)/gi,
    /(?:no\.?\s*of\s*(?:pax|guests?|persons?))[\s:#]*(\d{1,3})/gi,
    /(?:adults?[\s:#]*)(\d{1,2})(?:\s*[\+\/&]\s*(?:children?|kids?|child)[\s:#]*(\d{1,2}))?/gi,
  ];
  patterns.forEach(p => {
    for (let m of text.matchAll(p)) {
      if (m[1]) {
        const adults = m[1];
        const children = m[2] || null;
        pax.add(children ? `Adults: ${adults}, Children: ${children}` : `${adults} pax`);
      }
    }
  });
  return [...pax];
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: ADDRESSES
// ══════════════════════════════════════════════════════════════════
function extractAddresses(text) {
  const addresses = new Set();
  // After "address:" label
  const labelPat = /(?:address|addr)[\s:#]+([^\n]{10,80})/gi;
  for (let m of text.matchAll(labelPat)) {
    if (m[1]) addresses.add(m[1].trim());
  }
  // Street number + name patterns
  const streetPat = /\b\d{1,5}\s+[A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,4}\s+(?:Street|St|Road|Rd|Avenue|Ave|Blvd|Lane|Ln|Drive|Dr|Way|Place|Pl)\b/gi;
  for (let m of text.matchAll(streetPat)) addresses.add(m[0].trim());
  return [...addresses];
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: REMARKS / NOTES / SPECIAL REQUESTS
// ══════════════════════════════════════════════════════════════════
function extractRemarks(text) {
  const remarks = new Set();
  const labelPat = /(?:remarks?|notes?|special\s*requests?|requests?|comments?|instructions?)[\s:#]+([^\n]{3,120})/gi;
  for (let m of text.matchAll(labelPat)) {
    if (m[1] && m[1].trim().length > 3) remarks.add(m[1].trim());
  }
  return [...remarks];
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: DURATION / NIGHTS
// ══════════════════════════════════════════════════════════════════
function extractNights(text) {
  const found = new Set();
  const pats = [
    /(\d{1,3})\s*(?:nights?|nts?)\b/gi,
    /(?:nights?|duration)[\s:#]*(\d{1,3})/gi,
    /stay[\s:]*(\d{1,3})\s*(?:nights?|nts?)/gi,
  ];
  pats.forEach(p => {
    for (let m of text.matchAll(p)) if (m[1]) found.add(m[1] + ' night' + (parseInt(m[1]) > 1 ? 's' : ''));
  });
  return [...found];
}

// ══════════════════════════════════════════════════════════════════
//  EXTRACT: ROOMING LIST TABLE LINES  (Name | Rooms | Type | Meal)
// ══════════════════════════════════════════════════════════════════
function extractRoomingRows(text) {
  const rows = [];
  const lines = text.split('\n');
  lines.forEach(line => {
    // Pipe-separated or tab-separated table row
    const parts = line.split(/\s*[|│\t]\s*/).map(p => p.trim()).filter(Boolean);
    if (parts.length >= 3) {
      // Looks like a data row — at least one part is a name-like string
      const hasName = /[A-Z][a-z]{2,}/.test(parts[0]) || /[\u0600-\u06FF]{3,}/.test(parts[0]);
      const hasRoomOrMeal = parts.some(p => /\b(SGL|DBL|TRPL|TWIN|SUITE|BB|HB|FB|AI|RO)\b/i.test(p));
      if (hasName || hasRoomOrMeal) {
        rows.push(parts.join(' | '));
      }
    }
  });
  return rows;
}

// ══════════════════════════════════════════════════════════════════
//  ENHANCED extractNames — catches ALL naming patterns
// ══════════════════════════════════════════════════════════════════
function extractNames(text) {
  const names = new Set();
  const lines = text.split('\n');

  // Pattern 1: After labels like "Name:", "Guest:", "PAX:", "Passenger:", "Holder:"
  const labelPattern = /(?:name|guest|pax|passenger|client|traveler|booker|holder|tenant|occupant|resident)[\s:]+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,4})/gi;
  for (let m of text.matchAll(labelPattern)) {
    if (m[1] && m[1].length > 3) names.add(m[1].trim());
  }

  // Pattern 2: Title + Name (Mr, Mrs, Ms, Dr, etc.)
  const titlePattern = /(?:Mr|Mrs|Ms|Dr|Miss|Prof|Sir|Eng|Capt|Col|Gen|Haj|Hajja)\.?\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,4})/g;
  for (let m of text.matchAll(titlePattern)) {
    if (m[1] && m[1].length > 3) names.add(m[1].trim());
  }

  // Pattern 3: Numbered list names ("1. Ahmed Ali", "2) Mohammed Hassan")
  const numberedPattern = /^\s*\d{1,3}[\.\)]\s+([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+){1,4})/gm;
  for (let m of text.matchAll(numberedPattern)) {
    const name = m[1].trim();
    if (name.length > 4 && !/\b(ROOM|SUITE|HOTEL|DATE|CHECK|TOTAL|PAX|FLOOR)\b/i.test(name)) {
      names.add(name);
    }
  }

  // Pattern 4: Full UPPERCASE names (2-4 words, at least 2 chars each)
  const capsPattern = /\b([A-Z]{2,}(?:\s+[A-Z]{2,}){1,3})\b/g;
  for (let m of text.matchAll(capsPattern)) {
    const name = m[1].trim();
    const excludeWords = ['PASSPORT','VISA','NATIONALITY','NUMBER','DATE','BIRTH','ISSUE','EXPIRY',
      'VALID','UNTIL','TYPE','CARD','IDENTITY','REPUBLIC','KINGDOM','UNITED','STATES','DOCUMENT',
      'TRAVEL','PERSONAL','GIVEN','SURNAME','GENDER','CODE','HOTEL','RESORT','CHECK','ROOM',
      'DOUBLE','SINGLE','TRIPLE','SUITE','STANDARD','DELUXE','SUPERIOR','EXECUTIVE','TOTAL',
      'AMOUNT','PRICE','COST','BOOKING','RESERVATION','CONFIRMATION','ARRIVAL','DEPARTURE',
      'BREAKFAST','LUNCH','DINNER','BOARD','INCLUSIVE','ONLY','PLAN','VIEW','FLOOR','CITY',
      'OCEAN','GARDEN','POOL','MOUNTAIN','SEA','BEACH'];
    const words = name.split(' ');
    const isExcluded = words.some(w => excludeWords.includes(w));
    if (!isExcluded && words.length >= 2 && words.length <= 4 &&
        words.every(w => w.length >= 2) && name.length > 5) {
      names.add(words.map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' '));
    }
  }

  // Pattern 5: Mixed case names (Firstname Lastname)
  const mixedPattern = /\b([A-Z][a-z]{2,}(?:\s+[A-Z][a-z]{2,}){1,3})\b/g;
  for (let m of text.matchAll(mixedPattern)) {
    const name = m[1].trim();
    const excludePhrases = ['Date Of','Place Of','Check In','Check Out','Room Type','Meal Plan',
      'Sea View','City View','Garden View','Pool View','Hotel Name'];
    const isExcluded = excludePhrases.some(p => name.toLowerCase().includes(p.toLowerCase()));
    if (!isExcluded && name.split(' ').length >= 2 && name.length > 5) names.add(name);
  }

  // Pattern 6: Arabic names (2-4 Arabic words)
  const arabicPat = /[\u0600-\u06FF]{2,}(?:\s+[\u0600-\u06FF]{2,}){1,3}/g;
  for (let m of text.matchAll(arabicPat)) {
    if (m[0].length > 5) names.add(m[0].trim());
  }

  // Pattern 7: SURNAME, Firstname
  const surnameFirstPat = /\b([A-Z]{2,}),\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/g;
  for (let m of text.matchAll(surnameFirstPat)) {
    const surname = m[1].charAt(0) + m[1].slice(1).toLowerCase();
    names.add(`${m[2]} ${surname}`);
  }

  // Pattern 8: Rooming list style — name is the first token on a line followed by room/meal info
  lines.forEach(line => {
    const m = line.match(/^([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+){1,3})\s+(?:\d|SGL|DBL|TRPL|TWIN|BB|HB|FB|AI)/);
    if (m) names.add(m[1].trim());
  });

  return [...names].filter(n => {
    if (!n || n.length < 4 || n.length > 70) return false;
    if (/^\d/.test(n)) return false;
    if ((n.match(/[^a-zA-Z\u0600-\u06FF\s'-]/g) || []).length > 2) return false;
    return true;
  });
}

// ══════════════════════════════════════════════════════════════════
//  ENHANCED extractDates — all formats including Arabic verbal dates
// ══════════════════════════════════════════════════════════════════
function extractDates(text) {
  const dates = new Set();

  // DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY
  for (let m of text.matchAll(/\b(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})\b/g)) {
    const [,d,mo,y] = m;
    const year = y.length===2 ? '20'+y : y;
    if (+d>=1&&+d<=31&&+mo>=1&&+mo<=12&&+year>=1950&&+year<=2100) dates.add(`${d.padStart(2,'0')}/${mo.padStart(2,'0')}/${year}`);
  }

  // YYYY-MM-DD
  for (let m of text.matchAll(/\b(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})\b/g)) {
    const [,y,mo,d] = m;
    if (+d>=1&&+d<=31&&+mo>=1&&+mo<=12&&+y>=1950&&+y<=2100) dates.add(`${d.padStart(2,'0')}/${mo.padStart(2,'0')}/${y}`);
  }

  // DD Mon YYYY or DD Mon YY  (25 Jan 2026, 25 Jan 26, 25 January 2026)
  const months = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12,
    january:1,february:2,march:3,april:4,june:6,july:7,august:8,september:9,october:10,november:11,december:12};
  for (let m of text.matchAll(/\b(\d{1,2})\s+(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|jun|jul|aug|sep|oct|nov|dec)\.?\s+(\d{2,4})\b/gi)) {
    const day = m[1], mon = months[m[2].toLowerCase()], yr = m[3].length===2?'20'+m[3]:m[3];
    dates.add(`${day.padStart(2,'0')}/${String(mon).padStart(2,'0')}/${yr}`);
  }

  // Mon DD, YYYY (December 25, 2025)
  for (let m of text.matchAll(/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|jun|jul|aug|sep|oct|nov|dec)\.?\s+(\d{1,2}),?\s+(\d{4})\b/gi)) {
    const mon = months[m[1].toLowerCase()], day = m[2], yr = m[3];
    dates.add(`${day.padStart(2,'0')}/${String(mon).padStart(2,'0')}/${yr}`);
  }

  // Hijri dates: ١٤٤٦/٠٩/١٥ style (Arabic-Indic digits)
  for (let m of text.matchAll(/[\u0660-\u0669]{4}[\/\-][\u0660-\u0669]{1,2}[\/\-][\u0660-\u0669]{1,2}/g)) {
    dates.add('Hijri: ' + m[0]);
  }

  return [...dates];
}

// ══════════════════════════════════════════════════════════════════
//  ENHANCED extractCheckinCheckout
// ══════════════════════════════════════════════════════════════════
function extractCheckinCheckout(text) {
  const result = { checkin: [], checkout: [] };
  const dateRx = /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2}|\d{1,2}\s+(?:jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)[a-z]*\.?\s+\d{2,4})/gi;

  // Check-in
  for (let m of text.matchAll(/(?:check[-\s]?in|arrival|arrive|arriving|from|ci|chkin)[\s:#→\-]*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2})/gi)) {
    if (m[1]) result.checkin.push(m[1]);
  }
  // Check-out
  for (let m of text.matchAll(/(?:check[-\s]?out|departure|depart|departing|to|until|co|chkout)[\s:#→\-]*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4}|\d{4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,2})/gi)) {
    if (m[1]) result.checkout.push(m[1]);
  }

  // Heuristic: If two dates found and no labels, first=checkin, second=checkout
  if (result.checkin.length === 0 && result.checkout.length === 0) {
    const allDates = [...text.matchAll(dateRx)].map(m => m[0]);
    if (allDates.length >= 2) {
      result.checkin.push(allDates[0]);
      result.checkout.push(allDates[1]);
    }
  }

  return result;
}

// ══════════════════════════════════════════════════════════════════
//  SMART EXTRACT ALL — now returns 20+ categories
// ══════════════════════════════════════════════════════════════════
function smartExtractAll(text) {
  const checkDates = extractCheckinCheckout(text);

  return {
    names:         extractNames(text),
    emails:        extractEmails(text),
    phones:        extractPhones(text),
    dates:         extractDates(text),
    checkin:       checkDates.checkin,
    checkout:      checkDates.checkout,
    nights:        extractNights(text),
    pax:           extractPaxCount(text),
    passports:     extractPassportNumbers(text),
    idNumbers:     extractIDNumbers(text),
    visaData:      extractVisaData(text),
    confirmations: extractConfirmationNumbers(text),
    nationalities: extractNationalities(text),
    amounts:       extractAmounts(text),
    roomTypes:     extractRoomTypes(text),
    mealPlans:     extractMealPlans(text),
    hotels:        extractHotelNames(text),
    flights:       extractFlightNumbers(text),
    cities:        extractCities(text),
    addresses:     extractAddresses(text),
    genderTitle:   extractGenderTitle(text),
    remarks:       extractRemarks(text),
    roomingRows:   extractRoomingRows(text),
  };
}

// Log extracted data to console for debugging (ENHANCED)
function logExtractedData(data) {
  console.log('╔════════════════════════════════════════════════════════╗');
  console.log('║           SMART EXTRACTION RESULTS                     ║');
  console.log('╚════════════════════════════════════════════════════════╝');
  
  let totalCount = 0;
  
  Object.entries(data).forEach(([category, values]) => {
    if (values && values.length > 0) {
      console.log(`\n📌 ${category.toUpperCase()} (${values.length}):`);
      values.forEach((v, i) => console.log(`   ${i + 1}. ${v}`));
      totalCount += values.length;
    }
  });
  
  console.log(`\n✅ Total extracted: ${totalCount} data fields`);
  console.log('═══════════════════════════════════════════════════════════\n');
}

/* ===== LIVE RE-EXTRACT ON MANUAL TEXT EDIT ===== */
let reExtractTimer = null;
function liveReExtract() {
  clearTimeout(reExtractTimer);
  reExtractTimer = setTimeout(() => {
    const text = document.getElementById('ocrResult').value;
    if (!text.trim()) { clearExtractionPreview(); return; }
    const extracted = smartExtractAll(text);
    const validated = validateAndCorrectData(extracted);
    const quality = calculateDataQuality(validated);
    window.lastExtractedData = validated;
    renderExtractionPreview(validated, quality);
  }, 600);
}

/* ===== RENDER LIVE EXTRACTION PREVIEW PANEL ===== */
const FIELD_CONFIG = [
  { key:'names',         label:'👤 Guest Name(s)',        color:'#3b82f6', type:'WORDS'       },
  { key:'checkin',       label:'📅 Check-In',             color:'#10b981', type:'DATE'        },
  { key:'checkout',      label:'📅 Check-Out',            color:'#f59e0b', type:'DATE'        },
  { key:'nights',        label:'🌙 Nights',               color:'#6366f1', type:'NUMBER'      },
  { key:'pax',           label:'👥 Pax / Guests',         color:'#0ea5e9', type:'NUMBER'      },
  { key:'dates',         label:'🗓️ Other Dates',           color:'#8b5cf6', type:'DATE'        },
  { key:'hotels',        label:'🏨 Hotel',                color:'#0ea5e9', type:'WORDS'       },
  { key:'roomTypes',     label:'🛏️ Room Type',             color:'#6366f1', type:'CODE'        },
  { key:'mealPlans',     label:'🍽️ Meal Plan',             color:'#ec4899', type:'CODE'        },
  { key:'confirmations', label:'🔖 Confirmation No.',     color:'#f97316', type:'ALPHANUMERIC' },
  { key:'passports',     label:'🛂 Passport No.',         color:'#14b8a6', type:'ALPHANUMERIC' },
  { key:'idNumbers',     label:'🪪 ID / Iqama No.',        color:'#0891b2', type:'NUMBERS'     },
  { key:'visaData',      label:'📋 Visa Info',            color:'#7c3aed', type:'MIXED'       },
  { key:'nationalities', label:'🌍 Nationality',          color:'#84cc16', type:'WORDS'       },
  { key:'genderTitle',   label:'♀♂ Gender / Title',       color:'#f472b6', type:'WORDS'       },
  { key:'phones',        label:'🔢 All Numbers',          color:'#22c55e', type:'NUMBERS'     },
  { key:'emails',        label:'✉️ Email',                 color:'#a855f7', type:'EMAIL'       },
  { key:'amounts',       label:'💰 Amount',               color:'#eab308', type:'NUMBERS'     },
  { key:'flights',       label:'✈️ Flight No.',            color:'#06b6d4', type:'ALPHANUMERIC' },
  { key:'cities',        label:'🗺️ City / Destination',   color:'#f43f5e', type:'WORDS'       },
  { key:'addresses',     label:'📍 Address',              color:'#64748b', type:'WORDS'       },
  { key:'remarks',       label:'📝 Remarks / Notes',      color:'#78716c', type:'WORDS'       },
  { key:'roomingRows',   label:'📊 Rooming Table Rows',   color:'#1e3a8a', type:'MIXED'       },
];

function renderExtractionPreview(data, quality) {
  const panel = document.getElementById('extractionPreviewPanel');
  const grid  = document.getElementById('extFieldsGrid');
  const empty = document.getElementById('extEmptyMsg');
  const badge = document.getElementById('scanCountBadge');
  const qLabel = document.getElementById('qualityScoreLabel');
  const qBar   = document.getElementById('qualityBarFill');
  const accBadge = document.getElementById('accumulatedBadge');
  const accCount = document.getElementById('accumulatedCount');

  if (!panel) return;

  // Count non-empty categories
  const activeFields = FIELD_CONFIG.filter(f => data[f.key] && data[f.key].length > 0);

  if (activeFields.length === 0) {
    panel.style.display = 'block';
    grid.innerHTML = '';
    if (empty) empty.style.display = 'block';
    badge.textContent = '0 fields';
    return;
  }

  panel.style.display = 'block';
  if (empty) empty.style.display = 'none';
  badge.textContent = quality.totalFields + ' fields';

  // Quality bar
  qLabel.textContent = quality.qualityScore + '%';
  qLabel.style.color = quality.qualityScore >= 80 ? '#10b981' : quality.qualityScore >= 50 ? '#f59e0b' : '#ef4444';
  qBar.style.width = quality.qualityScore + '%';
  qBar.style.background = quality.qualityScore >= 80
    ? 'linear-gradient(90deg,#10b981,#3b82f6)'
    : quality.qualityScore >= 50
    ? 'linear-gradient(90deg,#f59e0b,#f97316)'
    : 'linear-gradient(90deg,#ef4444,#f97316)';

  // Multi-scan badge
  const scanCount = (window.accumulatedScans || []).length;
  if (scanCount > 1) {
    accBadge.style.display = 'block';
    accCount.textContent = `📑 ${scanCount} scans accumulated — Excel will have ${scanCount} rows`;
  } else {
    accBadge.style.display = 'none';
  }

  // Build cards
  grid.innerHTML = '';
  activeFields.forEach(({ key, label, color, type }) => {
    const values = data[key];
    const card = document.createElement('div');
    card.className = 'ext-field-card';
    card.style.borderLeftColor = color;
    card.style.borderLeftWidth = '3px';

    // Header row: label + type badge
    const headerRow = document.createElement('div');
    headerRow.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;';

    const lbl = document.createElement('div');
    lbl.className = 'ext-field-label';
    lbl.style.color = color;
    lbl.style.margin = '0';
    lbl.textContent = label;
    headerRow.appendChild(lbl);

    if (type) {
      const badge = document.createElement('span');
      badge.className = 'ext-type-badge';
      badge.textContent = type;
      badge.style.cssText = `background:${color}18;color:${color};border:1px solid ${color}44;`;
      headerRow.appendChild(badge);
    }
    card.appendChild(headerRow);

    const valWrap = document.createElement('div');
    valWrap.className = 'ext-field-values';

    values.forEach(val => {
      const row = document.createElement('div');
      row.className = 'ext-field-value-item';

      const txt = document.createElement('span');
      txt.textContent = val;
      txt.style.flex = '1';

      const copyBtn = document.createElement('button');
      copyBtn.className = 'ext-copy-val-btn';
      copyBtn.textContent = '📋';
      copyBtn.title = 'Copy';
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(val).then(() => {
          copyBtn.textContent = '✓';
          setTimeout(() => copyBtn.textContent = '📋', 1200);
        });
      };

      row.appendChild(txt);
      row.appendChild(copyBtn);
      valWrap.appendChild(row);
    });

    card.appendChild(valWrap);
    grid.appendChild(card);
  });

  // Scroll preview into view smoothly
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function clearExtractionPreview() {
  const panel = document.getElementById('extractionPreviewPanel');
  if (panel) panel.style.display = 'none';
}

/* ===== COPY ALL EXTRACTED DATA AS FORMATTED TEXT ===== */
function copyAllExtracted() {
  const data = window.lastExtractedData;
  if (!data) { showToast('❌ No data to copy!'); return; }

  let lines = [];
  FIELD_CONFIG.forEach(({ key, label }) => {
    const values = data[key];
    if (values && values.length > 0) {
      const cleanLabel = label.replace(/^[^\w]+/, '').trim(); // remove emoji
      lines.push(`${cleanLabel}: ${values.join(' | ')}`);
    }
  });

  if (lines.length === 0) { showToast('❌ No data!'); return; }
  const text = lines.join('\n');

  navigator.clipboard.writeText(text).then(() => {
    showToast('✅ All extracted data copied!');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('✅ Copied!');
  });
}

/* ===== CLEAR ACCUMULATED SCANS ===== */
function clearAccumulatedScans() {
  window.accumulatedScans = [];
  window.lastExtractedData = null;
  const panel = document.getElementById('extractionPreviewPanel');
  if (panel) panel.style.display = 'none';
  showToast('🗑️ All accumulated scans cleared.');
}

/* ===== SEARCH / HIGHLIGHT INSIDE OCR TEXTAREA ===== */
function toggleOCRSearch() {
  const bar = document.getElementById('ocrSearchBar');
  if (!bar) return;
  if (bar.style.display === 'none' || bar.style.display === '') {
    bar.style.display = 'block';
    bar.focus();
  } else {
    bar.style.display = 'none';
    bar.value = '';
  }
}

function highlightSearch(query) {
  // Textarea doesn't support HTML, so we just scroll to first match & show count
  const ta = document.getElementById('ocrResult');
  if (!ta) return;
  const text = ta.value;
  if (!query.trim()) return;

  const idx = text.toLowerCase().indexOf(query.toLowerCase());
  if (idx !== -1) {
    // Move cursor to match position
    ta.focus();
    ta.setSelectionRange(idx, idx + query.length);
    // Count occurrences
    const matches = (text.toLowerCase().match(new RegExp(query.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'g')) || []).length;
    showOCRStatus(`🔍 Found ${matches} match${matches !== 1 ? 'es' : ''} for "${query}"`, '#3b82f6');
  } else {
    showOCRStatus(`❌ "${query}" not found`, '#ef4444');
  }
}

/* ===== MULTI-SCAN EXCEL EXPORT: each scan = one row ===== */
// (The main exportExtractedExcel is already updated below to handle multi-scan)

</script>

<!-- ===== OCR.SPACE + CLAUDE AI EXTRACTION ENGINE v4.0 ===== -->
<script>
/* ══════════════════════════════════════════════════════════════════════
   OCR ENGINE v4.0 — OCR.space API + Claude AI Extraction
   
   PIPELINE:
   1. OCR.space API (Engine 3 = best, Engine 2 = fast, Engine 1 = fastest)
      - Real cloud OCR with proper Arabic support
      - Auto-orient, auto-enlarge, table/receipt detection
      - Returns word-level bounding boxes (overlay)
      - Free API key: 'helloworld' (rate limited, good for personal use)
   
   2. Claude AI Structured Extraction
      - Analyzes OCR text and extracts exactly specified fields
      - Returns JSON with per-field confidence scores
      - Fixes OCR errors intelligently using context
   
   3. Smart Regex Fallback
      - 20+ field types extracted via regex
      - Runs when API is unavailable
   ══════════════════════════════════════════════════════════════════════ */

// ── GLOBAL STATE ──────────────────────────────────────────────────────────
window._ocrEngine = 3;     // 1=fastest, 2=fast+special chars, 3=best+handwriting
window._ocrMode   = 'standard';

// ── OCR ENGINE (internal, not user-facing) ────────────────────────────────
function setOCREngine(engine) {
  window._ocrEngine = engine;
}

// ── UPDATE AUTO ENGINE STATUS BADGE ──────────────────────────────────────
function updateEngineStatusBadge(engine, state) {
  const badge = document.getElementById('engineActiveBadge');
  const text  = document.getElementById('engineStatusText');
  const icon  = document.getElementById('engineStatusIcon');
  const wrap  = document.getElementById('engineStatusBadge');
  if (!badge || !text) return;

  const names = {3:'Engine 3',2:'Engine 2',1:'Engine 1',local:'Local OCR'};
  const name  = names[engine] || 'Engine '+engine;

  const styles = {
    trying:  {bg:'#1d4ed8', txt:name+' — connecting…',    border:'#93c5fd', bg2:'#eff6ff', icon:'📡'},
    ok:      {bg:'#166534', txt:name+' ✅',               border:'#86efac', bg2:'#f0fdf4', icon:'✅'},
    failed:  {bg:'#b91c1c', txt:name+' failed → next…',   border:'#fca5a5', bg2:'#fff1f2', icon:'⚠️'},
    fallback:{bg:'#92400e', txt:'Local OCR (offline)',     border:'#fcd34d', bg2:'#fffbeb', icon:'💻'},
  };
  const s = styles[state] || styles.trying;

  badge.textContent = name;
  badge.style.background = s.bg;
  text.textContent = s.txt;
  if (icon) icon.textContent = s.icon;
  if (wrap) {
    wrap.style.borderColor = s.border;
    wrap.style.background  = 'linear-gradient(135deg,'+s.bg2+',white)';
  }
}

// ── OCR MODE SELECTOR (enhanced) ─────────────────────────────────────────
function setOCRMode(mode) {
  window._ocrMode = mode;
  window.ocrMode  = mode; // keep legacy var in sync
  
  ['standard','passport','rooming','table','ai'].forEach(m => {
    const btn = document.getElementById('modeBtn_' + m);
    if (btn) {
      btn.classList.toggle('ocr-mode-active', m === mode);
      if (m === 'ai') {
        btn.style.background = mode === 'ai'
          ? 'linear-gradient(135deg,#6d28d9,#5b21b6)'
          : 'linear-gradient(135deg,#7c3aed,#6d28d9)';
      }
    }
  });

  // Table mode: auto-check the table detection option
  const tableOpt = document.getElementById('optTableDetect');
  if (tableOpt) tableOpt.checked = (mode === 'table');

  const aiPanel = document.getElementById('aiExtractPanel');
  if (aiPanel) aiPanel.style.display = (mode === 'ai') ? 'block' : 'none';
  
  showOCRStatus('Mode: ' + mode.toUpperCase(), '#3498db');
}

// ── OCR.SPACE API CALL ────────────────────────────────────────────────────
async function ocrSpaceRequest(file, engine) {
  const API_KEY = 'K87690877788957';
  const URL     = 'https://api.ocr.space/parse/image';
  
  let lang       = document.getElementById('ocrLanguage')?.value || 'auto';
  const engineNum = Number(engine);
  // Engine 3 & 2 only support English on free key; Engine 1 supports Arabic & others
  // For auto-detect: try 'ara' on Engine 1 (best for Arabic docs), 'eng' on 2 & 3
  let apiLang;
  if (lang === 'auto') {
    apiLang = (engineNum === 1) ? 'ara' : 'eng';
  } else {
    apiLang = (engineNum === 2 || engineNum === 3) ? 'eng' : lang;
  }

  const rotate   = document.getElementById('optAutoRotate')?.checked ?? true;
  const enlarge  = document.getElementById('optAutoEnlarge')?.checked ?? true;
  const table    = document.getElementById('optTableDetect')?.checked ?? false;
  const overlay  = document.getElementById('optOverlay')?.checked ?? false;

  const fd = new FormData();
  fd.append('file', file);
  fd.append('apikey', API_KEY);
  fd.append('language', apiLang);  // empty string = OCR.space auto-detect
  fd.append('OCREngine', String(engine));
  fd.append('isOverlayRequired', overlay ? 'true' : 'false');
  fd.append('detectOrientation', rotate ? 'true' : 'false');
  fd.append('scale', enlarge ? 'true' : 'false');
  fd.append('isTable', table ? 'true' : 'false');
  fd.append('isCreateSearchablePDF', 'false');
  fd.append('filetype', 'Auto');

  const resp = await fetch(URL, { method: 'POST', body: fd });
  if (!resp.ok) throw new Error(`OCR.space HTTP ${resp.status}`);
  
  const json = await resp.json();
  
  // Handle API errors
  if (json.IsErroredOnProcessing) {
    throw new Error(json.ErrorMessage?.[0] || 'OCR.space API error');
  }
  
  return json;
}

// ── EXTRACT TEXT FROM OCR.SPACE RESPONSE ─────────────────────────────────
function extractTextFromOCRSpace(json) {
  if (!json?.ParsedResults?.length) return '';
  
  return json.ParsedResults
    .map(r => r.ParsedText || '')
    .join('\n')
    .replace(/\r\n/g, '\n');
}

// ── EXTRACT OVERLAY DATA FROM OCR.SPACE ──────────────────────────────────
function extractOverlayFromOCRSpace(json) {
  if (!json?.ParsedResults?.length) return [];
  
  const words = [];
  json.ParsedResults.forEach(page => {
    if (!page.TextOverlay?.Lines) return;
    page.TextOverlay.Lines.forEach(line => {
      if (!line.Words) return;
      line.Words.forEach(word => {
        words.push({
          text: word.WordText,
          left: word.Left,
          top:  word.Top,
          width: word.Width,
          height: word.Height,
          confidence: word.Confidence || null
        });
      });
    });
  });
  return words;
}

// ── RENDER WORD OVERLAY ───────────────────────────────────────────────────
function renderWordOverlay(words) {
  const panel = document.getElementById('overlayPanel');
  const content = document.getElementById('overlayContent');
  if (!panel || !content || !words.length) return;
  
  panel.style.display = 'block';
  
  // Group by estimated lines (words with similar top values)
  const lineMap = {};
  words.forEach(w => {
    const lineKey = Math.round(w.top / 20) * 20; // group within 20px
    if (!lineMap[lineKey]) lineMap[lineKey] = [];
    lineMap[lineKey].push(w);
  });
  
  const lines = Object.keys(lineMap).sort((a,b) => a-b).map(k => lineMap[k]);
  
  content.innerHTML = lines.map(lineWords => {
    return '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:4px;">' +
      lineWords.map(w => {
        const conf = w.confidence !== null ? w.confidence : 100;
        const bg = conf >= 90 ? '#dcfce7' : conf >= 70 ? '#fef9c3' : '#fee2e2';
        const border = conf >= 90 ? '#86efac' : conf >= 70 ? '#fde047' : '#fca5a5';
        return `<span title="Confidence: ${conf}%" style="background:${bg};border:1px solid ${border};border-radius:4px;padding:1px 5px;font-size:0.75rem;">${w.text}</span>`;
      }).join('') +
    '</div>';
  }).join('');
}

// ── MAIN OCR RUNNER — AUTO-CASCADE: 3 → 2 → 1 → Local ───────────────────
async function runOCRSpaceOnFile(file, _ignored, fileIndex, fileCount) {
  const base  = Math.round((fileIndex / fileCount) * 68);
  const range = Math.round(68 / fileCount);

  const selectedLang = document.getElementById('ocrLanguage')?.value || 'auto';
  // Engine 1 supports Arabic + most languages on free key → always try first
  // Engine 3 = best English quality, Engine 2 = fast English → fallback
  const engineOrder = [1, 3, 2];

  for (const engine of engineOrder) {
    updateEngineStatusBadge(engine, 'trying');
    setProgress(base + 5, `📡 Trying Engine ${engine}…`);
    try {
      const json = await ocrSpaceRequest(file, engine);
      const text = extractTextFromOCRSpace(json);
      if (!text || text.trim().length < 2) throw new Error('Empty result');

      window._ocrEngine = engine;
      updateEngineStatusBadge(engine, 'ok');
      setProgress(base + range, `✅ Engine ${engine} done (${fileIndex+1}/${fileCount})`);

      if (document.getElementById('optOverlay')?.checked)
        renderWordOverlay(extractOverlayFromOCRSpace(json));

      const orient = json.ParsedResults?.[0]?.TextOrientation;
      if (orient && orient !== 'NotDetermined' && orient !== '0')
        showOCRStatus(`↩️ Auto-rotated ${orient}°`, '#f59e0b');

      return text;
    } catch (err) {
      console.warn(`Engine ${engine} failed:`, err.message);
      updateEngineStatusBadge(engine, 'failed');
      await new Promise(r => setTimeout(r, 1200)); // wait longer before next engine
    }
  }

  // All cloud engines failed → local Tesseract
  updateEngineStatusBadge('local', 'fallback');
  setProgress(base + 8, '💻 Cloud unavailable — local OCR…');
  return await runLocalTesseract(file, base + 10, range - 8);
}

// ── LOCAL TESSERACT FALLBACK ──────────────────────────────────────────────
async function runLocalTesseract(file, progressBase, progressRange) {
  try {
    const enhanced = await enhancedPreprocessImage(file);
    const { data: { text } } = await Tesseract.recognize(enhanced, 'ara+eng', {
      logger: m => {
        if (m.status === 'recognizing text') {
          setProgress(progressBase + Math.round(m.progress * (progressRange || 30)), `Local OCR: ${Math.round(m.progress*100)}%`);
        }
      }
    });
    return text;
  } catch(e) {
    // Ultra fallback: no preprocessing
    const { data: { text } } = await Tesseract.recognize(file, 'ara+eng');
    return text;
  }
}

// ── ADVANCED IMAGE PREPROCESSING (for local fallback) ─────────────────────
async function enhancedPreprocessImage(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = (e) => {
      img.onload = () => {
        const TARGET_WIDTH = 2480;
        const scale = img.width < TARGET_WIDTH ? Math.min(TARGET_WIDTH / img.width, 3) : 1;
        const canvas = document.createElement('canvas');
        canvas.width  = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const d = imageData.data;
        let sum = 0;
        for (let i = 0; i < d.length; i += 4) sum += (d[i]+d[i+1]+d[i+2])/3;
        const avgLum = sum / (d.length / 4);
        const contrast = avgLum < 100 ? 1.6 : avgLum > 180 ? 1.3 : 1.45;
        const brightness = avgLum < 80 ? 30 : 0;
        const factor = (259*(contrast*100+255))/(255*(259-contrast*100));
        for (let i = 0; i < d.length; i += 4) {
          const gray = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
          let val = Math.min(255, Math.max(0, factor*(gray-128)+128+brightness));
          if (val > 160) val = Math.min(255, val+20);
          if (val < 100) val = Math.max(0, val-20);
          d[i] = d[i+1] = d[i+2] = val;
        }
        ctx.putImageData(imageData, 0, 0);
        canvas.toBlob(blob => resolve(blob), 'image/png', 1.0);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// ── CLAUDE AI STRUCTURED EXTRACTION ──────────────────────────────────────
async function claudeAIExtract(ocrText, fieldsToExtract) {
  if (!ocrText?.trim()) return null;
  
  const aiStatus = document.getElementById('aiExtractStatus');
  if (aiStatus) { aiStatus.style.display='block'; aiStatus.textContent='🤖 Claude AI analyzing…'; }

  const fields = fieldsToExtract || [
    'Full Name', 'Passport Number', 'Nationality', 'Date of Birth', 'Expiry Date',
    'Gender', 'Phone', 'Email', 'Check-in Date', 'Check-out Date', 'Nights',
    'Hotel Name', 'Room Type', 'Meal Plan', 'Confirmation Number', 'Reservation Number',
    'Flight Number', 'Visa Number', 'ID Number', 'Address', 'Country', 'Pax Count'
  ];

  const prompt = `You are a high-precision document intelligence API. Analyze this OCR text from a ${window._ocrMode || 'standard'} document and extract ONLY the listed fields.

OCR TEXT:
"""
${ocrText}
"""

FIELDS TO EXTRACT: ${fields.join(', ')}

STRICT RULES:
1. Return ONLY valid JSON — no markdown, no backticks, no explanation
2. Use null for fields not found in the text
3. FIX OCR ERRORS intelligently:
   - In names: 0→O, 1→I, rn→m, l→I if looks like a letter
   - In numbers/IDs: O→0, I→1, B→8, S→5, G→6, Z→2
   - Clean extra spaces: "A H M E D" → "AHMED"
4. For dates: normalize to DD/MM/YYYY format
5. For names: UPPERCASE, properly spaced
6. Detect document type: PASSPORT | BOOKING | VISA | ID_CARD | ROOMING_LIST | RECEIPT | OTHER
7. Format EXACTLY as: {"Field Name": {"value": "...", "confidence": 95}, "_doc_type": "PASSPORT", "_summary": "1-line summary"}
8. Confidence: 95+ if clearly visible, 70-94 if likely correct, 50-69 if uncertain, skip if not found
9. For Arabic names that are transliterated, keep original Arabic spelling intent
10. For passport MRZ lines (P<XXX...), parse surname and given names from << separator`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-5-20250929',
        max_tokens: 2000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!response.ok) throw new Error(`Claude API ${response.status}`);
    const data = await response.json();
    const raw = data.content.map(c => c.text||'').join('');
    const cleaned = raw.replace(/```json|```/g,'').trim();
    const parsed = JSON.parse(cleaned);
    if (aiStatus) aiStatus.textContent = '✅ Claude AI done!';
    return parsed;
  } catch(err) {
    console.error('Claude AI failed:', err);
    if (aiStatus) aiStatus.textContent = '⚠️ AI unavailable — using smart regex';
    return null;
  }
}

// ── RENDER AI RESULTS ─────────────────────────────────────────────────────
function renderAIExtractionResults(aiData, ocrText) {
  if (!aiData) return;
  const panel  = document.getElementById('extractionPreviewPanel');
  const grid   = document.getElementById('extFieldsGrid');
  const emptyMsg = document.getElementById('extEmptyMsg');
  const scanBadge = document.getElementById('scanCountBadge');
  const qLabel = document.getElementById('qualityScoreLabel');
  const qFill  = document.getElementById('qualityBarFill');
  if (!grid) return;

  panel.style.display = 'block';
  grid.innerHTML = '';

  const validFields = [];
  let totalConf = 0, confCount = 0;

  Object.entries(aiData).forEach(([k, v]) => {
    if (k.startsWith('_')) return;
    const val  = typeof v === 'object' ? v?.value : v;
    const conf = typeof v === 'object' ? (v?.confidence || 85) : 85;
    if (!val || val === 'null' || val === null) return;
    validFields.push({ key: k, value: String(val), confidence: conf });
    totalConf += conf; confCount++;
  });

  const avgConf = confCount > 0 ? Math.round(totalConf / confCount) : 0;
  if (qLabel) { qLabel.textContent = avgConf + '%'; qLabel.style.color = avgConf>=80?'#10b981':avgConf>=60?'#f59e0b':'#ef4444'; }
  if (qFill)  { qFill.style.width = avgConf + '%'; }
  if (scanBadge) scanBadge.textContent = validFields.length + ' fields';
  if (emptyMsg)  emptyMsg.style.display = validFields.length ? 'none' : 'block';

  // Doc type + summary banner
  if (aiData._doc_type || aiData._summary) {
    const meta = document.createElement('div');
    meta.style.cssText = 'grid-column:1/-1;background:linear-gradient(135deg,#7c3aed18,#2563eb18);border:1.5px solid #7c3aed55;border-radius:10px;padding:10px 14px;margin-bottom:6px;';
    const docType = typeof aiData._doc_type === 'object' ? aiData._doc_type?.value : aiData._doc_type;
    const summary = typeof aiData._summary  === 'object' ? aiData._summary?.value  : aiData._summary;
    meta.innerHTML = `<div style="font-size:0.7rem;font-weight:800;color:#6d28d9;margin-bottom:4px;">🤖 CLAUDE AI ANALYSIS</div>
      ${docType ? `<span style="background:#7c3aed;color:white;border-radius:20px;padding:2px 10px;font-size:0.7rem;font-weight:700;margin-right:8px;">${docType}</span>` : ''}
      ${summary ? `<span style="font-size:0.8rem;color:#4c1d95;">${summary}</span>` : ''}`;
    grid.appendChild(meta);
  }

  validFields.forEach(field => {
    const c = field.confidence;
    const confColor = c>=90?'#10b981':c>=70?'#f59e0b':'#ef4444';
    const card = document.createElement('div');
    card.className = 'ext-field-card';
    card.style.borderLeft = `3px solid ${confColor}`;
    card.innerHTML = `
      <div class="ext-field-label" style="color:#64748b;">
        <span>🤖</span>
        <span>${field.key.replace(/_/g,' ')}</span>
        <span style="margin-left:auto;font-size:0.62rem;color:${confColor};font-weight:800;background:${confColor}18;padding:1px 6px;border-radius:10px;">${c}%</span>
      </div>
      <div class="ext-field-values">
        <div class="ext-field-value-item">
          <span style="flex:1;font-size:0.85rem;font-weight:600;color:#1e293b;">${field.value}</span>
          <button class="ext-copy-val-btn" onclick="navigator.clipboard.writeText('${field.value.replace(/'/g,"\\'")}');this.textContent='✓';setTimeout(()=>this.textContent='Copy',1400);">Copy</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });

  // Store for export
  if (!window.lastExtractedData) window.lastExtractedData = {};
  validFields.forEach(f => {
    const key = f.key.replace(/\s+/g,'_').toLowerCase();
    if (!window.lastExtractedData[key]) window.lastExtractedData[key] = [];
    if (!window.lastExtractedData[key].includes(f.value)) window.lastExtractedData[key].push(f.value);
  });

  showOCRStatus(`🤖 AI: ${validFields.length} fields · ${avgConf}% avg confidence · Engine ${window._ocrEngine}`, '#7c3aed');
  panel.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

// ── MAIN BATCH OCR ENTRY POINT ────────────────────────────────────────────
async function runBatchOCR() {
  const files = document.getElementById('ocrImage').files;
  if (!files.length) return;

  // AI mode: scan + AI extract
  if (window._ocrMode === 'ai') {
    await runAIExtractionWithOCR();
    return;
  }

  showFilePreview(files);
  let fullText = '';
  const engine = window._ocrEngine;

  for (let i = 0; i < files.length; i++) {
    const f = files[i];
    setProgress(Math.round((i/files.length)*10)+2, `File ${i+1}/${files.length}: ${f.name}`);

    if (f.type === 'application/pdf') {
      await runPdfOCR(f);
      return;
    }

    let text = '';
    if (engine === 'local') {
      // Force local Tesseract
      text = await runLocalTesseract(f, Math.round((i/files.length)*70)+5, 30);
    } else {
      // Use OCR.space API
      text = await runOCRSpaceOnFile(f, engine, i, files.length);
    }
    fullText += text + '\n\n';
  }

  setProgress(85, 'Processing text…');
  setTimeout(() => { setProgress(100, 'Done!'); setTimeout(() => hideProgress(), 700); }, 400);
  postProcessOCR(fullText);
}

// ── AI EXTRACTION ON EXISTING TEXT ────────────────────────────────────────
async function runAIExtraction() {
  const text = document.getElementById('ocrResult').value;
  if (!text.trim()) { showToast('⚠️ Paste or scan text first!'); return; }

  const fieldsInput = document.getElementById('aiFieldsInput');
  const fields = fieldsInput?.value.split(',').map(f=>f.trim()).filter(Boolean) || null;

  showOCRStatus('🤖 Running Claude AI extraction…', '#7c3aed');
  setProgress(20, 'Claude AI analyzing…');
  const aiData = await claudeAIExtract(text, fields);
  setProgress(100, 'Done!'); setTimeout(()=>hideProgress(), 600);

  if (aiData) {
    renderAIExtractionResults(aiData, text);
  } else {
    const fallback = smartExtractAll(text);
    const validated = validateAndCorrectData(fallback);
    renderExtractionPreview(validated, calculateDataQuality(validated));
    showOCRStatus('⚠️ Using smart regex fallback', '#f59e0b');
  }
}

// ── SCAN + AI EXTRACT ─────────────────────────────────────────────────────
async function runAIExtractionWithOCR() {
  const files = document.getElementById('ocrImage').files;
  if (!files.length) {
    document.getElementById('ocrImage').click();
    showToast('Select an image, then click Scan + AI Extract');
    return;
  }

  showFilePreview(files);
  let fullText = '';
  const engine = window._ocrEngine === 'local' ? 'local' : window._ocrEngine;

  for (let i = 0; i < files.length; i++) {
    const f = files[i];
    if (f.type === 'application/pdf') { continue; }
    
    let text = '';
    if (engine === 'local') {
      text = await runLocalTesseract(f, Math.round((i/files.length)*50)+5, 25);
    } else {
      text = await runOCRSpaceOnFile(f, engine, i, files.length);
    }
    fullText += text + '\n\n';
  }

  setProgress(72, 'Cleaning OCR text…');
  const cleaned = aiCleanup(fullText);
  document.getElementById('ocrResult').value = cleaned;
  updateCharCount();
  detectArabic(cleaned);

  setProgress(78, 'Claude AI extracting fields…');
  const fieldsInput = document.getElementById('aiFieldsInput');
  const fields = fieldsInput?.value.split(',').map(f=>f.trim()).filter(Boolean) || null;
  
  const aiData = await claudeAIExtract(cleaned, fields);
  setProgress(100, 'Done!'); setTimeout(()=>hideProgress(), 700);

  if (aiData) {
    renderAIExtractionResults(aiData, cleaned);
  } else {
    postProcessOCR(fullText);
  }
}

// ── OVERRIDE postProcessOCR with smart pipeline ───────────────────────────
(function() {
  window.postProcessOCR = async function(rawText) {
    let text = (typeof aiCleanup === 'function') ? aiCleanup(rawText) : rawText;

    // MRZ detection
    if (text.includes('<<')) {
      const mrzParsed = (typeof parseMRZ === 'function') ? parseMRZ(text) : text;
      if (mrzParsed !== text) text = mrzParsed;
    }

    document.getElementById('ocrResult').value = text;
    updateCharCount();
    if (typeof detectArabic === 'function') detectArabic(text);
    
    const sb = document.getElementById('ocrSearchBar');
    if (sb) sb.style.display = 'block';
    
    // Run smart extraction
    const extracted  = (typeof smartExtractAll === 'function') ? smartExtractAll(text) : {};
    const validated  = (typeof validateAndCorrectData === 'function') ? validateAndCorrectData(extracted) : extracted;
    const quality    = (typeof calculateDataQuality === 'function') ? calculateDataQuality(validated) : { qualityScore: 0, totalFields: 0 };
    
    // Raw line fallback
    const totalF = Object.values(validated).reduce((s,a)=>s+(a?a.length:0), 0);
    if (totalF < 3 && text.trim().length > 20) {
      const rawLines = text.split('\n').map(l=>l.trim()).filter(l=>l.length>2);
      if (!validated.rawLines) validated.rawLines = [];
      rawLines.forEach(l => validated.rawLines.push(l));
      if (typeof FIELD_CONFIG !== 'undefined' && !FIELD_CONFIG.find(f=>f.key==='rawLines')) {
        FIELD_CONFIG.push({ key:'rawLines', label:'📄 All Extracted Lines', color:'#475569' });
      }
    }

    window.lastExtractedData = validated;
    if (!window.accumulatedScans) window.accumulatedScans = [];
    window.accumulatedScans.push(validated);

    const lines  = text.split('\n').filter(l=>l.trim()).length;
    const fCount = Object.values(validated).reduce((s,a)=>s+(a?a.length:0), 0);
    const eng    = window._ocrEngine === 'local' ? 'Local' : `OCR.space E${window._ocrEngine}`;
    showOCRStatus(`✅ ${lines} lines · ${fCount} fields · ${quality.qualityScore}% quality [${eng}]`, '#27ae60');
    showToast(`✅ Done! ${fCount} fields — try 🤖 AI Extract for smarter results`);

    if (typeof renderExtractionPreview === 'function') renderExtractionPreview(validated, quality);
  };
})();

// ── COPY ALL EXTRACTED ────────────────────────────────────────────────────
function copyAllExtracted() {
  const data = window.lastExtractedData;
  if (!data) { showToast('No data to copy!'); return; }
  let out = '';
  const seen = new Set();
  Object.entries(data).forEach(([key, arr]) => {
    if (!arr?.length) return;
    const vals = Array.isArray(arr) ? arr : [arr];
    const label = key.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    vals.forEach(v => {
      if (v && !seen.has(String(v))) { out += `${label}: ${v}\n`; seen.add(String(v)); }
    });
  });
  if (out) navigator.clipboard.writeText(out.trim()).then(()=>showToast('✅ All fields copied!'));
  else showToast('Nothing to copy!');
}

// ── DOMContentLoaded INIT ─────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
  // Show auto engine badge (starts at Engine 3 attempt)
  window._ocrEngine = 3;
  if (typeof updateEngineStatusBadge === 'function') updateEngineStatusBadge(3, 'trying');
  
  // Extend FIELD_CONFIG
  if (typeof FIELD_CONFIG !== 'undefined') {
    const extra = [
      { key:'idNumbers',   label:'🪪 ID / Iqama',      color:'#7c3aed' },
      { key:'visaData',    label:'🛂 Visa Info',       color:'#8b5cf6' },
      { key:'genderTitle', label:'👤 Gender/Title',    color:'#a78bfa' },
      { key:'pax',         label:'👥 Pax/Guests',      color:'#6366f1' },
      { key:'cities',      label:'🌍 Cities/Dest.',    color:'#3b82f6' },
      { key:'flights',     label:'✈️ Flight Numbers',   color:'#0ea5e9' },
    ];
    extra.forEach(f => { if (!FIELD_CONFIG.find(x=>x.key===f.key)) FIELD_CONFIG.push(f); });
  }
  
  // AI panel hidden by default
  const ap = document.getElementById('aiExtractPanel');
  if (ap) ap.style.display = 'none';
});

// ===== ADD ROOM TYPE LOGIC =====
let _selectedPresetName = null;
let _selectedPresetPax  = null;

function openAddRoomTypeModal() {
    // Reset state
    document.getElementById('customRoomName').value = '';
    document.getElementById('customRoomPax').value  = '';
    document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('selected'));
    _selectedPresetName = null;
    _selectedPresetPax  = null;
    document.getElementById('addRoomTypeModal').classList.add('open');
}

function closeAddRoomTypeModal() {
    document.getElementById('addRoomTypeModal').classList.remove('open');
}

function closeAddRoomTypeModalOutside(e) {
    if (e.target === document.getElementById('addRoomTypeModal')) closeAddRoomTypeModal();
}

function selectPreset(name, pax, el) {
    document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    _selectedPresetName = name;
    _selectedPresetPax  = pax;
    // Fill custom fields too for clarity
    document.getElementById('customRoomName').value = name;
    document.getElementById('customRoomPax').value  = pax;
}

function clearPresetSelection() {
    document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('selected'));
    _selectedPresetName = null;
    _selectedPresetPax  = null;
}

function confirmAddRoomType() {
    const nameRaw = document.getElementById('customRoomName').value.trim().toUpperCase();
    const paxVal  = parseInt(document.getElementById('customRoomPax').value);

    if (!nameRaw) { _flashInput('customRoomName'); return; }
    if (!paxVal || paxVal < 1 || paxVal > 99) { _flashInput('customRoomPax'); return; }

    // Check for duplicates
    const existing = Array.from(document.querySelectorAll('#roomLayoutBoxes .room-type-box'))
                         .map(b => b.dataset.type);
    if (existing.includes(nameRaw)) {
        _flashInput('customRoomName', '#fef3c7');
        document.getElementById('customRoomName').placeholder = 'Already exists!';
        setTimeout(() => document.getElementById('customRoomName').placeholder = 'Name (e.g. VIP)', 1500);
        return;
    }

    _addRoomTypeBox(nameRaw, paxVal);
    closeAddRoomTypeModal();
}

function _flashInput(id, color) {
    const el = document.getElementById(id);
    const orig = el.style.borderColor;
    el.style.borderColor = color || '#ef4444';
    el.focus();
    setTimeout(() => el.style.borderColor = orig, 800);
}

function _addRoomTypeBox(typeName, paxCount) {
    const container = document.getElementById('roomLayoutBoxes');
    const existingCount = container.querySelectorAll('.room-type-box').length;

    const box = document.createElement('div');
    box.className = 'room-type-box custom-type';
    box.setAttribute('draggable', 'true');
    box.dataset.type   = typeName;
    box.dataset.pax    = paxCount;
    box.dataset.custom = 'true';

    const uid = 'chk_' + typeName.replace(/[^A-Z0-9]/g, '_') + '_' + Date.now();

    box.innerHTML = `
        <span class="priority-badge">${existingCount + 1}</span>
        <button class="remove-room-btn" onclick="removeCustomRoomType(this)" title="Remove">✕</button>
        <input type="checkbox" class="room-type-checkbox" id="${uid}" checked onchange="calculateRoomLayout()">
        <div>
            <div class="room-type-label">${typeName}</div>
            <div class="room-type-pax">${paxCount} pax</div>
        </div>
    `;

    // Mark as checked visually
    box.classList.add('checked');

    // Attach checkbox toggle style
    const chk = box.querySelector('.room-type-checkbox');
    chk.addEventListener('change', function() {
        box.classList.toggle('checked', this.checked);
    });

    container.appendChild(box);

    // Re-attach all drag events (includes new box)
    _reAttachAllDragEvents();
    _updateAllPriorityBadges();
    calculateRoomLayout();
}

function removeCustomRoomType(btn) {
    const box = btn.closest('.room-type-box');
    if (!box) return;
    box.remove();
    _updateAllPriorityBadges();
    calculateRoomLayout();
}

function _updateAllPriorityBadges() {
    const boxes = document.querySelectorAll('#roomLayoutBoxes .room-type-box');
    boxes.forEach((box, i) => {
        const badge = box.querySelector('.priority-badge');
        if (badge) badge.textContent = i + 1;
    });
}

function _reAttachAllDragEvents() {
    let dragSrc = null;
    const boxes = document.querySelectorAll('#roomLayoutBoxes .room-type-box');
    boxes.forEach(box => {
        // Clone to remove old listeners, then re-add
        const newBox = box.cloneNode(true);
        box.parentNode.replaceChild(newBox, box);
    });
    // Re-add fresh drag listeners to all boxes
    document.querySelectorAll('#roomLayoutBoxes .room-type-box').forEach(box => {
        box.addEventListener('dragstart', function(e) {
            dragSrc = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        box.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            document.querySelectorAll('.room-type-box').forEach(b => b.classList.remove('drag-over'));
            _updateAllPriorityBadges();
            calculateRoomLayout();
        });
        box.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (this !== dragSrc) {
                document.querySelectorAll('.room-type-box').forEach(b => b.classList.remove('drag-over'));
                this.classList.add('drag-over');
            }
        });
        box.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
        box.addEventListener('drop', function(e) {
            e.preventDefault();
            if (this !== dragSrc) {
                const container = document.getElementById('roomLayoutBoxes');
                const allBoxes  = Array.from(container.querySelectorAll('.room-type-box'));
                const srcIdx    = allBoxes.indexOf(dragSrc);
                const tgtIdx    = allBoxes.indexOf(this);
                if (srcIdx < tgtIdx) container.insertBefore(dragSrc, this.nextSibling);
                else container.insertBefore(dragSrc, this);
                this.classList.remove('drag-over');
            }
        });
        // Checkbox style
        const chk = box.querySelector('.room-type-checkbox');
        if (chk) {
            chk.addEventListener('change', function() {
                box.classList.toggle('checked', this.checked);
                calculateRoomLayout();
            });
        }
        // Remove button
        const rmBtn = box.querySelector('.remove-room-btn');
        if (rmBtn) {
            rmBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                box.remove();
                _updateAllPriorityBadges();
                calculateRoomLayout();
            });
        }
    });
}
// ===== END ADD ROOM TYPE LOGIC =====

console.log('✅ OCR.space + Claude AI Engine v4.0 loaded');
</script>
<!-- ===== END OCR ENGINE v4.0 ===== -->


<script>
// ===== ML Document Classifier =====
function mlClassify(text){
  const s={passport:0,visa:0,id:0,rooming:0};
  if(/P<[A-Z]{3}/.test(text)) s.passport+=6;
  if(/VISA|ENTRY|VALID/i.test(text)) s.visa+=5;
  if(/IDENTITY|ID CARD|NATIONAL/i.test(text)) s.id+=5;
  if(text.split('\n').length>12) s.rooming+=3;
  return Object.keys(s).reduce((a,b)=>s[a]>s[b]?a:b);
}
// ===== Passport / Visa / ID Extractors =====
function extractPassportFields(text){
  return {
    name:(text.match(/P<.{3}([A-Z<]+)/)||['',''])[1].replace(/</g,' ').trim(),
    nationality:(text.match(/P<([A-Z]{3})/)||['',''])[1],
    dob:(text.match(/\d{2}[A-Z]{3}\d{2}/)||[''])[0]
  };
}
function extractVisaFields(text){
  return {
    visaNumber:text.match(/VISA\s*NO\.?\s*(\w+)/i)?.[1]||'',
    validUntil:text.match(/VALID\s*UNTIL\s*(\d{2}\/\d{2}\/\d{4})/i)?.[1]||''
  };
}
</script>
<script>
// Email Forms Data
const emailForms = [
    {
        title: "STAY REQUEST طلب إستاي",
        subject: "Stay Report Request (DATE + MONTH EX: 01 JANUARY)",
        body: `Dear Reservations Team,
Kindly send the stay report for 01 January.
Thanks And Best Regards,`
    },
    {
        title: "ARRIVAL REQUEST طلب أرايفل",
        subject: "Arrival Report Request",
        body: `Dear Reservations Team,
Kindly send the arrival report included block and overblock if there is.
Thanks And Best Regards,`
    },
    {
        title: "NEW BOOKING حجز جديد",
        subject: "New Booking : (RESERVATION NUMBER)",
        body: `Dear Reservations Team,
Kindly confirm the attached booking under our (allotment block/Deposit/AR/Cash payment).
Thanks And Best Regards,`
    },
    {
        title: "CANCEL REQUEST إلغاء حجز",
        subject: "Cancellation Request : (RESERVATION NUMBER)",
        body: `Dear Reservations Team,
Kindly proceed with the cancellation of HCN (******).
Thanks And Best Regards,`
    },
    {
        title: "AMENDMENT REQUEST طلب تعديل حجز",
        subject: "Amendment Request : (RESERVATION NUMBER)",
        body: `Dear Reservations Team,
Kindly amend HCN (******) as per the below details:
Guest Name: (******) 
Room Type: (******) 
Meal Type: (******) 
View Type: (******) 
Thanks And Best Regards,`
    },
    {
        title: "CHECK AVAILABILITY تشييك إمكانية",
        subject: "Check Availability: (Guest Name)",
        body: `Dear Reservations Team,
Please check the availability for the booking details below:
Guest Name: (******) 
Arrival: **/**/2026 
Departure: **/**/2026 
Room Type: 01 DBL C.V  
Meal Plan: B.B
Thanks And Best Regards,`
    },
    {
        title: "New Booking (Option Date) حجز او تشييك أوبشن ديت",
        subject: "New Booking (Option Date): (Guest Name)",
        body: `Dear Reservations Team,
Please check the availability for the booking details below:
Guest Name: (******) 
Arrival: **/**/2026 
Departure: **/**/2026 
Room Type: 01 DBL C.V  
Meal Plan: B.B
Thanks And Best Regards,`
    },
    {
        title: "Add Guest Name إضافة أسماء نزلاء",
        subject: "Add Guest Name : (RESERVATION NUMBER)",
        body: `Dear Reservations Team,
Kindly Add Guest Name To HCN: (******) According to (The Attachment / As below)
Thanks And Best Regards,`
    },
    {
        title: "STOP SALE REQUEST طلب تقرير استوب سيل",
        subject: "STOP SALE REQUEST",
        body: `Dear Reservations Team,
Kindly send the stop sale report.
Thanks And Best Regards,`
    },
    {
        title: "Nusuk Approval طلب موافقة نسك",
        subject: "Nusuk Approval : (RESERVATION NUMBER)",
        body: `Dear Reservations Team,
Kindly approve the attached Nusuk request No. (********) for HCN (********).
Thanks And Best Regards,`
    },
    {
        title: "Group Source Request طلب ربط سورس لحجز",
        subject: "Group Source Request : (RESERVATION NUMBER)",
        body: `Dear Reservations Team,
Kindly create a group source (******) for the attached rooming list.
Thanks And Best Regards,`
    }
];

// Initialize Email Forms
function initEmailForms() {
    const container = document.getElementById('emailFormsContainer');
    if (!container) return;
    
    emailForms.forEach((form, index) => {
        const formDiv = document.createElement('div');
        formDiv.className = 'email-form';
        
        // Create header
        const header = document.createElement('div');
        header.className = 'form-header';
        header.onclick = function() { toggleEmailForm(index); };
        header.innerHTML = '<span>' + form.title + '</span><span id="formArrow' + index + '">▼</span>';
        
        // Create content
        const content = document.createElement('div');
        content.className = 'form-content';
        content.id = 'formContent' + index;
        
        // Create body
        const body = document.createElement('div');
        body.className = 'form-body';
        
        // Subject field
        const subjectField = document.createElement('div');
        subjectField.className = 'form-field';
        subjectField.innerHTML = '<label>SUBJECT:</label><div class="value">' + form.subject + '</div>';
        
        // Body field
        const bodyField = document.createElement('div');
        bodyField.className = 'form-field';
        const bodyLabel = document.createElement('label');
        bodyLabel.textContent = 'EMAIL BODY:';
        const bodyValue = document.createElement('div');
        bodyValue.className = 'value';
        bodyValue.textContent = form.body;
        bodyField.appendChild(bodyLabel);
        bodyField.appendChild(bodyValue);
        
        // Copy button
        const copyBtn = document.createElement('button');
        copyBtn.className = 'btn btn-success';
        copyBtn.onclick = function() { copyEmailForm(index); };
        copyBtn.innerHTML = '<span>📋</span><span>Copy Email</span>';
        
        // Assemble
        body.appendChild(subjectField);
        body.appendChild(bodyField);
        body.appendChild(copyBtn);
        content.appendChild(body);
        formDiv.appendChild(header);
        formDiv.appendChild(content);
        container.appendChild(formDiv);
    });
}

function toggleEmailForm(index) {
    const content = document.getElementById('formContent' + index);
    const arrow = document.getElementById('formArrow' + index);
    
    if (content && arrow) {
        if (content.classList.contains('open')) {
            content.classList.remove('open');
            arrow.textContent = '▼';
            arrow.style.transform = 'rotate(0deg)';
        } else {
            // Close all other forms
            document.querySelectorAll('.form-content').forEach(c => c.classList.remove('open'));
            document.querySelectorAll('[id^="formArrow"]').forEach(a => {
                a.textContent = '▼';
                a.style.transform = 'rotate(0deg)';
            });
            
            content.classList.add('open');
            arrow.textContent = '▲';
            arrow.style.transform = 'rotate(180deg)';
        }
    }
}

function copyEmailForm(index) {
    const form = emailForms[index];
    const text = 'Subject: ' + form.subject + '\n\n' + form.body;
    
    navigator.clipboard.writeText(text).then(() => {
        if (typeof showToast === 'function') {
            showToast('Email copied to clipboard!');
        } else {
            alert('Email copied to clipboard!');
        }    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}
</script>


<!-- ===== Add Room Type Modal ===== -->
<div id="addRoomTypeModal" onclick="closeAddRoomTypeModalOutside(event)">
    <div class="add-room-modal-box">
        <div class="add-room-modal-title">🛏️ Add Room Type - إضافة نوع غرفة</div>
        
        <div style="font-size:0.78rem; color:#64748b; margin-bottom:10px; font-weight:600;">QUICK PRESETS - اختيار سريع</div>
        <div class="add-room-presets" id="roomTypePresets">
            <div class="preset-chip" onclick="selectPreset('SGL',1,this)">SGL — 1 pax</div>
            <div class="preset-chip" onclick="selectPreset('6-PAX',6,this)">6-PAX — 6 pax</div>
            <div class="preset-chip" onclick="selectPreset('7-PAX',7,this)">7-PAX — 7 pax</div>
            <div class="preset-chip" onclick="selectPreset('8-PAX',8,this)">8-PAX — 8 pax</div>
            <div class="preset-chip" onclick="selectPreset('FAMILY',6,this)">FAMILY — 6 pax</div>
            <div class="preset-chip" onclick="selectPreset('SUITE',2,this)">SUITE — 2 pax</div>
        </div>

        <div style="font-size:0.78rem; color:#64748b; margin-bottom:10px; font-weight:600;">OR CUSTOM - أو مخصص</div>
        <div class="add-room-custom-row">
            <input type="text" id="customRoomName" placeholder="Name (e.g. VIP)" maxlength="8" oninput="clearPresetSelection()">
            <input type="number" id="customRoomPax" placeholder="Pax" min="1" max="99" style="width:70px; flex:none;" oninput="clearPresetSelection()">
        </div>

        <div class="add-room-modal-actions">
            <button class="modal-btn-add" onclick="confirmAddRoomType()">✅ Add Room Type</button>
            <button class="modal-btn-cancel" onclick="closeAddRoomTypeModal()">Cancel</button>
        </div>
    </div>
</div>
<!-- ===== END Add Room Type Modal ===== -->

</body>
</html>
